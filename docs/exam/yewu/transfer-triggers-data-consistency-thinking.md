---
title: 转账引发的一致性思考
icon: fubuhi
category: 分布式
date: 2021-11-21
tag:
  - cap
  - 分布式事务
---

## 转账引发的一致性思考

## 转账引发的一致性思考

A账户给B账户转账100元(A、B处于同一个库中)，

如果A的账户发生扣款，B的账户却没有到账，这就出现了数据的不一致！

为了保证数据的一致性，数据库的事务机制会让A账户扣款和B在账户到账的两个操作要么同时成功，如果有一个操作失败，则多个操作同时回滚，这就是事务的原子性，为了保证事务操作的原子性，就必须实现基于日志的REDO/UNDO机制。

但是，仅有原子性还不够，因为我们的系统是运行在多线程环境下，如果多个事务并行，即使保证了每一个事务的原子性，仍然会出现数据不一致的情况。

例如


A账户原来有200元的余额，A账户给B账户转账100元，先读取A账户的余额，然后在这个值上减去100元，但是在这两个操作之间，A账户又给C账户转账100元，那么最后的结果应该是A减去了200元。但事实上，A账户给B账户最终完成转账后，A账户只减掉了100元，因为A账户向C账户转账减掉的100元被覆盖了！

所以为了保证并发情况下的一致性，又引入的隔离性，即多个事务并发执行后的状态，和它们串行执行后的状态是等价的！

隔离性又有多种隔离级别，为了实现隔离性(最终都是为了保证一致性)数据库又引入了悲观锁、乐观锁等等……本文的主题是分布式事务，所以本地事务就只是简单回顾一下，需要记住的一点是，事务是为了保证数据的一致性

## 事务隔离性理解

H1：当 A 转给 B 100 之后，

H2:A 又转给 C 100，

但是在 H2 未提交之前，A 查询到的余额还是 H1，所以 A 此时余额只减少了 100 元，与实际应该减少 200 元，并发情况下数据不一致。

## 分布式事务

与本地事务不同的是，分布式事务需要保证的是分布式环境下，不同数据库表中的数据的一致性问题。分布式事务的解决方案有多种，如 XA 协议、TCC 三阶段提交、基于消息队列等等，本文只会涉及基于消息队列的解决方案。

本地事务讲到了一致性，分布式事务不可避免的面临着一致性的问题！回到最开始跨行转账的例子，如果 A 银行用户向 B 银行用户转账，正常流程应该是

> 1. A 银行对转出账户执行检查校验，进行金额扣减。
> 2. A 银行同步调用 B 银行转账接口。
> 3. B 银行对转入账户进行检查校验，进行金额增加。
> 4. B 银行返回处理结果给 A 银行。

在正常情况对一致性要求不高的场景，这样的设计是可以满足需求的。但是像银行这样的系统，如果这样实现大概早就破产了吧。我们先看看这样的设计最主要的问题：

1. 同步调用远程接口，如果接口比较耗时，会导致主线程阻塞时间较长。
2. 流量不能很好控制，A 银行系统的流量高峰可能压垮 B 银行系统(当然 B 银行肯定会有自己的限流机制)。
3. 如果“第 1 步”刚执行完，系统由于某种原因宕机了，那会导致 A 银行账户扣款了，但是 B 银行没有收到接口的调用，这就出现了两个系统数据的不一致。
4. 如果在执行“第 3 步”后，B 银行由于某种原因宕机了而无法正确回应请求(实际上转账操作在 B 银行系统已经执行且入库)，这时候 A 银行等待接口响应会异常，误以为转账失败而回滚“第 1 步”操作，这也会出现了两个系统数据的不一致。
   对于问题的 1、2 都很好解决，如果对消息队列熟悉的朋友应该很快能想到可以引入消息中间件进行异步和削峰处理，

于是又重新设计了一个方案，流程如下：

1. A 银行对账户进行检查校验，进行金额扣减。
2. 将对 B 银行的请求异步写入队列，主线程返回。
3. 启动后台程序从队列获取待处理数据。
4. 后台程序对 B 银行接口进行远程调用。
5. B 银行对转入账户进行检查校验，进行金额增加。
6. B 银行处理完成回调 A 银行接口通知处理结果。

所以，我们这里最核心的就是

- A 银行通过本地事务保证日志记录+后台线程轮询保证消息不丢失。
- B 银行通过本地事务保证日志记录从而保证消息不重复消费！B 银行在回调 A 银行的接口时会通知处理结果，如果转账失败，A 银行会根据处理结果进行回滚。

[参考：转账引发数据一致性思考](https://blog.csdn.net/ZrZrZr666666/article/details/113388852?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164549796916781683945697%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=164549796916781683945697&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-113388852.pc_search_result_positive&utm_term=%E8%BD%AC%E8%B4%A6+%E4%BF%9D%E8%AF%81%E4%B8%80%E8%87%B4%E6%80%A7&spm=1018.2226.3001.4187)
