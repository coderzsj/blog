<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://www.zhangsj.xyz/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html"><meta property="og:site_name" content="ShijingSpace"><meta property="og:title" content="synchronized"><meta property="og:type" content="article"><meta property="og:image" content="http://www.zhangsj.xyz/blog/"><meta property="og:updated_time" content="2022-05-24T07:41:09.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="synchronized"><meta property="article:tag" content="synchronized"><meta property="article:published_time" content="2022-01-28T00:00:00.000Z"><meta property="article:modified_time" content="2022-05-24T07:41:09.000Z"><link rel="stylesheet" href="//at.alicdn.com/t/font_3166858_nfzh5q0te6g.css"><title>synchronized | ShijingSpace</title><meta name="description" content="Javaå­¦ä¹ &&é¢è¯•æŒ‡å—">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/blog/assets/style.49bb0069.css">
    <link rel="modulepreload" href="/blog/assets/app.9da19d67.js"><link rel="modulepreload" href="/blog/assets/synchronized-principle-analysis-and-optimization.html.e0970258.js"><link rel="modulepreload" href="/blog/assets/synchronized-principle-analysis-and-optimization.html.f23b3428.js"><link rel="modulepreload" href="/blog/assets/plugin-vue_export-helper.21dcd24c.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/blog/" class="home-link"><img class="logo" src="/blog/logo.svg" alt="ShijingSpace"><!----><span class="site-name hide-in-pad">ShijingSpace</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" arialabel="ä¸»é¡µ"><i class="icon iconfont icon-bloghome"></i>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="java"><span class="title"><i class="icon iconfont icon-blogguide"></i>java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/blog/java/basic" class="nav-link" arialabel="åŸºç¡€"><!---->åŸºç¡€<!----></a></li><li class="dropdown-item"><a href="/blog/java/concurrent" class="nav-link active" arialabel="å¹¶å‘"><!---->å¹¶å‘<!----></a></li><li class="dropdown-item"><a href="/blog/java/datasource" class="nav-link" arialabel="æ•°æ®åº“"><!---->æ•°æ®åº“<!----></a></li><li class="dropdown-item"><a href="/blog/java/design-patterns" class="nav-link" arialabel="è®¾è®¡æ¨¡å¼"><!---->è®¾è®¡æ¨¡å¼<!----></a></li><li class="dropdown-item"><a href="/blog/java/interview.html" class="nav-link" arialabel="é¢ç»"><!---->é¢ç»<!----></a></li><li class="dropdown-item"><a href="/blog/java/jvm" class="nav-link" arialabel="JVM"><!---->JVM<!----></a></li><li class="dropdown-item"><a href="/blog/java/message-queue" class="nav-link" arialabel="æ¶ˆæ¯é˜Ÿåˆ—"><!---->æ¶ˆæ¯é˜Ÿåˆ—<!----></a></li><li class="dropdown-item"><a href="/blog/java/redis" class="nav-link" arialabel="ç¼“å­˜"><!---->ç¼“å­˜<!----></a></li><li class="dropdown-item"><a href="/blog/java/soa" class="nav-link" arialabel="åˆ†å¸ƒå¼"><!---->åˆ†å¸ƒå¼<!----></a></li><li class="dropdown-item"><a href="/blog/java/spring" class="nav-link" arialabel="spring"><!---->spring<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="å…¶ä»–"><span class="title"><i class="icon iconfont icon-blogguide"></i>å…¶ä»–</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/blog/note" class="nav-link" arialabel="éšç¬”"><!---->éšç¬”<!----></a></li><li class="dropdown-item"><a href="/blog/vue" class="nav-link" arialabel="å‰ç«¯"><!---->å‰ç«¯<!----></a></li><li class="dropdown-item"><a href="/blog/tool" class="nav-link" arialabel="å·¥å…·"><!---->å·¥å…·<!----></a></li><li class="dropdown-item"><a href="/blog/algo" class="nav-link" arialabel="ç®—æ³•"><!---->ç®—æ³•<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="å·¥å…·"><span class="title"><i class="icon iconfont icon-blogtool"></i>å·¥å…·</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/blog/tool/idea-plugin.html" class="nav-link" arialabel="idea"><!---->idea<!----></a></li><li class="dropdown-item"><a href="/blog/tool/vscode-plugins-and-configuration.html" class="nav-link" arialabel="vscode"><!---->vscode<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://blog.csdn.net/qq_43183527" rel="noopener noreferrer" target="_blank" arialabel="åšå®¢" class="nav-link"><i class="icon iconfont icon-blogblog"></i>åšå®¢<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/about" class="nav-link" arialabel="å…³äºä½œè€…"><i class="icon iconfont icon-blogguide"></i>å…³äºä½œè€…<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/coderzsj/blog" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" arialabelledby="auto" style="display:block;"><title id="auto" lang="en">auto icon</title><g fill="currentColor"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" arialabelledby="dark" style="display:none;"><title id="dark" lang="en">dark icon</title><g fill="currentColor"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" arialabelledby="light" style="display:none;"><title id="light" lang="en">light icon</title><g fill="currentColor"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></g></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/blog/java/" class="nav-link sidebar-link sidebar-page" arialabel="java"><i class="icon iconfont icon-blogmulu"></i>java<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogbasic"></i><span class="title">åŸºç¡€</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/basic/java-exception.html" class="nav-link sidebar-link sidebar-page" arialabel="javaå¼‚å¸¸"><i class="icon iconfont icon-blogexception"></i>javaå¼‚å¸¸<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/basic/hashmap.html" class="nav-link sidebar-link sidebar-page" arialabel="hashMapçŸ¥è¯†ç‚¹æ±‡æ€»"><i class="icon iconfont icon-bloghashmap"></i>hashMapçŸ¥è¯†ç‚¹æ±‡æ€»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/basic/still-using-SimpleDateFormat.html" class="nav-link sidebar-link sidebar-page" arialabel="ä»åœ¨ä½¿ç”¨SimpleDateFormatï¼Ÿ"><!---->ä»åœ¨ä½¿ç”¨SimpleDateFormatï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><!----><span class="title">è®¾è®¡æ¨¡å¼</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/design-patterns/let-me-tell-you-what-design-patterns-are-used-in-spring.html" class="nav-link sidebar-link sidebar-page" arialabel="springä¸­æ¶‰åŠåˆ°ä¹ç§è®¾è®¡æ¨¡å¼"><!---->springä¸­æ¶‰åŠåˆ°ä¹ç§è®¾è®¡æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/design-patterns/singleton-design.html" class="nav-link sidebar-link sidebar-page" arialabel="Javaè®¾è®¡æ¨¡å¼--å•ä¾‹æ¨¡å¼ï¼"><!---->Javaè®¾è®¡æ¨¡å¼--å•ä¾‹æ¨¡å¼ï¼<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/design-patterns/six-principles-of-design-patterns.html" class="nav-link sidebar-link sidebar-page" arialabel="è®¾è®¡æ¨¡å¼éµå¾ªçš„ä¸€äº›åŸåˆ™"><!---->è®¾è®¡æ¨¡å¼éµå¾ªçš„ä¸€äº›åŸåˆ™<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogredis"></i><span class="title">ç¼“å­˜</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/redis/redis.html" class="nav-link sidebar-link sidebar-page" arialabel="Redisè°ƒä¼˜"><!---->Redisè°ƒä¼˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/redis/interview.html" class="nav-link sidebar-link sidebar-page" arialabel="RedisçŸ¥è¯†ç‚¹æ±‡æ€»"><i class="icon iconfont icon-bloginterview"></i>RedisçŸ¥è¯†ç‚¹æ±‡æ€»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading active"><i class="icon iconfont icon-blogbingfazheng"></i><span class="title">å¹¶å‘ç¼–ç¨‹</span><!----></p><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="synchronized"><!---->synchronized<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯è§æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å¯è§æ€§"><!---->å¯è§æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åŸå­æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="åŸå­æ€§"><!---->åŸå­æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æœ‰åºæ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="æœ‰åºæ€§"><!---->æœ‰åºæ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#äºŒã€java-å†…å­˜æ¨¡å‹-jmm" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="äºŒã€Java å†…å­˜æ¨¡å‹(JMM)"><!---->äºŒã€Java å†…å­˜æ¨¡å‹(JMM)<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»"><!---->CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’"><!---->ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¸‰ã€synchronized ä¿è¯ä¸‰å¤§ç‰¹æ€§"><!---->ä¸‰ã€synchronized ä¿è¯ä¸‰å¤§ç‰¹æ€§<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronizedä¸åŸå­æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="synchronizedä¸åŸå­æ€§"><!---->synchronizedä¸åŸå­æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¿è¯åŸå­æ€§çš„åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¿è¯åŸå­æ€§çš„åŸç†"><!---->ä¿è¯åŸå­æ€§çš„åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-ä¸å¯è§æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="synchronized ä¸å¯è§æ€§"><!---->synchronized ä¸å¯è§æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-ä¸æœ‰åºæ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="synchronized ä¸æœ‰åºæ€§"><!---->synchronized ä¸æœ‰åºæ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯é‡å…¥ç‰¹æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å¯é‡å…¥ç‰¹æ€§"><!---->å¯é‡å…¥ç‰¹æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸å¯ä¸­æ–­ç‰¹æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¸å¯ä¸­æ–­ç‰¹æ€§"><!---->ä¸å¯ä¸­æ–­ç‰¹æ€§<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitorenter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitorenter"><!---->monitorenter<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitorexit" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitorexit"><!---->monitorexit<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åŒæ­¥æ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="åŒæ­¥æ–¹æ³•"><!---->åŒæ­¥æ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«"><!---->é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æ·±å…¥jvmæºç åˆ†æsynchronizedçš„åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="æ·±å…¥JVMæºç åˆ†æsynchronizedçš„åŸç†"><!---->æ·±å…¥JVMæºç åˆ†æsynchronizedçš„åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç›‘è§†å™¨é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitor ç›‘è§†å™¨é”"><!---->monitor ç›‘è§†å™¨é”<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç«äº‰" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitor ç«äº‰"><!---->monitor ç«äº‰<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç­‰å¾…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitor ç­‰å¾…"><!---->monitor ç­‰å¾…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-é‡Šæ”¾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitor é‡Šæ”¾"><!---->monitor é‡Šæ”¾<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitoræ˜¯é‡é‡çº§é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="monitoræ˜¯é‡é‡çº§é”"><!---->monitoræ˜¯é‡é‡çº§é”<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å…­ã€jdk6-synchronizedä¼˜åŒ–" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å…­ã€JDK6 synchronizedä¼˜åŒ–"><!---->å…­ã€JDK6 synchronizedä¼˜åŒ–<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#caså’Œvolatileå®ç°æ— é”å¹¶å‘" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CASå’Œvolatileå®ç°æ— é”å¹¶å‘"><!---->CASå’Œvolatileå®ç°æ— é”å¹¶å‘<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#casåŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CASåŸç†"><!---->CASåŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-é”å‡çº§è¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="synchronized é”å‡çº§è¿‡ç¨‹"><!---->synchronized é”å‡çº§è¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#javaå¯¹è±¡çš„å¸ƒå±€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Javaå¯¹è±¡çš„å¸ƒå±€"><!---->Javaå¯¹è±¡çš„å¸ƒå±€<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯¹è±¡å¤´" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å¯¹è±¡å¤´"><!---->å¯¹è±¡å¤´<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#mark-word" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Mark Word"><!---->Mark Word<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#klass-pointer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="klass pointer"><!---->klass pointer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€"><!---->æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä»€ä¹ˆæ˜¯åå‘é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä»€ä¹ˆæ˜¯åå‘é”"><!---->ä»€ä¹ˆæ˜¯åå‘é”<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="åå‘é”åŸç†"><!---->åå‘é”åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”çš„æ’¤é”€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="åå‘é”çš„æ’¤é”€"><!---->åå‘é”çš„æ’¤é”€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”å¥½å¤„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="åå‘é”å¥½å¤„"><!---->åå‘é”å¥½å¤„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä»€ä¹ˆæ˜¯è½»é‡çº§é”"><!---->ä»€ä¹ˆæ˜¯è½»é‡çº§é”<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="è½»é‡çº§é”åŸç†"><!---->è½»é‡çº§é”åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”çš„é‡Šæ”¾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="è½»é‡çº§é”çš„é‡Šæ”¾"><!---->è½»é‡çº§é”çš„é‡Šæ”¾<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”å¥½å¤„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="è½»é‡çº§é”å¥½å¤„"><!---->è½»é‡çº§é”å¥½å¤„<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è‡ªæ—‹é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="è‡ªæ—‹é”"><!---->è‡ªæ—‹é”<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é€‚åº”æ€§è‡ªæ—‹é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="é€‚åº”æ€§è‡ªæ—‹é”"><!---->é€‚åº”æ€§è‡ªæ—‹é”<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é”æ¶ˆé™¤" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="é”æ¶ˆé™¤"><!---->é”æ¶ˆé™¤<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é”ç²—åŒ–" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="é”ç²—åŒ–"><!---->é”ç²—åŒ–<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–"><!---->å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è¯»å†™åˆ†ç¦»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="è¯»å†™åˆ†ç¦»"><!---->è¯»å†™åˆ†ç¦»<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/blog/java/concurrent/thread-life-cycle.html" class="nav-link sidebar-link sidebar-page" arialabel="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"><!---->çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/concurrent/4-reference-types.html" class="nav-link sidebar-link sidebar-page" arialabel="å››ç§å¼•ç”¨ç±»å‹"><!---->å››ç§å¼•ç”¨ç±»å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/concurrent/aqs-source-code-reading-notes.html" class="nav-link sidebar-link sidebar-page" arialabel="AQS"><!---->AQS<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/concurrent/threadpool-code-analysis.html" class="nav-link sidebar-link sidebar-page" arialabel="çº¿ç¨‹æ± åˆ†æ"><!---->çº¿ç¨‹æ± åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/concurrent/threadlocal.html" class="nav-link sidebar-link sidebar-page" arialabel="ThreadLocalçš„ä»‹ç»ä¸ä½¿ç”¨"><!---->ThreadLocalçš„ä»‹ç»ä¸ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogbxl-spring-boot"></i><span class="title">spring</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/spring/spring.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring MVC è¿è¡ŒåŠå¯åŠ¨æµç¨‹"><i class="icon iconfont icon-blogbxl-spring-boot"></i>Spring MVC è¿è¡ŒåŠå¯åŠ¨æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/spring/springboot-startup-process.html" class="nav-link sidebar-link sidebar-page" arialabel="springbootè‡ªåŠ¨è£…é…åŸç†"><i class="icon iconfont icon-blogzidong-02"></i>springbootè‡ªåŠ¨è£…é…åŸç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/spring/spring-transaction.html" class="nav-link sidebar-link sidebar-page" arialabel="springäº‹åŠ¡"><i class="icon iconfont icon-blogguanli"></i>springäº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/spring/@RequestBody&amp;ResponseBody.html" class="nav-link sidebar-link sidebar-page" arialabel="è¯·æ±‚æ­£æ–‡&amp;å“åº”æ­£æ–‡"><i class="icon iconfont icon-blogannotation"></i>è¯·æ±‚æ­£æ–‡&amp;å“åº”æ­£æ–‡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogmqxiaoxiduilieMQ"></i><span class="title">æ¶ˆæ¯é˜Ÿåˆ—</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/message-queue/kafka.html" class="nav-link sidebar-link sidebar-page" arialabel="kafkaæ¦‚å¿µï¼Œä½¿ç”¨ï¼Œæ¶æ„"><!---->kafkaæ¦‚å¿µï¼Œä½¿ç”¨ï¼Œæ¶æ„<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/message-queue/rabbit.html" class="nav-link sidebar-link sidebar-page" arialabel="RabbitMQçŸ¥è¯†ç‚¹æ€»ç»“"><!---->RabbitMQçŸ¥è¯†ç‚¹æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogdatasource"></i><span class="title">æ•°æ®åº“</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/datasource/detailed-explanation-of-b-tree-and-b+-tree.html" class="nav-link sidebar-link sidebar-page" arialabel="b-treeå’Œb+treeçš„è¯¦ç»†è§£é‡Š"><i class="icon iconfont icon-blogtree"></i>b-treeå’Œb+treeçš„è¯¦ç»†è§£é‡Š<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/datasource/mysql-tuning.html" class="nav-link sidebar-link sidebar-page" arialabel="sqlä¼˜åŒ–"><i class="icon iconfont icon-blogyouhuayunhang"></i>sqlä¼˜åŒ–<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/datasource/mysql-transaction.html" class="nav-link sidebar-link sidebar-page" arialabel="MySQLäº‹åŠ¡"><i class="icon iconfont icon-blogshiwu"></i>MySQLäº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/datasource/storage-engine.html" class="nav-link sidebar-link sidebar-page" arialabel="dataource"><!---->dataource<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/datasource/explain-execution-plan.html" class="nav-link sidebar-link sidebar-page" arialabel="explainæ‰§è¡Œè®¡åˆ’"><!---->explainæ‰§è¡Œè®¡åˆ’<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogfenbushi"></i><span class="title">åˆ†å¸ƒå¼</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/soa/dubbo.html" class="nav-link sidebar-link sidebar-page" arialabel="dubboçŸ¥è¯†ç‚¹æ€»ç»“"><i class="icon iconfont icon-blogdubbo"></i>dubboçŸ¥è¯†ç‚¹æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/soa/distributed-transaction.html" class="nav-link sidebar-link sidebar-page" arialabel="åˆ†å¸ƒå¼äº‹åŠ¡"><i class="icon iconfont icon-blogfubuhi"></i>åˆ†å¸ƒå¼äº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/soa/distributed-id.html" class="nav-link sidebar-link sidebar-page" arialabel="åˆ†å¸ƒå¼ id"><i class="icon iconfont icon-blogid"></i>åˆ†å¸ƒå¼ id<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/soa/Zookeeper.html" class="nav-link sidebar-link sidebar-page" arialabel="ZooKeeper"><i class="icon iconfont icon-blogZooKeeper"></i>ZooKeeper<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/soa/spring-cloud.html" class="nav-link sidebar-link sidebar-page" arialabel="spring cloudç¬”è®°"><i class="icon iconfont icon-blogcloud"></i>spring cloudç¬”è®°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/soa/take-you-step-by-step-to-understand-the-jwt.html" class="nav-link sidebar-link sidebar-page" arialabel="å‰åç«¯åˆ†ç¦»åˆ©å™¨ä¹‹JWT"><!---->å‰åç«¯åˆ†ç¦»åˆ©å™¨ä¹‹JWT<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><i class="icon iconfont icon-blogxuniji"></i><span class="title">è™šæ‹Ÿæœº</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/blog/java/jvm/jvm-tuning.html" class="nav-link sidebar-link sidebar-page" arialabel="jvmè°ƒä¼˜"><i class="icon iconfont icon-blogyouhuayunhang"></i>jvmè°ƒä¼˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/jvm/jvm-memory-structure.html" class="nav-link sidebar-link sidebar-page" arialabel="JVMå†…å­˜ç»“æ„"><!---->JVMå†…å­˜ç»“æ„<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/jvm/jvm-garbage-collection.html" class="nav-link sidebar-link sidebar-page" arialabel="jvm-gc"><!---->jvm-gc<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/blog/java/jvm/jvm-class-loading&amp;bytecode-technology.html" class="nav-link sidebar-link sidebar-page" arialabel="JVMç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯&amp;å†…å­˜æ¨¡å‹"><!---->JVMç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯&amp;å†…å­˜æ¨¡å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->synchronized</h1><div class="article-info"><span class="author-info" arialabel="ä½œè€…ğŸ–Š" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><span class="author-item">shijing</span></span><span property="author" content="shijing"></span></span><!----><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022å¹´1æœˆ28æ—¥</span><meta property="datePublished" content="2022-01-28T00:00:00.000Z"></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category clickable" role="navigation">é”æœºåˆ¶</li><meta property="articleSection" content="é”æœºåˆ¶"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag clickable" role="navigation">synchronized</li></ul><meta property="keywords" content="synchronized"></span><span class="reading-time-info" arialabel="é˜…è¯»æ—¶é—´âŒ›" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" arialabelledby="timer"><title id="timer" lang="en">timer icon</title><g fill="currentColor"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></g></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯è§æ€§" class="router-link-active router-link-exact-active toc-link level2">å¯è§æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åŸå­æ€§" class="router-link-active router-link-exact-active toc-link level2">åŸå­æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æœ‰åºæ€§" class="router-link-active router-link-exact-active toc-link level2">æœ‰åºæ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#äºŒã€java-å†…å­˜æ¨¡å‹-jmm" class="router-link-active router-link-exact-active toc-link level2">äºŒã€Java å†…å­˜æ¨¡å‹(JMM)</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" class="router-link-active router-link-exact-active toc-link level3">CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" class="router-link-active router-link-exact-active toc-link level3">ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§" class="router-link-active router-link-exact-active toc-link level2">ä¸‰ã€synchronized ä¿è¯ä¸‰å¤§ç‰¹æ€§</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronizedä¸åŸå­æ€§" class="router-link-active router-link-exact-active toc-link level3">synchronizedä¸åŸå­æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¿è¯åŸå­æ€§çš„åŸç†" class="router-link-active router-link-exact-active toc-link level3">ä¿è¯åŸå­æ€§çš„åŸç†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-ä¸å¯è§æ€§" class="router-link-active router-link-exact-active toc-link level2">synchronized ä¸å¯è§æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-ä¸æœ‰åºæ€§" class="router-link-active router-link-exact-active toc-link level2">synchronized ä¸æœ‰åºæ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯é‡å…¥ç‰¹æ€§" class="router-link-active router-link-exact-active toc-link level2">å¯é‡å…¥ç‰¹æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä¸å¯ä¸­æ–­ç‰¹æ€§" class="router-link-active router-link-exact-active toc-link level2">ä¸å¯ä¸­æ–­ç‰¹æ€§</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitorenter" class="router-link-active router-link-exact-active toc-link level3">monitorenter</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitorexit" class="router-link-active router-link-exact-active toc-link level3">monitorexit</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åŒæ­¥æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">åŒæ­¥æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æ·±å…¥jvmæºç åˆ†æsynchronizedçš„åŸç†" class="router-link-active router-link-exact-active toc-link level2">æ·±å…¥JVMæºç åˆ†æsynchronizedçš„åŸç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç›‘è§†å™¨é”" class="router-link-active router-link-exact-active toc-link level3">monitor ç›‘è§†å™¨é”</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç«äº‰" class="router-link-active router-link-exact-active toc-link level3">monitor ç«äº‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-ç­‰å¾…" class="router-link-active router-link-exact-active toc-link level3">monitor ç­‰å¾…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitor-é‡Šæ”¾" class="router-link-active router-link-exact-active toc-link level3">monitor é‡Šæ”¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#monitoræ˜¯é‡é‡çº§é”" class="router-link-active router-link-exact-active toc-link level3">monitoræ˜¯é‡é‡çº§é”</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å…­ã€jdk6-synchronizedä¼˜åŒ–" class="router-link-active router-link-exact-active toc-link level2">å…­ã€JDK6 synchronizedä¼˜åŒ–</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#caså’Œvolatileå®ç°æ— é”å¹¶å‘" class="router-link-active router-link-exact-active toc-link level3">CASå’Œvolatileå®ç°æ— é”å¹¶å‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#casåŸç†" class="router-link-active router-link-exact-active toc-link level3">CASåŸç†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#synchronized-é”å‡çº§è¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level2">synchronized é”å‡çº§è¿‡ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#javaå¯¹è±¡çš„å¸ƒå±€" class="router-link-active router-link-exact-active toc-link level2">Javaå¯¹è±¡çš„å¸ƒå±€</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¯¹è±¡å¤´" class="router-link-active router-link-exact-active toc-link level3">å¯¹è±¡å¤´</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#mark-word" class="router-link-active router-link-exact-active toc-link level3">Mark Word</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#klass-pointer" class="router-link-active router-link-exact-active toc-link level3">klass pointer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" class="router-link-active router-link-exact-active toc-link level3">æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä»€ä¹ˆæ˜¯åå‘é”" class="router-link-active router-link-exact-active toc-link level3">ä»€ä¹ˆæ˜¯åå‘é”</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”åŸç†" class="router-link-active router-link-exact-active toc-link level3">åå‘é”åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”çš„æ’¤é”€" class="router-link-active router-link-exact-active toc-link level3">åå‘é”çš„æ’¤é”€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#åå‘é”å¥½å¤„" class="router-link-active router-link-exact-active toc-link level3">åå‘é”å¥½å¤„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" class="router-link-active router-link-exact-active toc-link level3">ä»€ä¹ˆæ˜¯è½»é‡çº§é”</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”åŸç†" class="router-link-active router-link-exact-active toc-link level3">è½»é‡çº§é”åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”çš„é‡Šæ”¾" class="router-link-active router-link-exact-active toc-link level3">è½»é‡çº§é”çš„é‡Šæ”¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è½»é‡çº§é”å¥½å¤„" class="router-link-active router-link-exact-active toc-link level3">è½»é‡çº§é”å¥½å¤„</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è‡ªæ—‹é”" class="router-link-active router-link-exact-active toc-link level2">è‡ªæ—‹é”</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é€‚åº”æ€§è‡ªæ—‹é”" class="router-link-active router-link-exact-active toc-link level3">é€‚åº”æ€§è‡ªæ—‹é”</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é”æ¶ˆé™¤" class="router-link-active router-link-exact-active toc-link level2">é”æ¶ˆé™¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#é”ç²—åŒ–" class="router-link-active router-link-exact-active toc-link level2">é”ç²—åŒ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" class="router-link-active router-link-exact-active toc-link level2">å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html#è¯»å†™åˆ†ç¦»" class="router-link-active router-link-exact-active toc-link level3">è¯»å†™åˆ†ç¦»</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h2 id="å¯è§æ€§" tabindex="-1"><a class="header-anchor" href="#å¯è§æ€§" aria-hidden="true">#</a> å¯è§æ€§</h2><p>å¯è§æ€§æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å…ˆç«‹å³è·å–åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚</p><p>å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼šå‡ºç°å¯è§æ€§é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¦å¤–çš„çº¿ç¨‹å¹¶æ²¡æœ‰ç«‹å³çœ‹åˆ°ä¿®æ”¹ åçš„æœ€æ–°å€¼ã€‚Synchronizedå’Œvolatileå¯è§£å†³</p><h2 id="åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#åŸå­æ€§" aria-hidden="true">#</a> åŸå­æ€§</h2><p>åœ¨ä¸€æ¬¡æˆ–å¤šæ¬¡æ“ä½œä¸­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—å…¶ä»–å› ç´ å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½ä¸æ‰§è¡Œã€‚</p><p>å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼šå‡ºç°åŸå­æ€§é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡æ“ä½œåˆ°ä¸€åŠæ—¶ï¼Œå¦å¤–çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½æ¥æ“ä½œå…±äº«å˜é‡ï¼Œå¹²æ‰°äº†å‰ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œã€‚</p><p>ä»£ç æ¼”ç¤ºï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 æ¡ˆä¾‹æ¼”ç¤º:5ä¸ªçº¿ç¨‹å„æ‰§è¡Œ1000æ¬¡ i++;
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test02Atomicity</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> increment <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                number<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>ä½¿ç”¨ javap åæ±‡ç¼– class æ–‡ä»¶ï¼Œå¾—åˆ°ä¸‹é¢çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š</p><p>å…¶ä¸­ï¼Œå¯¹äº number++ è€Œè¨€(<code>number</code>ä¸ºé™æ€å˜é‡)ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„JVMå­—èŠ‚ç æŒ‡ä»¤ï¼šç”±æ­¤å¯è§ number++æ˜¯ç”±å¤šæ¡è¯­å¥ç»„æˆï¼Œä»¥ä¸Šå¤šæ¡æŒ‡ä»¤åœ¨ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤š çº¿ç¨‹æƒ…å†µä¸‹å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ 13: iadd æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åˆæ‰§è¡Œ 9: getstaticã€‚ä¼šå¯¼ è‡´ä¸¤æ¬¡ number++ï¼Œå®é™…ä¸ŠåªåŠ äº† 1ã€‚</p><p><img src="/blog/assets/1-2-1.2021b711.png" alt="å­—èŠ‚ç æŒ‡ä»¤" loading="lazy"></p><h2 id="æœ‰åºæ€§" tabindex="-1"><a class="header-anchor" href="#æœ‰åºæ€§" aria-hidden="true">#</a> æœ‰åºæ€§</h2><p>æœ‰åºæ€§ï¼šæ˜¯æŒ‡ç¨‹åºä¸­ä»£ç çš„æ‰§è¡Œé¡ºåºï¼ŒJavaåœ¨ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶ä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä¼šå¯¼è‡´ç¨‹åºæœ€ç»ˆçš„æ‰§è¡Œé¡ºåºä¸ä¸€å®šå°±æ˜¯æˆ‘ä»¬ç¼–å†™ä»£ç æ—¶çš„é¡ºåºã€‚</p><p>ç¨‹åºä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…ˆåé¡ºåºï¼Œç”±äº Java åœ¨ç¼–è¯‘æœŸä»¥åŠè¿è¡ŒæœŸçš„ä¼˜åŒ–ï¼Œå¯¼è‡´äº†ä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯å¼€å‘è€…ç¼–å†™ä»£ç æ—¶çš„é¡ºåºã€‚</p><p><a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress" target="_blank" rel="noopener noreferrer">Jcstress<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ˜¯javaå¹¶å‘å‹æµ‹å·¥å…·ã€‚ä¿®æ”¹pomæ–‡ä»¶ï¼Œæ·»åŠ ä¾èµ–ï¼š</p><p>å¯¼å…¥ä¾èµ–</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jcstress<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jcstress-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jcstress.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ä»£ç æ¼”ç¤º</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>infra<span class="token punctuation">.</span>results<span class="token punctuation">.</span></span><span class="token class-name">I_Result</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@JCStressTest</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTING<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;danger&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test03Orderliness</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// çº¿ç¨‹ä¸€æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§r1ç”¨æ¥ä¿å­˜ç»“æœï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯èƒ½å‡ºç°å‡ ç§ç»“æœï¼Ÿ</p><ul><li>æƒ…å†µ 1ï¼šçº¿ç¨‹1å…ˆæ‰§è¡Œ actor1ï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1ã€‚</li><li>æƒ…å†µ 2ï¼šçº¿ç¨‹2æ‰§è¡Œåˆ°actor2ï¼Œæ‰§è¡Œäº† num = 2;å’Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ã€‚</li><li>æƒ…å†µ 3ï¼šçº¿ç¨‹2å…ˆæ‰§è¡Œactor2ï¼Œåªæ‰§è¡Œnum=2ï¼›ä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥Elseåˆ†æ”¯ï¼Œç»“æœä¸º1ã€‚</li><li>è¿˜æœ‰ä¸€ç§ç»“æœ 0ã€‚</li></ul><h2 id="äºŒã€java-å†…å­˜æ¨¡å‹-jmm" tabindex="-1"><a class="header-anchor" href="#äºŒã€java-å†…å­˜æ¨¡å‹-jmm" aria-hidden="true">#</a> äºŒã€Java å†…å­˜æ¨¡å‹(JMM)</h2><p>å…³äºâ€œJava å†…å­˜æ¨¡å‹â€çš„æƒå¨è§£é‡Šï¼Œè¯·<a href="https://download.oracle.com/otn-pub/jcp/memory_model1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.PDF" target="_blank" rel="noopener noreferrer">å‚è€ƒ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼›</p><p><img src="/blog/assets/2-2-1.1f17c327.png" alt="å†…å­˜æ¨¡å‹" loading="lazy"></p><p>Javaå†…å­˜æ¨¡å‹ï¼Œæ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ‰€å®šä¹‰çš„ä¸€ç§å†…å­˜æ¨¡å‹ï¼ŒJavaå†…å­˜æ¨¡å‹æ˜¯æ ‡å‡†åŒ–çš„ï¼Œå±è”½æ‰äº†åº•å±‚ä¸åŒè®¡ç®—æœºçš„åŒºåˆ«ã€‚</p><p>Java å†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—è§„èŒƒï¼Œæè¿°äº†Javaç¨‹åºä¸­å„ç§å˜é‡(çº¿ç¨‹å…±äº«å˜é‡)çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨JVMä¸­å°†å˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p><ul><li>ä¸»å†…å­˜ ä¸»å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹éƒ½å…±äº«çš„ï¼Œéƒ½èƒ½è®¿é—®çš„ã€‚æ‰€æœ‰çš„å…±äº«å˜é‡éƒ½å­˜å‚¨äºä¸»å†…å­˜ã€‚</li><li>å·¥ä½œå†…å­˜ æ¯ä¸€ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜åªå­˜å‚¨è¯¥çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰çš„æ“ ä½œ(è¯»ï¼Œå–)éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿä¸èƒ½ç›´æ¥ è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ã€‚</li></ul><p>Javaå†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—åœ¨å¤šçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ—¶ï¼Œå¯¹å…±äº«æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸå­æ€§çš„è§„åˆ™å’Œä¿éšœã€‚Synchronized,volatile</p><h3 id="cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" tabindex="-1"><a class="header-anchor" href="#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" aria-hidden="true">#</a> CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»</h3><p>é€šè¿‡å¯¹å‰é¢çš„CPUç¡¬ä»¶å†…å­˜æ¶æ„ã€Javaå†…å­˜æ¨¡å‹ä»¥åŠJavaå¤šçº¿ç¨‹çš„å®ç°åŸç†çš„äº†è§£ï¼Œæˆ‘ä»¬åº”è¯¥å·²ç»æ„è¯†åˆ°ï¼Œå¤šçº¿ç¨‹çš„æ‰§è¡Œæœ€ç»ˆéƒ½ä¼šæ˜ å°„åˆ°ç¡¬ä»¶å¤„ç†å™¨ä¸Šè¿›è¡Œæ‰§è¡Œã€‚</p><p>ä½† Java å†…å­˜æ¨¡å‹å’Œç¡¬ä»¶å†…å­˜æ¶æ„å¹¶ä¸å®Œå…¨ä¸€è‡´ã€‚</p><p>å¯¹äºç¡¬ä»¶å†…å­˜æ¥è¯´åªæœ‰å¯„å­˜å™¨ã€ç¼“å­˜å†…å­˜ã€ä¸»å†…å­˜çš„æ¦‚å¿µï¼Œå¹¶æ²¡æœ‰å·¥ä½œå†…å­˜å’Œä¸»å†…å­˜ä¹‹åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´Javaå†…å­˜æ¨¡å‹å¯¹å†…å­˜çš„åˆ’åˆ†å¯¹ç¡¬ä»¶å†…å­˜å¹¶æ²¡æœ‰ä»»ä½•å½±å“ï¼Œå› ä¸ºJMMåªæ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯ä¸€ç»„è§„åˆ™ï¼Œä¸ç®¡æ˜¯å·¥ä½œå†…å­˜çš„æ•°æ®è¿˜æ˜¯ä¸»å†…å­˜çš„æ•°æ®ï¼Œå¯¹äºè®¡ç®—æœºç¡¬ä»¶æ¥è¯´éƒ½ä¼šå­˜å‚¨åœ¨è®¡ç®—æœºä¸»å†…å­˜ä¸­ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½å­˜å‚¨åˆ°CPUç¼“å­˜æˆ–è€…å¯„å­˜å™¨ä¸­ï¼Œå› æ­¤æ€»ä½“ä¸Šæ¥è¯´ï¼ŒJavaå†…å­˜æ¨¡å‹å’Œè®¡ç®—æœºç¡¬ä»¶å†…å­˜æ¶æ„æ˜¯ä¸€ä¸ªç›¸äº’äº¤å‰çš„å…³ç³»ï¼Œæ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µåˆ’åˆ†ä¸çœŸå®ç‰©ç†ç¡¬ä»¶çš„äº¤å‰ã€‚</p><p>JMMå†…å­˜æ¨¡å‹ä¸CPUç¡¬ä»¶å†…å­˜æ¶æ„çš„å…³ç³»ï¼š</p><p><img src="/blog/assets/2-2-2.35cca066.png" alt="JMMå†…å­˜æ¨¡å‹ä¸CPUç¡¬ä»¶å†…å­˜æ¶æ„çš„å…³ç³»" loading="lazy"></p><div class="custom-container tip"><p class="custom-container-title">æ€»ç»“</p><p>Java å†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—è§„èŒƒï¼Œæè¿°äº† Java ç¨‹åºä¸­å„ç§å˜é‡(çº¿ç¨‹å…±äº«å˜é‡)çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨ JVM ä¸­å°†å˜é‡ å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡å‹æ˜¯å¯¹å…±äº«æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸ å­æ€§çš„è§„åˆ™å’Œä¿éšœã€‚</p></div><h3 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" tabindex="-1"><a class="header-anchor" href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" aria-hidden="true">#</a> ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’</h3><p><img src="/blog/assets/2-3-1.30f7e39d.png" alt="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„æ•°æ®äº¤äº’" loading="lazy"></p><p>Javaå†…å­˜æ¨¡å‹ä¸­å®šä¹‰äº†ä»¥ä¸‹ 8 ç§æ“ä½œæ¥å®Œæˆï¼Œä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½• ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¹‹ç±»çš„å®ç°ç»†èŠ‚ï¼Œè™šæ‹Ÿæœºå®ç°æ—¶å¿…é¡»ä¿è¯ä¸‹é¢ æåŠçš„æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŸå­çš„ã€ä¸å¯å†åˆ†çš„ã€‚</p><p>å¯¹åº”å¦‚ä¸‹çš„æµç¨‹å›¾ï¼š</p><p><img src="/blog/assets/2-3-2.8a9add90.png" alt="æµç¨‹å›¾" loading="lazy"></p><ol><li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼</li><li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>lock -&gt; read -&gt; load -&gt; use -&gt; assign -&gt; store -&gt; write -&gt; unlock
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§" aria-hidden="true">#</a> ä¸‰ã€synchronized ä¿è¯ä¸‰å¤§ç‰¹æ€§</h2><p>Synchronizedèƒ½å¤Ÿä¿è¯åœ¨åŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œsynchronizeä¿®é¥°çš„ä»£ç ï¼Œä»¥è¾¾åˆ°ä¿è¯å¹¶å‘å®‰å…¨çš„æ•ˆæœã€‚</p><h3 id="synchronizedä¸åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#synchronizedä¸åŸå­æ€§" aria-hidden="true">#</a> synchronizedä¸åŸå­æ€§</h3><p>æ¡ˆä¾‹æ¼”ç¤º: 5ä¸ªçº¿ç¨‹å„æ‰§è¡Œ1000æ¬¡i++;</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01Atomicity</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> increment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Test01Atomicity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        number<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="ä¿è¯åŸå­æ€§çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#ä¿è¯åŸå­æ€§çš„åŸç†" aria-hidden="true">#</a> ä¿è¯åŸå­æ€§çš„åŸç†</h3><p>å¯¹<code>number++;</code>å¢åŠ åŒæ­¥ä»£ç å—åï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œ number++;ã€‚å°±ä¸ä¼šå‡ºç°å®‰å…¨é—®é¢˜ã€‚</p><p>Synchronized ä¿è¯åŸå­æ€§çš„åŸç†ï¼Œsynchronized ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”ï¼Œèƒ½å¤Ÿè¿›å…¥åŒæ­¥ä»£ç å—ã€‚</p><h2 id="synchronized-ä¸å¯è§æ€§" tabindex="-1"><a class="header-anchor" href="#synchronized-ä¸å¯è§æ€§" aria-hidden="true">#</a> synchronized ä¸å¯è§æ€§</h2><p>ä¸€ä¸ªçº¿ç¨‹æ ¹æ®booleanç±»å‹çš„æ ‡è®°flagï¼Œwhileå¾ªç¯ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜è¿™ä¸ªflagå˜é‡çš„å€¼ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœæ­¢å¾ªç¯ã€‚</p><p>Synchronizedä¿è¯å¯è§æ€§çš„åŸç†ï¼Œæ‰§è¡Œsynchronizedæ—¶ï¼Œä¼šå¯¹åº”lockåŸå­æ“ä½œä¼šåˆ·æ–°å·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼</p><p>ä»£ç ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01Visibility</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤šä¸ªçº¿ç¨‹éƒ½ä¼šè®¿é—®çš„æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¸ºçº¿ç¨‹çš„å…±äº«æ•°æ®</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¢åŠ å¯¹è±¡å…±äº«æ•°æ®çš„æ‰“å°ï¼Œprintlnæ˜¯åŒæ­¥æ–¹æ³•</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;run = &quot;</span> <span class="token operator">+</span> run<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ—¶é—´åˆ°ï¼Œçº¿ç¨‹2è®¾ç½®ä¸ºfalse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="/blog/assets/synchronized-principle-analysis-and-optimization-1649899273782.9bd9b4d1.png" alt="synchronizeå¯è§æ€§" loading="lazy"></p><h2 id="synchronized-ä¸æœ‰åºæ€§" tabindex="-1"><a class="header-anchor" href="#synchronized-ä¸æœ‰åºæ€§" aria-hidden="true">#</a> synchronized ä¸æœ‰åºæ€§</h2><p>ä¸ºäº†æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œç¼–è¯‘å™¨å’Œ CPU ä¼šå¯¹ç¨‹åºä¸­ä»£ç è¿›è¡Œé‡æ’åºã€‚</p><p>As-if-serialè¯­ä¹‰çš„æ„æ€æ˜¯ï¼šä¸ç®¡ç¼–è¯‘å™¨å’ŒCPUå¦‚ä½•é‡æ’åºï¼Œå¿…é¡»ä¿è¯åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ç¨‹åºçš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p><p>ä»¥ä¸‹æ•°æ®æœ‰ä¾èµ–å…³ç³»ï¼Œä¸èƒ½é‡æ’åºã€‚</p><ul><li>å†™åè¯»ï¼š<code>int a = 1; int b = a;</code></li><li>å†™åå†™ï¼š<code>int a = 1; int a = 2;</code></li><li>è¯»åå†™ï¼š<code>int a = 1; int b = a; int a = 2;</code></li></ul><p>ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚ æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå°±å¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚</p><p><code>int a = 1; int b = 2; int c = a + b;</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JCStressTest</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE<span class="token punctuation">,</span>desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTING<span class="token punctuation">,</span>desc <span class="token operator">=</span> <span class="token string">&quot;danger&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test03Ordering</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// çº¿ç¨‹ä¸€æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>Synchronizedåï¼Œè™½ç„¶è¿›è¡Œäº†é‡æ’åºï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¿›å…¥åŒæ­¥ä»£ç å—ï¼Œä¹Ÿèƒ½ä¿è¯æœ‰åºæ€§ã€‚</p><div class="custom-container tip"><p class="custom-container-title">æ€»ç»“</p><p>Synchronized ä¿è¯æœ‰åºæ€§çš„åŸç†ï¼Œæˆ‘ä»¬åŠ  synchronized åï¼Œä¾ç„¶ä¼šå‘ç”Ÿé‡æ’åºï¼Œåªä¸è¿‡ï¼Œæˆ‘ä»¬æœ‰åŒæ­¥ ä»£ç å—ï¼Œå¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ä¸­çš„ä»£ç ã€‚ä¿è¯æœ‰åºæ€§ã€‚</p></div><h2 id="å¯é‡å…¥ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#å¯é‡å…¥ç‰¹æ€§" aria-hidden="true">#</a> å¯é‡å…¥ç‰¹æ€§</h2><p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡æ‰§è¡Œsynchronized,é‡å¤è·å–åŒä¸€æŠŠé”ã€‚</p><p>å¯é‡å…¥ç‰¹æ€§æŒ‡çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå¯ä»¥ç›´æ¥å†æ¬¡è·å–è¯¥é”ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> sellTicket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘æ˜¯run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘æ˜¯test01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>sellTicket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>sellTicket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å¯é‡å…¥çš„å¥½å¤„ï¼šä¸€ã€å¯ä»¥é¿å…æ­»é”ï¼›äºŒã€å¯ä»¥è®©æˆ‘ä»¬æ›´å¥½çš„æ¥å°è£…ä»£ç ã€‚</p><p>å¯é‡å…¥åŸç†ï¼šSynchronizedçš„é”å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªè®¡æ•°å™¨(<code>recursionså˜é‡</code>)ä¼šè®°å½•çº¿ç¨‹è·å¾—å‡ æ¬¡é”.</p><div class="custom-container tip"><p class="custom-container-title">æ€»ç»“</p><p>Synchronizedæ˜¯å¯é‡å…¥é”ï¼Œå†…éƒ¨é”å¯¹è±¡ä¸­ä¼šæœ‰ä¸€ä¸ªè®¡æ•°å™¨è®°å½•çº¿ç¨‹è·å–å‡ æ¬¡é”å•¦ï¼Œåœ¨æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œè®¡æ•°å™¨çš„æ•°é‡ä¼š-1ï¼ŒçŸ¥é“è®¡æ•°å™¨çš„æ•°é‡ä¸º0ï¼Œå°±é‡Šæ”¾è¿™ä¸ªé”ã€‚</p></div><h2 id="ä¸å¯ä¸­æ–­ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸å¯ä¸­æ–­ç‰¹æ€§" aria-hidden="true">#</a> ä¸å¯ä¸­æ–­ç‰¹æ€§</h2><p>ä¸€ä¸ªçº¿ç¨‹è·å¾—é”åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å¾—é”ï¼Œå¿…é¡»å¤„äºé˜»å¡æˆ–ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸é‡Šæ”¾é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡æˆ–ç­‰å¾…ï¼Œä¸å¯è¢«ä¸­æ–­ã€‚</p><p>Synchronizedæ˜¯ä¸å¯ä¸­æ–­ï¼Œå¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…é”ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo02_Uninterruptible</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> run <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;è¿›å…¥åŒæ­¥ä»£ç å—&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">888888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Runnable</span> run <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                b <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;è·å¾—é”,è¿›å…¥é”æ‰§è¡Œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">88888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;åœ¨æŒ‡å®šæ—¶é—´æ²¡æœ‰å¾—åˆ°é”åšå…¶ä»–æ“ä½œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;é‡Šæ”¾é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>


        <span class="token comment">// å¼€å¯ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡ŒåŒæ­¥ä»£ç å—</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åœæ­¢çº¿ç¨‹å‰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åœæ­¢çº¿ç¨‹å&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>ä¸å¯ä¸­æ–­æ˜¯æŒ‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´å¤„äºé˜»å¡æˆ–ç­‰å¾…çŠ¶æ€ï¼Œå‰ä¸€ä¸ªçº¿ç¨‹ä¸é‡Šæ”¾é”ï¼Œåä¸€ä¸ªçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡æˆ–ç­‰å¾…ï¼Œä¸å¯è¢«ä¸­æ–­ã€‚</p><ul><li>Synchronizedå±äºä¸å¯è¢«ä¸­æ–­</li><li>Lock çš„ lock æ–¹æ³•æ˜¯ä¸å¯ä¸­æ–­çš„,tryLockæ–¹æ³•æ˜¯å¯ä¸­æ–­çš„</li></ul><h1 id="äº”ã€synchronizedåŸç†" tabindex="-1"><a class="header-anchor" href="#äº”ã€synchronizedåŸç†" aria-hidden="true">#</a> äº”ã€synchronizedåŸç†</h1><p>é€šè¿‡javapåæ±‡ç¼–å­¦ä¹ synchronizedçš„åŸç†</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo04_synchronized_monitor</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>æˆ‘ä»¬è¦çœ‹synchronizedçš„åŸç†ï¼Œä½†æ˜¯synchronizedæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œçœ‹ä¸åˆ°æºç ã€‚æˆ‘ä»¬å¯ä»¥å°†classæ–‡ä»¶è¿›è¡Œåæ±‡ç¼–ã€‚</p><p>JDKè‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ï¼šjavapï¼Œå¯¹å­—èŠ‚ç è¿›è¡Œåæ±‡ç¼–ï¼ŒæŸ¥çœ‹å­—èŠ‚ç æŒ‡ä»¤ã€‚</p><p>åæ±‡ç¼–åçš„æ•ˆæœå¦‚ä¸‹ï¼š<code>Javap -p -v -c</code></p><p><img src="/blog/assets/5-1-1.d02399d6.png" alt="åæ±‡ç¼–åçš„æ•ˆæœ" loading="lazy"></p><h3 id="monitorenter" tabindex="-1"><a class="header-anchor" href="#monitorenter" aria-hidden="true">#</a> monitorenter</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JVM è§„èŒƒä¸­å¯¹äº monitorenter çš„æè¿°ï¼š<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter" target="_blank" rel="noopener noreferrer">å‚è€ƒ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¼šå’Œä¸€ä¸ªç›‘è§†å™¨monitorå…³è”ã€‚ç›‘è§†å™¨è¢«å ç”¨æ—¶ä¼šè¢«é”ä½ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•æ¥è·å–è¯¥monitorã€‚å½“JVMæ‰§è¡ŒæŸä¸ªçº¿ç¨‹çš„æŸä¸ªæ–¹æ³•å†…éƒ¨çš„monitorenteræ—¶ï¼Œå®ƒä¼šå°è¯•å»è·å–å½“å‰å¯¹è±¡å¯¹åº”çš„monitorçš„æ‰€æœ‰æƒã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è‹¥moniorçš„è¿›å…¥æ•°ä¸º0ï¼Œçº¿ç¨‹å¯ä»¥è¿›å…¥monitorï¼Œå¹¶å°†monitorçš„è¿›å…¥æ•°ç½®ä¸º1ã€‚å½“å‰çº¿ç¨‹æˆä¸ºmonitorçš„owner(æ‰€æœ‰è€…)</li><li>è‹¥çº¿ç¨‹å·²æ‹¥æœ‰monitorçš„æ‰€æœ‰æƒï¼Œå…è®¸å®ƒé‡å…¥monitorï¼Œåˆ™è¿›å…¥monitorçš„è¿›å…¥æ•°åŠ 1</li><li>è‹¥å…¶ä»–çº¿ç¨‹å·²ç»å æœ‰monitorçš„æ‰€æœ‰æƒï¼Œé‚£ä¹ˆå½“å‰å°è¯•è·å–monitorçš„æ‰€æœ‰æƒçš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°monitorçš„è¿›å…¥æ•°å˜ä¸º0ï¼Œæ‰èƒ½é‡æ–°å°è¯•è·å–monitorçš„æ‰€æœ‰æƒã€‚</li></ol><div class="custom-container info"><p class="custom-container-title">Monitorenter å°ç»“</p><p>Synchronizedçš„é”å¯¹è±¡ä¼šå…³è”ä¸€ä¸ªmonitor,è¿™ä¸ªmonitorä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨åˆ›å»ºçš„,æ˜¯JVMçš„çº¿ç¨‹æ‰§è¡Œåˆ°è¿™ä¸ªåŒæ­¥ä»£ç å—,å‘ç°é”å¯¹è±¡æ²¡æœ‰monitorå°±ä¼šåˆ›å»ºmonitor,monitorå†…éƒ¨æœ‰ä¸¤ä¸ªé‡è¦çš„æˆå‘˜å˜é‡owner:æ‹¥æœ‰è¿™æŠŠé”çš„çº¿ç¨‹,recursionsä¼šè®°å½•çº¿ç¨‹æ‹¥æœ‰é”çš„æ¬¡æ•°,å½“ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰monitoråå…¶ä»–çº¿ç¨‹åªèƒ½ç­‰å¾…ã€‚</p></div><h3 id="monitorexit" tabindex="-1"><a class="header-anchor" href="#monitorexit" aria-hidden="true">#</a> monitorexit</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JVM è§„èŒƒä¸­å¯¹äº monitorexit çš„æè¿°ï¼š</p><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit" target="_blank" rel="noopener noreferrer">å‚è€ƒ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li>èƒ½æ‰§è¡ŒmonitorexitæŒ‡ä»¤çš„çº¿ç¨‹ä¸€å®šæ˜¯æ‹¥æœ‰å½“å‰å¯¹è±¡çš„monitorçš„æ‰€æœ‰æƒçš„çº¿ç¨‹ã€‚</li><li>æ‰§è¡Œmonitorexitæ—¶ä¼šå°†monitorçš„è¿›å…¥æ•°å‡1ã€‚å½“monitorçš„è¿›å…¥æ•°å‡ä¸º0æ—¶ï¼Œå½“å‰çº¿ç¨‹é€€å‡ºmonitorï¼Œä¸å†æ‹¥æœ‰monitorçš„æ‰€æœ‰æƒï¼Œæ­¤æ—¶å…¶ä»–è¢«è¿™ä¸ªmonitoré˜»å¡çš„çº¿ç¨‹å¯ä»¥å°è¯•å»è·å–è¿™ä¸ªmonitorçš„æ‰€æœ‰æƒmonitorexité‡Šæ”¾é”ã€‚</li></ol><p>Monitorexitæ’å…¥åœ¨æ–¹æ³•ç»“æŸå¤„å’Œå¼‚å¸¸å¤„ï¼ŒJVMä¿è¯æ¯ä¸ªmonitorenterå¿…é¡»æœ‰å¯¹åº”çš„monitorexitã€‚</p><p>é—®é¢˜synchrozniedå‡ºç°å¼‚å¸¸ä¼šé‡Šæ”¾é”å—? ä¼šé‡Šæ”¾é”</p><h3 id="åŒæ­¥æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥æ–¹æ³•" aria-hidden="true">#</a> åŒæ­¥æ–¹æ³•</h3><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10" target="_blank" rel="noopener noreferrer">å‚è€ƒ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å¯ä»¥çœ‹åˆ°åŒæ­¥æ–¹æ³•åœ¨åæ±‡ç¼–åï¼Œä¼šå¢åŠ ACC_SYNCHRONIZEDä¿®é¥°ã€‚ä¼šéšå¼è°ƒç”¨monitorenterå’Œmonitorexitã€‚åœ¨æ‰§è¡ŒåŒæ­¥æ–¹æ³•å‰ä¼šè°ƒç”¨monitorenterï¼Œåœ¨æ‰§è¡Œå®ŒåŒæ­¥æ–¹æ³•åä¼šè°ƒç”¨monitorexitã€‚</p><div class="custom-container tip"><p class="custom-container-title">æ€»ç»“</p><p>é€šè¿‡ javap åæ±‡ç¼–æˆ‘ä»¬çœ‹åˆ° synchronized ä½¿ç”¨ç¼–ç¨‹äº† monitorentor å’Œ monitorexit ä¸¤ä¸ªæŒ‡ä»¤ã€‚</p><p>æ¯ä¸ªé”å¯¹è±¡éƒ½ä¼šå…³è”ä¸€ä¸ªmonitor(ç›‘è§†å™¨,å®ƒæ‰æ˜¯çœŸæ­£çš„é”å¯¹è±¡),å®ƒå†…éƒ¨æœ‰ä¸¤ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š</p><ul><li>ownerä¼šä¿å­˜è·å¾—é”çš„çº¿ç¨‹ï¼›</li><li>recursionsä¼šä¿å­˜çº¿ç¨‹è·å¾—é”çš„æ¬¡æ•°ï¼›</li></ul><p>å½“æ‰§è¡Œåˆ° monitorexit æ—¶,recursions ä¼š-1,å½“è®¡æ•°å™¨å‡åˆ° 0 æ—¶è¿™ä¸ªçº¿ç¨‹å°±ä¼šé‡Šæ”¾é”ã€‚</p></div><h3 id="é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" aria-hidden="true">#</a> é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«</h3><ol><li>synchronizedæ˜¯å…³é”®å­—ï¼Œè€ŒLockæ˜¯ä¸€ä¸ªæ¥å£ã€‚</li><li>synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œè€ŒLockå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾é”ã€‚</li><li>synchronizedæ˜¯ä¸å¯ä¸­æ–­çš„ï¼ŒLockå¯ä»¥ä¸­æ–­ä¹Ÿå¯ä»¥ä¸ä¸­æ–­ã€‚</li><li>é€šè¿‡Lockå¯ä»¥çŸ¥é“çº¿ç¨‹æœ‰æ²¡æœ‰æ‹¿åˆ°é”ï¼Œè€Œsynchronizedä¸èƒ½ã€‚</li><li>synchronizedèƒ½é”ä½æ–¹æ³•å’Œä»£ç å—ï¼Œè€ŒLockåªèƒ½é”ä½ä»£ç å—ã€‚</li><li>Lockå¯ä»¥ä½¿ç”¨è¯»é”æé«˜å¤šçº¿ç¨‹è¯»æ•ˆç‡ã€‚</li><li>synchronizedæ˜¯éå…¬å¹³é”ï¼Œ<code>ReentrantLock</code>å¯ä»¥æ§åˆ¶æ˜¯å¦æ˜¯å…¬å¹³é”ã€‚</li></ol><h2 id="æ·±å…¥jvmæºç åˆ†æsynchronizedçš„åŸç†" tabindex="-1"><a class="header-anchor" href="#æ·±å…¥jvmæºç åˆ†æsynchronizedçš„åŸç†" aria-hidden="true">#</a> æ·±å…¥JVMæºç åˆ†æ<code>synchronized</code>çš„åŸç†</h2><p><a href="http://openjdk.java.net" target="_blank" rel="noopener noreferrer">JVM æºç ä¸‹è½½<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Mercurial --&gt; jdk8 --&gt; hotspot --&gt; zip</p><h3 id="monitor-ç›‘è§†å™¨é”" tabindex="-1"><a class="header-anchor" href="#monitor-ç›‘è§†å™¨é”" aria-hidden="true">#</a> monitor ç›‘è§†å™¨é”</h3><p>å¯ä»¥çœ‹å‡ºæ— è®ºæ˜¯<code>synchronized</code>ä»£ç å—è¿˜æ˜¯<code>synchronized</code>æ–¹æ³•ï¼Œå…¶çº¿ç¨‹å®‰å…¨çš„è¯­ä¹‰å®ç°æœ€ç»ˆä¾èµ–ä¸€ä¸ªå«<code>monitor</code>çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆè¿™ä¸ªç¥ç§˜çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢è®©æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p><p>åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œmonitor æ˜¯ç”± ObjectMonitor å®ç°çš„ã€‚å…¶æºç æ˜¯ç”¨ c++æ¥å®ç°çš„ï¼Œ<code>src/share/vm/runtime/objectMonitor.hpp</code></p><p>ObjectMonitorä¸»è¦æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><ol><li>_ownerï¼šåˆå§‹æ—¶ä¸º NULLã€‚å½“æœ‰çº¿ç¨‹å æœ‰è¯¥ monitor æ—¶ï¼Œowner æ ‡è®°ä¸ºè¯¥çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ã€‚å½“çº¿ç¨‹é‡Šæ”¾ monitor æ—¶ï¼Œowner åˆæ¢å¤ä¸º NULLã€‚owner æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æºï¼ŒJVM æ˜¯é€šè¿‡ CAS æ“ä½œæ¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨çš„ã€‚</li><li>_cxqï¼šç«äº‰é˜Ÿåˆ—ï¼Œæ‰€æœ‰è¯·æ±‚é”çš„çº¿ç¨‹é¦–å…ˆä¼šè¢«æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­(å•å‘é“¾æ¥)ã€‚cxqæ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æºï¼ŒJVMé€šè¿‡CASåŸå­æŒ‡ä»¤æ¥ä¿®æ”¹<code>cxq</code>é˜Ÿåˆ—ã€‚ä¿®æ”¹å‰<code>cxq</code> çš„æ—§å€¼å¡«å…¥äº† <code>Node.js</code> çš„ <code>next</code> å­—æ®µï¼Œ<code>_cxq</code>æŒ‡å‘æ–°å€¼(æ–°çº¿ç¨‹)ã€‚å› æ­¤cxq æ˜¯ä¸€ä¸ªåè¿›å…ˆå‡ºçš„ stack(æ ˆ)ã€‚</li><li>_EntryListï¼š_cxq é˜Ÿåˆ—ä¸­æœ‰èµ„æ ¼æˆä¸ºå€™é€‰èµ„æºçš„çº¿ç¨‹ä¼šè¢«ç§»åŠ¨åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚</li><li>_WaitSetï¼šå› ä¸ºè°ƒç”¨waitæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«æ”¾åœ¨è¯¥é˜Ÿåˆ—ä¸­ã€‚</li></ol><p>æ¯ä¸€ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥ä¸ä¸€ä¸ªç›‘è§†å™¨ monitor å…³è”ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸ºä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡Œä¸€æ®µè¢«synchronizedåœˆèµ·æ¥çš„åŒæ­¥æ–¹æ³•æˆ–è€…ä»£ç å—æ—¶ï¼Œè¯¥çº¿ç¨‹å¾—å…ˆè·å–åˆ° synchronized ä¿®é¥°çš„å¯¹è±¡ å¯¹åº”çš„ monitorã€‚</p><p>æˆ‘ä»¬çš„Javaä»£ç é‡Œä¸ä¼šæ˜¾ç¤ºåœ°å»åˆ›é€ è¿™ä¹ˆä¸€ä¸ªmonitorå¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿæ— éœ€åˆ›å»ºï¼Œäº‹å®ä¸Šå¯ä»¥è¿™ä¹ˆç†è§£ï¼šmonitorå¹¶ä¸æ˜¯éšç€å¯¹è±¡åˆ›å»ºè€Œåˆ›å»ºçš„ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡synchronizedä¿®é¥°ç¬¦å‘Šè¯‰JVMéœ€è¦ä¸ºæˆ‘ä»¬çš„æŸä¸ªå¯¹è±¡åˆ›å»ºå…³è”çš„monitorå¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å­˜åœ¨ä¸¤ä¸ªObjectMonitorå¯¹è±¡åˆ—è¡¨ï¼Œåˆ†åˆ«ä¸ºfreeå’Œusedåˆ—è¡¨ã€‚åŒæ—¶JVMä¸­ä¹Ÿç»´æŠ¤ç€global locklistã€‚å½“çº¿ç¨‹éœ€è¦ObjectMonitorå¯¹è±¡æ—¶ï¼Œé¦–å…ˆä»çº¿ç¨‹è‡ªèº«çš„freeè¡¨ä¸­ç”³è¯·ï¼Œè‹¥å­˜åœ¨åˆ™ä½¿ç”¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä»<code>global list</code>ä¸­ç”³è¯·ã€‚</p><p><code>ObjectMonitor</code>çš„æ•°æ®ç»“æ„ä¸­åŒ…å«ï¼š<code>owner</code>ã€<code>WaitSet</code>å’Œ<code>EntryList</code>ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»è½¬æ¢å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p><p><img src="/blog/assets/5-2-1.1d54a3e2.png" alt="ObjectMonitor" loading="lazy"></p><h3 id="monitor-ç«äº‰" tabindex="-1"><a class="header-anchor" href="#monitor-ç«äº‰" aria-hidden="true">#</a> monitor ç«äº‰</h3><ol><li>æ‰§è¡Œ monitorenter æ—¶ï¼Œä¼šè°ƒç”¨ InterpreterRuntime.cpp (ä½äºï¼šsrc/share/vm/interpreter/interpreterRuntime.cpp)çš„InterpreterRuntime::monitorenter å‡½æ•°ã€‚å…·ä½“ä»£ç å¯å‚è§ HotSpot æºç ã€‚</li><li>å¯¹äºé‡é‡çº§é”ï¼Œmonitorenter å‡½æ•°ä¸­ä¼šè°ƒç”¨ ObjectSynchronizer::slow_enter</li><li>æœ€ç»ˆè°ƒç”¨ ObjectMonitor::enter(ä½äºï¼šsrc/share/vm/runtime/objectMonitor.cpp)ï¼Œæºç å¦‚ä¸‹ï¼š</li></ol><p>æ­¤å¤„çœç•¥é”çš„è‡ªæ—‹ä¼˜åŒ–ç­‰æ“ä½œï¼Œç»Ÿä¸€æ”¾åœ¨åé¢ synchronzied ä¼˜åŒ–ä¸­è¯´ã€‚ ä»¥ä¸Šä»£ç çš„å…·ä½“æµç¨‹æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡ CAS å°è¯•æŠŠ monitor çš„ owner å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚</li><li>å¦‚æœè®¾ç½®ä¹‹å‰çš„ owner æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹å†æ¬¡è¿›å…¥ monitorï¼Œå³é‡å…¥é”ï¼Œæ‰§è¡Œrecursions ++ ï¼Œè®°å½•é‡å…¥çš„æ¬¡æ•°ã€‚</li><li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥ monitorï¼Œè®¾ç½® recursions ä¸º 1ï¼Œowner ä¸ºå½“å‰çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹æˆåŠŸè·å¾—é”å¹¶è¿”å›ã€‚</li><li>å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç­‰å¾…é”çš„é‡Šæ”¾ã€‚</li></ol><h3 id="monitor-ç­‰å¾…" tabindex="-1"><a class="header-anchor" href="#monitor-ç­‰å¾…" aria-hidden="true">#</a> monitor ç­‰å¾…</h3><p>ç«äº‰å¤±è´¥ç­‰å¾…è°ƒç”¨çš„æ˜¯<code>ObjectMonitor</code>å¯¹è±¡çš„<code>EnterI</code>æ–¹æ³•ï¼ˆä½äºï¼š<code>src/share/vm/runtime/objectMonitor.cpp</code>ï¼‰ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>å½“è¯¥çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡ ObjectMonitor::TryLock å°è¯•è·å–é”ï¼Œ<code>TryLock</code>æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p><ol><li>å½“å‰çº¿ç¨‹è¢«å°è£…æˆ<code>ObjectWaiter</code>å¯¹è±¡<code>node</code>ï¼ŒçŠ¶æ€è®¾ç½®æˆ<code>ObjectWaiter::TS_CXQ</code>ã€‚</li><li>åœ¨ for å¾ªç¯ä¸­ï¼Œé€šè¿‡ CAS æŠŠ Node.js èŠ‚ç‚¹ push åˆ°cxq åˆ—è¡¨ä¸­ï¼ŒåŒä¸€æ—¶åˆ»å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹æŠŠè‡ªå·±çš„<code>node</code>èŠ‚ç‚¹ push åˆ°cxq åˆ—è¡¨ä¸­ã€‚</li><li>Node.jsèŠ‚ç‚¹<code>push</code>åˆ°<code>cxq</code>åˆ—è¡¨ä¹‹åï¼Œé€šè¿‡è‡ªæ—‹å°è¯•è·å–é”ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™é€šè¿‡ park å°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</li><li>å½“è¯¥çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡<code>ObjectMonitor::TryLock</code>å°è¯•è·å–é”ã€‚</li></ol><h3 id="monitor-é‡Šæ”¾" tabindex="-1"><a class="header-anchor" href="#monitor-é‡Šæ”¾" aria-hidden="true">#</a> monitor é‡Šæ”¾</h3><p>å½“æŸä¸ªæŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼šè¿›è¡Œé”çš„é‡Šæ”¾ï¼Œç»™å…¶å®ƒçº¿ç¨‹æœºä¼šæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œåœ¨HotSpotä¸­ï¼Œé€šè¿‡é€€å‡º<code>monitor</code>çš„æ–¹å¼å®ç°é”çš„é‡Šæ”¾ï¼Œå¹¶é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå…·ä½“å®ç°ä½äº<code>ObjectMonitor</code>çš„<code>exit</code>æ–¹æ³•ä¸­ã€‚(ä½äºï¼š<code>src/share/vm/runtime/objectMonitor.cpp</code>)ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol><li>é€€å‡ºåŒæ­¥ä»£ç å—æ—¶ä¼šè®©<code>recursions</code>å‡1ï¼Œå½“<code>recursions</code>çš„å€¼å‡ä¸º0æ—¶ï¼Œè¯´æ˜çº¿ç¨‹é‡Šæ”¾äº†é”ã€‚</li><li>æ ¹æ®ä¸åŒçš„ç­–ç•¥(ç”±<code>QMode</code>æŒ‡å®š)ï¼Œä»<code>cxq</code>æˆ– <code>EntryList</code> ä¸­è·å–å¤´èŠ‚ç‚¹ï¼Œé€šè¿‡<code>ObjectMonitor::ExitEpilog</code>æ–¹æ³•å”¤é†’è¯¥èŠ‚ç‚¹å°è£…çš„çº¿ç¨‹ï¼Œå”¤é†’æ“ä½œæœ€ç»ˆç”±<code>unpark</code>å®Œæˆï¼Œå®ç°å¦‚ä¸‹ï¼š è¢«å”¤é†’çš„çº¿ç¨‹ï¼Œä¼šå›åˆ°<code>void ATTR ObjectMonitor::EnterI (TRAPS)</code>çš„ç¬¬600è¡Œï¼Œç»§ç»­æ‰§è¡Œ<code>monitor</code>çš„ç«äº‰ã€‚</li></ol><h3 id="monitoræ˜¯é‡é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#monitoræ˜¯é‡é‡çº§é”" aria-hidden="true">#</a> monitoræ˜¯é‡é‡çº§é”</h3><p>å¯ä»¥çœ‹åˆ° ObjectMonitor çš„å‡½æ•°è°ƒç”¨ä¸­ä¼šæ¶‰åŠåˆ° <code>Atomic::cmpxchg_ptr</code>ï¼Œ<code>Atomic::inc_ptr</code>ç­‰å†…æ ¸å‡½æ•°ï¼Œ æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œæ²¡æœ‰ç«äº‰åˆ°é”çš„å¯¹è±¡ä¼š<code>park()</code>è¢«æŒ‚èµ·ï¼Œç«äº‰åˆ°é”çš„çº¿ç¨‹ä¼š<code>unpark()</code>å”¤é†’ã€‚</p><p>è¿™ä¸ªæ—¶å€™å°±ä¼šå­˜åœ¨æ“ä½œç³»ç»Ÿç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢ï¼Œè¿™ç§åˆ‡æ¢ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚ æ‰€ä»¥synchronizedæ˜¯ Java è¯­ è¨€ä¸­æ˜¯ä¸€ä¸ªé‡é‡çº§(Heavyweight)çš„æ“ä½œã€‚</p><h4 id="ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€" aria-hidden="true">#</a> ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€</h4><p>Linux ç³»ç»Ÿçš„ä½“ç³»æ¶æ„</p><p><img src="/blog/assets/synchronized-principle-analysis-and-optimization-1649899349761.4ee41ada.png" alt="ç”¨æˆ·æ€å’Œå†…æ ¸æ€" loading="lazy"></p><p>1.æ“ä½œç³»ç»Ÿéœ€è¦ä¸¤ç§CPUçŠ¶æ€</p><ul><li>å†…æ ¸æ€ï¼ˆKernel Modeï¼‰ï¼šè¿è¡Œæ“ä½œç³»ç»Ÿç¨‹åºï¼Œæ“ä½œç¡¬ä»¶</li><li>ç”¨æˆ·æ€ï¼ˆUser Modeï¼‰ï¼šè¿è¡Œç”¨æˆ·ç¨‹åº</li></ul><p>å½“ç¨‹åºè¿è¡Œåœ¨3çº§ç‰¹æƒçº§ä¸Šæ—¶ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºè¿è¡Œåœ¨ç”¨æˆ·æ€ã€‚å› ä¸ºè¿™æ˜¯æœ€ä½ç‰¹æƒçº§ï¼Œæ˜¯æ™®é€šçš„ç”¨æˆ·è¿›ç¨‹è¿è¡Œçš„ç‰¹æƒçº§ï¼Œå¤§éƒ¨åˆ†ç”¨æˆ·ç›´æ¥é¢å¯¹çš„ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼›</p><p>å½“ç¨‹åºè¿è¡Œåœ¨0çº§ç‰¹æƒçº§ä¸Šæ—¶ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºè¿è¡Œåœ¨å†…æ ¸æ€ã€‚</p><p>è¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºä¸èƒ½ç›´æ¥è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸æ•°æ®ç»“æ„å’Œç¨‹åºã€‚å½“æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­æ‰§è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æ˜¯è¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ï¼Œåœ¨å…¶éœ€è¦æ“ä½œç³»ç»Ÿå¸®åŠ©å®ŒæˆæŸäº›å®ƒæ²¡æœ‰æƒåŠ›å’Œèƒ½åŠ›å®Œæˆçš„å·¥ä½œæ—¶å°±ä¼šåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ˆæ¯”å¦‚æ“ä½œç¡¬ä»¶ï¼‰ã€‚</p><p>è¿™ä¸¤ç§çŠ¶æ€çš„ä¸»è¦å·®åˆ«æ˜¯</p><ul><li>å¤„äºç”¨æˆ·æ€æ‰§è¡Œæ—¶ï¼Œè¿›ç¨‹æ‰€èƒ½è®¿é—®çš„å†…å­˜ç©ºé—´å’Œå¯¹è±¡å—åˆ°é™åˆ¶ï¼Œå…¶<strong>æ‰€å¤„äºå æœ‰çš„å¤„ç†å™¨æ˜¯å¯è¢«æŠ¢å çš„</strong></li><li>å¤„äºå†…æ ¸æ€æ‰§è¡Œæ—¶ï¼Œåˆ™èƒ½è®¿é—®æ‰€æœ‰çš„å†…å­˜ç©ºé—´å’Œå¯¹è±¡ï¼Œä¸”<strong>æ‰€å æœ‰çš„å¤„ç†å™¨æ˜¯ä¸å…è®¸è¢«æŠ¢å </strong>çš„ã€‚</li></ul><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒLinuxæ“ä½œç³»ç»Ÿçš„ä½“ç³»æ¶æ„åˆ†ä¸ºï¼šç”¨æˆ·ç©ºé—´(åº”ç”¨ç¨‹åºçš„æ´»åŠ¨ç©ºé—´)å’Œå†…æ ¸ã€‚å†…æ ¸ï¼šæœ¬è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºä¸€ç§è½¯ä»¶ï¼Œæ§åˆ¶è®¡ç®—æœºçš„ç¡¬ä»¶èµ„æºï¼Œå¹¶æä¾›ä¸Šå±‚åº”ç”¨ç¨‹åºè¿è¡Œçš„ç¯å¢ƒã€‚</p><p>ç”¨æˆ·ç©ºé—´ï¼šä¸Šå±‚åº”ç”¨ç¨‹åºæ´»åŠ¨çš„ç©ºé—´ã€‚åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¿…é¡»ä¾æ‰˜äºå†…æ ¸æä¾›çš„èµ„æºï¼ŒåŒ…æ‹¬CPUèµ„æºã€å­˜å‚¨èµ„æºã€I/Oèµ„æºç­‰ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨ï¼šä¸ºäº†ä½¿ä¸Šå±‚åº”ç”¨èƒ½å¤Ÿè®¿é—®åˆ°è¿™äº›èµ„æºï¼Œå†…æ ¸å¿…é¡»ä¸ºä¸Šå±‚åº”ç”¨æä¾›è®¿é—®çš„æ¥å£ï¼šå³ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æ‰€æœ‰è¿›ç¨‹åˆå§‹éƒ½è¿è¡Œäºç”¨æˆ·ç©ºé—´ï¼Œæ­¤æ—¶å³ä¸ºç”¨æˆ·è¿è¡ŒçŠ¶æ€(ç®€ç§°ï¼šç”¨æˆ·æ€)ï¼›ä½†æ˜¯å½“å®ƒè°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¾‹å¦‚I/Oè°ƒç”¨ï¼Œæ­¤æ—¶éœ€è¦é™·å…¥å†…æ ¸ä¸­è¿è¡Œï¼Œæˆ‘ä»¬å°±ç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆæˆ–ç®€ç§°ä¸ºå†…æ ¸æ€ï¼‰ã€‚ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š</p><ol><li>ç”¨æˆ·æ€ç¨‹åºå°†ä¸€äº›æ•°æ®å€¼æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…ä½¿ç”¨å‚æ•°åˆ›å»ºä¸€ä¸ªå †æ ˆï¼Œä»¥æ­¤è¡¨æ˜éœ€è¦æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ã€‚</li><li>ç”¨æˆ·æ€ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</li><li>CPUåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå¹¶è·³åˆ°ä½äºå†…å­˜æŒ‡å®šä½ç½®çš„æŒ‡ä»¤ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨å¤„ç†å™¨(<code>systemcallhandler</code>)ä¼šè¯»å–ç¨‹åºæ”¾å…¥å†…å­˜çš„æ•°æ®å‚æ•°ï¼Œå¹¶æ‰§è¡Œç¨‹åºè¯·æ±‚çš„æœåŠ¡ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨å®Œæˆåï¼Œæ“ä½œç³»ç»Ÿä¼šé‡ç½®<code>CPU</code>ä¸ºç”¨æˆ·æ€å¹¶è¿”å›ç³»ç»Ÿè°ƒç”¨çš„ç»“æœã€‚</li></ol><p>ç”±æ­¤å¯è§ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€éœ€è¦ä¼ é€’è®¸å¤šå˜é‡ï¼ŒåŒæ—¶å†…æ ¸è¿˜éœ€è¦ä¿æŠ¤å¥½ç”¨æˆ·æ€åœ¨åˆ‡æ¢æ—¶çš„ä¸€äº›å¯„å­˜å™¨å€¼ã€å˜é‡ç­‰ï¼Œä»¥å¤‡å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚è¿™ç§åˆ‡æ¢å°±å¸¦æ¥äº†å¤§é‡çš„ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œè¿™å°±æ˜¯åœ¨ <code>synchronized</code>æœªä¼˜åŒ–ä¹‹å‰ï¼Œæ•ˆç‡ä½çš„åŸå› ã€‚</p><h2 id="å…­ã€jdk6-synchronizedä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å…­ã€jdk6-synchronizedä¼˜åŒ–" aria-hidden="true">#</a> å…­ã€JDK6 synchronizedä¼˜åŒ–</h2><p>CASçš„å…¨æˆæ˜¯ï¼šCompareAndSwap(æ¯”è¾ƒç›¸åŒå†äº¤æ¢)ã€‚æ˜¯ç°ä»£CPUå¹¿æ³›æ”¯æŒçš„ä¸€ç§å¯¹å†…å­˜ä¸­çš„å…±äº«æ•°æ®è¿›è¡Œæ“ä½œçš„ä¸€ç§ç‰¹æ®ŠæŒ‡ä»¤ã€‚</p><p>CASçš„ä½œç”¨ï¼šCASå¯ä»¥å°†æ¯”è¾ƒå’Œäº¤æ¢è½¬æ¢ä¸ºåŸå­æ“ä½œï¼Œè¿™ä¸ªåŸå­æ“ä½œç›´æ¥ç”±CPUä¿è¯ã€‚CASå¯ä»¥ä¿è¯å…±äº«å˜é‡èµ‹å€¼æ—¶çš„åŸå­æ“ä½œã€‚</p><p>CASæ“ä½œä¾èµ–3ä¸ªå€¼ï¼šå†…å­˜ä¸­çš„å€¼Vï¼Œæ—§çš„é¢„ä¼°å€¼Xï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bï¼Œå¦‚æœæ—§çš„é¢„ä¼°å€¼Xç­‰äºå†…å­˜ä¸­çš„å€¼Vï¼Œå°±å°†æ–°çš„å€¼Bä¿å­˜åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="caså’Œvolatileå®ç°æ— é”å¹¶å‘" tabindex="-1"><a class="header-anchor" href="#caså’Œvolatileå®ç°æ— é”å¹¶å‘" aria-hidden="true">#</a> CASå’Œvolatileå®ç°æ— é”å¹¶å‘</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runnable</span> mr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="casåŸç†" tabindex="-1"><a class="header-anchor" href="#casåŸç†" aria-hidden="true">#</a> CASåŸç†</h3><p>é€šè¿‡åˆšæ‰<code>AtomicInteger</code>çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>Unsafe</code>ç±»æä¾›äº†åŸå­æ“ä½œã€‚</p><p>Unsafe ç±»ä½¿<code>Java</code>æ‹¥æœ‰äº†åƒCè¯­è¨€çš„æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†æŒ‡é’ˆçš„é—®é¢˜ã€‚è¿‡åº¦çš„ä½¿ç”¨<code>Unsafe</code>ç±»ä¼šä½¿å¾—å‡ºé”™çš„å‡ ç‡å˜å¤§ï¼Œå› æ­¤Javaå®˜æ–¹å¹¶ä¸å»ºè®®ä½¿ç”¨çš„ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿå‡ ä¹æ²¡æœ‰ã€‚Unsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—ã€‚</p><p><img src="/blog/assets/6-1-1.7e9ec5bb.png" alt="Unsafe" loading="lazy"></p><h4 id="unsafeå®ç°cas" tabindex="-1"><a class="header-anchor" href="#unsafeå®ç°cas" aria-hidden="true">#</a> Unsafeå®ç°CAS</h4><p><img src="/blog/assets/synchronized-principle-analysis-and-optimization-1649899407190.886e96f8.png" alt="Unsafeå®ç°CAS" loading="lazy"></p><h4 id="ä¹è§‚é”å’Œæ‚²è§‚é”" tabindex="-1"><a class="header-anchor" href="#ä¹è§‚é”å’Œæ‚²è§‚é”" aria-hidden="true">#</a> ä¹è§‚é”å’Œæ‚²è§‚é”</h4><p>æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ã€‚å› æ­¤<code>synchronized</code>æˆ‘ä»¬ä¹Ÿå°†å…¶ç§°ä¹‹ä¸ºæ‚²è§‚é”ã€‚JDKä¸­çš„ <code>ReentrantLock</code>ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ã€‚æ€§èƒ½è¾ƒå·®ï¼</p><p>ä¹è§‚é”ä»ä¹è§‚çš„è§’åº¦å‡ºå‘: æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œå†é‡è¯•å³å¯ã€‚æ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»ä¿®æ”¹è¿™ä¸ªæ•°æ®ï¼Œå¦‚ä½•æ²¡æœ‰äººä¿®æ”¹åˆ™æ›´æ–°ï¼Œå¦‚æœæœ‰äººä¿®æ”¹åˆ™é‡è¯•ã€‚CASè¿™ç§æœºåˆ¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶ç§°ä¹‹ä¸ºä¹è§‚é”ã€‚ç»¼åˆæ€§èƒ½è¾ƒå¥½ï¼</p><p>CASè·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨<code>volatile</code>ä¿®é¥°ã€‚ç»“åˆCASå’Œvolatileå¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸CPUçš„åœºæ™¯ä¸‹ã€‚</p><ol><li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€ã€‚</li><li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“ã€‚</li></ol><div class="custom-container tip"><p class="custom-container-title">æ€»ç»“ CAS å¯ä»¥å°†æ¯”è¾ƒå’Œäº¤æ¢è½¬æ¢ä¸ºåŸå­æ“ä½œï¼Œè¿™ä¸ªåŸå­æ“ä½œç›´æ¥ç”±å¤„ç†å™¨ä¿è¯ã€‚</p><p>CASéœ€è¦3ä¸ªå€¼:å†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bï¼Œå¦‚æœå†…å­˜åœ°å€Vå’Œæ—§çš„é¢„æœŸå€¼Aç›¸ç­‰å°±ä¿®æ”¹å†…å­˜åœ°å€å€¼ä¸ºB</p></div><h2 id="synchronized-é”å‡çº§è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#synchronized-é”å‡çº§è¿‡ç¨‹" aria-hidden="true">#</a> synchronized é”å‡çº§è¿‡ç¨‹</h2><p>é«˜æ•ˆå¹¶å‘æ˜¯ä» JDK 5 åˆ° JDK 6 çš„ä¸€ä¸ªé‡è¦æ”¹è¿›ï¼Œ<code>HotSpot</code>è™›æ‹Ÿæœºå¼€å‘å›¢é˜Ÿåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸ŠèŠ±è´¹äº†å¤§é‡çš„ç²¾åŠ› å»å®ç°å„ç§é”ä¼˜åŒ–æŠ€æœ¯ï¼ŒåŒ…æ‹¬åå‘é”( Biased Locking )ã€è½»é‡çº§é”(<code>Lightweight Locking</code>)å’Œå¦‚é€‚åº”æ€§ è‡ªæ—‹(<code>Adaptive Spinning</code>)ã€é”æ¶ˆé™¤(<code>Lock Elimination</code>)ã€é”ç²—åŒ–(<code>Lock Coarsening</code>)ç­‰ï¼Œè¿™äº›æŠ€æœ¯éƒ½æ˜¯ä¸º äº†åœ¨çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œä»¥åŠè§£å†³ç«äº‰é—®é¢˜ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><!--[--><div class="flowchart-loading-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="loading-icon" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="0s"/><animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="0s"/></circle><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="-0.3333333333333333s"/><animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="-0.3333333333333333s"/></circle><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="-0.6666666666666666s"/><animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="-0.6666666666666666s"/></circle></svg></div><div class="flowchart-wrapper vue" id="flowchart-64a542a6" style="display:none;"></div><!--]--><h2 id="javaå¯¹è±¡çš„å¸ƒå±€" tabindex="-1"><a class="header-anchor" href="#javaå¯¹è±¡çš„å¸ƒå±€" aria-hidden="true">#</a> Javaå¯¹è±¡çš„å¸ƒå±€</h2><p>åœ¨ JVM ä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/blog/assets/6-3-1.ce0e9cb1.png" alt="å¯¹è±¡çš„å¸ƒå±€" loading="lazy"></p><h3 id="å¯¹è±¡å¤´" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡å¤´" aria-hidden="true">#</a> å¯¹è±¡å¤´</h3><p>å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è®¿é—®<code>synchronized</code>ä¿®é¥°çš„ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆè¦è·å¾—é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”åˆ°åº•å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ æ˜¯å­˜åœ¨é”å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­çš„ã€‚</p><p>HotSpoté‡‡ç”¨<code>instanceOopDesc</code>å’Œ<code>arrayOopDesc</code>æ¥æè¿°å¯¹è±¡å¤´ï¼Œ<code>arrayOopDesc</code>å¯¹è±¡ç”¨æ¥æè¿°æ•°ç»„ç±»å‹ã€‚<code>InstanceOopDesc</code>çš„å®šä¹‰çš„åœ¨<code>Hotspot</code>æºç çš„<code>instanceOop.hpp</code>æ–‡ä»¶ä¸­ï¼Œå¦å¤–ï¼Œ<code>arrayOopDesc</code>çš„å®šä¹‰å¯¹åº”<code>arrayOop.hpp</code>ã€‚</p><p>ä»<code>instanceOopDesc</code>ä»£ç ä¸­å¯ä»¥çœ‹åˆ°<code>instanceOopDesc</code>ç»§æ‰¿è‡ª<code>oopDesc</code>ï¼Œ<code>oopDesc</code>çš„å®šä¹‰è½½<code>Hotspot</code>æºç ä¸­çš„<code>oop.hpp</code>æ–‡ä»¶ä¸­ã€‚</p><p><img src="/blog/assets/6-3-2.eacb7404.png" alt="Javaå¯¹è±¡çš„å¸ƒå±€" loading="lazy"></p><p><code>_mark</code>è¡¨ç¤ºå¯¹è±¡æ ‡è®°ã€å±äº<code>markOop</code>ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥è¦è®²è§£çš„<code>Mark World</code>ï¼Œå®ƒè®°å½•äº†å¯¹è±¡å’Œé”æœ‰å…³çš„ä¿¡æ¯</p><p><code>_metadata</code>è¡¨ç¤ºç±»å…ƒä¿¡æ¯ï¼Œç±»å…ƒä¿¡æ¯å­˜å‚¨çš„æ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®(Klass)çš„é¦–åœ°å€ï¼Œå…¶ä¸­ Klass è¡¨ç¤º æ™®é€šæŒ‡é’ˆã€<code>_compressed_klass</code>è¡¨ç¤ºå‹ç¼©ç±»æŒ‡é’ˆã€‚</p><div class="custom-container info"><p class="custom-container-title">å°ç»“</p><p>å¯¹è±¡å¤´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œç§°ä¹‹ä¸º<code>Mark Word</code>ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯ç±»å‹æŒ‡é’ˆï¼ŒåŠå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆã€‚</p></div><h3 id="mark-word" tabindex="-1"><a class="header-anchor" href="#mark-word" aria-hidden="true">#</a> Mark Word</h3><p><code>Mark Word</code>ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç (<code>HashCode</code>)ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€ çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ç­‰ï¼Œå ç”¨å†…å­˜å¤§å°ä¸è™šæ‹Ÿæœºä½é•¿ä¸€è‡´ã€‚Mark Word å¯¹åº”çš„ç±»å‹æ˜¯<code>markOop</code>ã€‚æºç ä½äº<code>markOop.hpp</code>ä¸­ã€‚</p><p><img src="/blog/assets/6-3-3.3387c6e1.png" alt="64ä½è™šæ‹Ÿæœºä¸‹Mark Word" loading="lazy"></p><p>åœ¨64ä½è™šæ‹Ÿæœºä¸‹ï¼Œ<code>Mark Word</code>æ˜¯<code>64bit</code>å¤§å°çš„ï¼Œå…¶å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/blog/assets/6-3-4.a7f5783b.png" alt="Mark Word" loading="lazy"></p><p>åœ¨ 32ä½è™šæ‹Ÿæœºä¸‹ï¼Œ<code>Mark Word</code>æ˜¯<code>32bit</code>å¤§å°çš„ï¼Œå…¶å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/blog/assets/6-3-5.7e245bb1.png" alt="32ä½è™šæ‹ŸæœºMark Word" loading="lazy"></p><h3 id="klass-pointer" tabindex="-1"><a class="header-anchor" href="#klass-pointer" aria-hidden="true">#</a> klass pointer</h3><p>è¿™ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡çš„ç±»å‹æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®ï¼ŒJVM é€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„ å®ä¾‹ã€‚</p><p>è¯¥æŒ‡é’ˆçš„ä½é•¿åº¦ä¸ºJVM çš„ä¸€ä¸ªå­—å¤§å°ï¼Œå³32ä½çš„ JVMä¸º32ä½ï¼Œ64ä½çš„JVMä¸º64ä½ã€‚</p><p>å¦‚æœåº”ç”¨çš„å¯¹ è±¡è¿‡å¤šï¼Œä½¿ç”¨ 64 ä½çš„æŒ‡é’ˆå°†æµªè´¹å¤§é‡å†…å­˜ï¼Œç»Ÿè®¡è€Œè¨€ï¼Œ64ä½çš„JVMå°†ä¼šæ¯”32 ä½çš„ JVM å¤šè€—è´¹ 50%çš„å†… å­˜ã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜å¯ä»¥ä½¿ç”¨é€‰é¡¹ -XX:+UseCompressedOops å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œå…¶ä¸­ï¼Œoop å³ ordinary object pointer æ™®é€šå¯¹è±¡æŒ‡é’ˆã€‚å¼€å¯è¯¥é€‰é¡¹åï¼Œä¸‹åˆ—æŒ‡é’ˆå°†å‹ç¼©è‡³ 32 ä½ï¼š</p><ol><li>æ¯ä¸ª Class çš„å±æ€§æŒ‡é’ˆ(å³é™æ€å˜é‡)</li><li>æ¯ä¸ªå¯¹è±¡çš„å±æ€§æŒ‡é’ˆ(å³å¯¹è±¡å˜é‡)</li><li>æ™®é€šå¯¹è±¡æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æŒ‡é’ˆ</li></ol><p>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æŒ‡é’ˆéƒ½ä¼šå‹ç¼©ï¼Œä¸€äº›ç‰¹æ®Šç±»å‹çš„æŒ‡é’ˆ <code>JVM</code> ä¸ä¼šä¼˜åŒ–ï¼Œæ¯”å¦‚æŒ‡å‘ <code>PermGen</code> çš„ <code>Class</code>å¯¹è±¡æŒ‡é’ˆ(JDK8ä¸­æŒ‡å‘å…ƒç©ºé—´çš„<code>Class</code>å¯¹è±¡æŒ‡é’ˆ)ã€æœ¬åœ°å˜é‡ã€å †æ ˆå…ƒç´ ã€å…¥å‚ã€è¿”å›å€¼å’Œ NULL æŒ‡é’ˆç­‰ã€‚<code>å¯¹è±¡å¤´=Mark Word+ç±»å‹æŒ‡é’ˆ</code>(æœªå¼€å¯æŒ‡é’ˆå‹ç¼©çš„æƒ…å†µä¸‹)</p><ul><li><p>åœ¨32ä½ç³»ç»Ÿä¸­ï¼ŒMark Word = 4 bytesï¼Œç±»å‹æŒ‡é’ˆ = 4bytesï¼Œå¯¹è±¡å¤´ = 8 bytes = 64 bitsï¼›</p></li><li><p>åœ¨64ä½ç³»ç»Ÿä¸­ï¼ŒMark Word = 8 bytesï¼Œç±»å‹æŒ‡é’ˆ = 8bytesï¼Œå¯¹è±¡å¤´ = 16 bytes = 128bitsï¼›</p></li><li><p>å®ä¾‹æ•°æ®ï¼šç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡ï¼›</p></li><li><p>å¯¹é½å¡«å……ï¼šå¯¹é½å¡«å……å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„ä¹‰ï¼Œä»–ä»…ä»…èµ·ç€å ä½ç¬¦çš„ä½œç”¨ï¼›</p></li></ul><p>ç”±äº<code>HotSpot-VM</code>çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚è€Œå¯¹è±¡å¤´æ­£å¥½æ˜¯8å­—èŠ‚çš„å€æ•°ï¼Œå› æ­¤ï¼Œå½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½æ—¶ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨ã€‚</p><h3 id="æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" aria-hidden="true">#</a> æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Javaå¯¹è±¡ç”±3éƒ¨åˆ†ç»„æˆï¼šå¯¹è±¡å¤´ï¼Œå®ä¾‹æ•°æ®ï¼Œå¯¹é½æ•°æ®ã€‚å¯¹è±¡å¤´åˆ†æˆä¸¤éƒ¨åˆ†ï¼š<code>Mark World</code> + <code>Klass pointer</code></p><h3 id="ä»€ä¹ˆæ˜¯åå‘é”" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯åå‘é”" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯åå‘é”</h3><p>åå‘é”æ˜¯JDK6ä¸­çš„é‡è¦å¼•è¿›ï¼Œå› ä¸ºHotSpotä½œè€…ç»è¿‡ç ”ç©¶å®è·µå‘ç°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½ï¼Œå¼•è¿›äº†åå‘é”ã€‚</p><p>åå‘é”çš„â€œåâ€ï¼Œå°±æ˜¯åå¿ƒçš„â€œåâ€ã€åè¢’çš„â€œåâ€ï¼Œå®ƒçš„æ„æ€æ˜¯è¿™ä¸ªé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹ï¼Œä¼šåœ¨å¯¹è±¡å¤´å­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶åªéœ€è¦æ£€æŸ¥æ˜¯å¦ä¸ºåå‘é”ã€é”æ ‡å¿—ä½ä»¥åŠThreadIDå³å¯ã€‚</p><p><img src="/blog/assets/6-4-1.8151c670.png" alt="åå‘é”" loading="lazy"></p><p>ä¸è¿‡ä¸€æ—¦å‡ºç°å¤šä¸ªçº¿ç¨‹ç«äº‰æ—¶å¿…é¡»æ’¤é”€åå‘é”ï¼Œæ‰€ä»¥æ’¤é”€åå‘é”æ¶ˆè€—çš„æ€§èƒ½å¿…é¡»å°äºä¹‹å‰èŠ‚çœä¸‹æ¥çš„<code>CAS</code>åŸå­æ“ä½œçš„æ€§èƒ½æ¶ˆè€—ï¼Œä¸ç„¶å°±å¾—ä¸å¿å¤±äº†ã€‚</p><h3 id="åå‘é”åŸç†" tabindex="-1"><a class="header-anchor" href="#åå‘é”åŸç†" aria-hidden="true">#</a> åå‘é”åŸç†</h3><p>å½“çº¿ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®åŒæ­¥å—å¹¶è·å–é”æ—¶ï¼Œåå‘é”å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼Œå³åå‘æ¨¡å¼ã€‚</li><li>åŒæ—¶ä½¿ç”¨<code>CAS</code>æ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„IDè®°å½•åœ¨å¯¹è±¡çš„<code>Mark Word</code>ä¹‹ä¸­ ï¼Œå¦‚æœ<code>CAS</code>æ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é”çš„æ•ˆç‡é«˜ã€‚</li></ol><p><img src="/blog/assets/6-4-2.de50a179.png" alt="" loading="lazy"></p><p>æŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é”çš„æ•ˆç‡é«˜ã€‚</p><h3 id="åå‘é”çš„æ’¤é”€" tabindex="-1"><a class="header-anchor" href="#åå‘é”çš„æ’¤é”€" aria-hidden="true">#</a> åå‘é”çš„æ’¤é”€</h3><ol><li>åå‘é”çš„æ’¤é”€åŠ¨ä½œå¿…é¡»ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹</li><li>æš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€</li><li>æ’¤é”€åå‘é”ï¼Œæ¢å¤åˆ°æ— é”(æ ‡å¿—ä½ä¸º01)æˆ–è½»é‡çº§é”(æ ‡å¿—ä½ä¸º00)çš„çŠ¶æ€</li></ol><p>åå‘é”åœ¨ Java6ä¹‹åæ˜¯é»˜è®¤å¯ç”¨çš„ï¼Œä½†åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‡ ç§’é’Ÿä¹‹åæ‰æ¿€æ´»ï¼Œå¯ä»¥ä½¿ç”¨ -</p><p><code>XX:BiasedLockingStartupDelay=0</code>å‚æ•°å…³é—­å»¶è¿Ÿï¼Œå¦‚æœç¡®å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰é”é€šå¸¸æƒ…å†µä¸‹å¤„äºç«äº‰ çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ <code>XX:-UseBiasedLocking=false</code> å‚æ•°å…³é—­åå‘é”ã€‚</p><h3 id="åå‘é”å¥½å¤„" tabindex="-1"><a class="header-anchor" href="#åå‘é”å¥½å¤„" aria-hidden="true">#</a> åå‘é”å¥½å¤„</h3><p>åå‘é”æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºä¸€ä¸ªçº¿ç¨‹åå¤è·å¾—åŒä¸€é”çš„æƒ…å†µã€‚åå‘é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚ å®ƒåŒæ ·æ˜¯ä¸€ä¸ªå¸¦æœ‰æ•ˆç›Šæƒè¡¡æ€§è´¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¹¶ä¸ä¸€å®šæ€»æ˜¯å¯¹ç¨‹åºè¿è¡Œæœ‰åˆ©ï¼Œå¦‚æœç¨‹åºä¸­å¤§å¤šæ•°çš„é”æ€»æ˜¯è¢«å¤šä¸ªä¸åŒçš„çº¿ç¨‹è®¿é—®æ¯”å¦‚çº¿ç¨‹æ± ï¼Œé‚£åå‘æ¨¡å¼å°±æ˜¯å¤šä½™çš„ã€‚</p><p>åœ¨JDK5ä¸­åå‘é”é»˜è®¤æ˜¯å…³é—­çš„ï¼Œè€Œåˆ°äº†<code>JDK6</code>ä¸­åå‘é”å·²ç»é»˜è®¤å¼€å¯ã€‚</p><p>ä½†åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‡ ç§’é’Ÿä¹‹åæ‰æ¿€æ´»ï¼Œå¯ä»¥ä½¿ç”¨ <code>-XX:BiasedLockingStartupDelay=0</code>å‚æ•°å…³é—­å»¶è¿Ÿï¼Œå¦‚æœç¡®å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰é”é€šå¸¸ æƒ…å†µä¸‹å¤„äºç«äº‰çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡<code>XX:-UseBiasedLocking=false</code>å‚æ•°å…³é—­åå‘é”ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯è½»é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯è½»é‡çº§é”</h3><p>è½»é‡çº§é”æ˜¯JDK6ä¹‹ä¸­åŠ å…¥çš„æ–°å‹é”æœºåˆ¶ï¼Œå®ƒåå­—ä¸­çš„â€œè½»é‡çº§â€æ˜¯ç›¸å¯¹äºä½¿ç”¨<code>monitor</code>çš„ä¼ ç»Ÿé”è€Œè¨€çš„ï¼Œ å› æ­¤ä¼ ç»Ÿçš„é”æœºåˆ¶å°±ç§°ä¸ºâ€œé‡é‡çº§â€é”ã€‚</p><p>é¦–å…ˆéœ€è¦å¼ºè°ƒä¸€ç‚¹çš„æ˜¯ï¼Œè½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ã€‚</p><p>å¼•å…¥è½»é‡çº§é”çš„ç›®çš„ï¼šåœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå°½é‡é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¼šå¯¼è‡´è½»é‡çº§é”è†¨èƒ€å‡çº§é‡é‡çº§é”ï¼Œæ‰€ä»¥è½»é‡çº§é”çš„å‡ºç°å¹¶éæ˜¯è¦æ›¿ä»£é‡é‡çº§é”ã€‚</p><h3 id="è½»é‡çº§é”åŸç†" tabindex="-1"><a class="header-anchor" href="#è½»é‡çº§é”åŸç†" aria-hidden="true">#</a> è½»é‡çº§é”åŸç†</h3><p>å½“å…³é—­åå‘é”åŠŸèƒ½æˆ–è€…å¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”å¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œåˆ™ä¼šå°è¯•è·å–è½»é‡çº§é”ï¼Œå…¶æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>è·å–é”å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼Œå³åå‘æ¨¡å¼ã€‚åŒæ—¶ä½¿ç”¨CASæ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„IDè®°å½•åœ¨å¯¹è±¡çš„<code>Mark Word</code>ä¹‹ä¸­ï¼Œå¦‚æœCASæ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é”çš„æ•ˆç‡é«˜ã€‚</p><p>åå‘é”æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºä¸€ä¸ªçº¿ç¨‹åå¤è·å¾—åŒä¸€é”çš„æƒ…å†µã€‚</p><p>åå‘é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚</p><ol><li>åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦å¤„äºæ— é”çŠ¶æ€(hashcodeã€0ã€01)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™JVMé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•(<code>Lock Record</code>)çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼ˆå®˜æ–¹ æŠŠè¿™ä»½æ‹·è´åŠ äº†ä¸€ä¸ª<code>Displaced</code>å‰ç¼€ï¼Œå³<code>Displaced Mark Word</code>ï¼‰ï¼Œå°†å¯¹è±¡çš„<code>Mark Word</code>å¤åˆ¶åˆ°æ ˆå¸§ä¸­çš„<code>Lock Record</code>ä¸­ï¼Œå°†<code>Lock Reocrd</code>ä¸­çš„owneræŒ‡å‘å½“å‰å¯¹è±¡ã€‚</li><li>JVMåˆ©ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„<code>Mark Word</code>æ›´æ–°ä¸ºæŒ‡å‘<code>Lock Record</code>çš„æŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸè¡¨ç¤ºç«äº‰åˆ°é”ï¼Œåˆ™å°†é”æ ‡å¿—ä½å˜æˆ<code>00</code>ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œã€‚</li><li>å¦‚æœå¤±è´¥åˆ™åˆ¤æ–­å½“å‰å¯¹è±¡çš„<code>Mark Word</code>æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰å½“å‰å¯¹è±¡çš„é”ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼›å¦åˆ™åªèƒ½è¯´æ˜è¯¥é”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ï¼Œè¿™æ—¶è½» é‡çº§é”éœ€è¦è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—ä½å˜æˆ10ï¼Œåé¢ç­‰å¾…çš„çº¿ç¨‹å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li></ol><p><img src="/blog/assets/6-5-1.f536e40e.png" alt="åå‘é”" loading="lazy"></p><p><img src="/blog/assets/6-5-2.c175ab53.png" alt="åå‘é”" loading="lazy"></p><h3 id="è½»é‡çº§é”çš„é‡Šæ”¾" tabindex="-1"><a class="header-anchor" href="#è½»é‡çº§é”çš„é‡Šæ”¾" aria-hidden="true">#</a> è½»é‡çº§é”çš„é‡Šæ”¾</h3><p>è½»é‡çº§é”çš„é‡Šæ”¾ä¹Ÿæ˜¯é€šè¿‡CASæ“ä½œæ¥è¿›è¡Œçš„ï¼Œä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>å–å‡ºåœ¨è·å–è½»é‡çº§é”ä¿å­˜åœ¨<code>Displaced Mark Word</code>ä¸­çš„æ•°æ®ã€‚</li><li>ç”¨CASæ“ä½œå°†å–å‡ºçš„æ•°æ®æ›¿æ¢å½“å‰å¯¹è±¡çš„<code>Mark Word</code>ä¸­ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¯´æ˜é‡Šæ”¾é”æˆåŠŸã€‚</li><li>å¦‚æœCASæ“ä½œæ›¿æ¢å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥é”ï¼Œåˆ™éœ€è¦å°†è½»é‡çº§é”éœ€è¦è†¨èƒ€å‡çº§ä¸ºé‡é‡çº§ é”ã€‚</li></ol><p>å¯¹äºè½»é‡çº§é”ï¼Œå…¶æ€§èƒ½æå‡çš„ä¾æ®æ˜¯â€œå¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…éƒ½æ˜¯ä¸ä¼šå­˜åœ¨ç«äº‰çš„â€ï¼Œå¦‚æœæ‰“ç ´è¿™ä¸ªä¾æ®åˆ™é™¤äº†äº’æ–¥çš„å¼€é”€å¤–ï¼Œè¿˜æœ‰é¢å¤–çš„<code>CAS</code>æ“ä½œï¼Œå› æ­¤åœ¨æœ‰å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é”æ¯”é‡é‡çº§é”æ›´æ…¢ã€‚</p><h3 id="è½»é‡çº§é”å¥½å¤„" tabindex="-1"><a class="header-anchor" href="#è½»é‡çº§é”å¥½å¤„" aria-hidden="true">#</a> è½»é‡çº§é”å¥½å¤„</h3><p>åœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ã€‚å°†å¯¹è±¡çš„<code>Mark Word</code>å¤åˆ¶åˆ°æ ˆå¸§ä¸­çš„<code>Lock Recod</code>ä¸­ã€‚<code>Mark Word</code>æ›´æ–°ä¸ºæŒ‡å‘<code>Lock Record</code>çš„æŒ‡é’ˆã€‚åœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ã€‚</p><h2 id="è‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#è‡ªæ—‹é”" aria-hidden="true">#</a> è‡ªæ—‹é”</h2><p><code>monitor</code>å®ç°é”çš„æ—¶å€™ï¼ŒçŸ¥é“<code>monitor</code>ä¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œçº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’éœ€è¦<code>CPU</code>ä»ç”¨æˆ·æ€è½¬ä¸ºæ ¸å¿ƒæ€ï¼Œé¢‘ç¹çš„é˜»å¡å’Œå”¤é†’å¯¹<code>CPU</code>æ¥è¯´æ˜¯ä¸€ä»¶è´Ÿæ‹…å¾ˆé‡çš„å·¥ä½œï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚</p><p>åŒæ—¶ï¼Œè™šæ‹Ÿæœºçš„å¼€å‘å›¢é˜Ÿä¹Ÿæ³¨æ„åˆ°åœ¨è®¸å¤šåº”ç”¨ä¸Šï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´é˜»å¡å’Œå”¤é†’çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœç‰©ç†æœºå™¨æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å¤„ç†å™¨ï¼Œèƒ½è®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶å¹¶è¡Œæ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©åé¢è¯·æ±‚é”çš„é‚£ä¸ªçº¿ç¨‹â€œç¨ç­‰ä¸€ä¸‹â€ï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚</p><p>ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šåœ¨åŸåœ°å¾ªç¯ç­‰å¾…ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“çš„è‡ªæ—‹é”ã€‚è‡ªæ—‹é”åœ¨<code>JDK1.4.2</code>ä¸­å°±å·²ç»å¼•å…¥ï¼Œåªä¸è¿‡é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥ä½¿ç”¨<code>-XX:+UseSpinning</code>å‚æ•°æ¥å¼€å¯ï¼Œåœ¨<code>JDK6</code>ä¸­å°±å·²ç»æ”¹ä¸ºé»˜è®¤å¼€å¯äº†ã€‚</p><p>è‡ªæ—‹ç­‰å¾…ä¸èƒ½ä»£æ›¿é˜»å¡ï¼Œä¸”å…ˆä¸è¯´å¯¹å¤„ç†å™¨æ•°é‡çš„è¦æ±‚ï¼Œè‡ªæ—‹ç­‰å¾…æœ¬èº«è™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å®ƒæ˜¯è¦å ç”¨å¤„ç†å™¨æ—¶é—´çš„ï¼Œå› æ­¤ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œåä¹‹ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆé•¿ã€‚</p><p>é‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šç™½ç™½æ¶ˆè€—å¤„ç†å™¨èµ„æºï¼Œè€Œä¸ä¼šåšä»»ä½•æœ‰ç”¨çš„å·¥ä½œï¼Œåè€Œä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚å› æ­¤ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”å½“ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ã€‚</p><p>è‡ªæ—‹æ¬¡æ•°çš„é»˜è®¤å€¼æ˜¯10æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°<code>-XX:PreBlockSpin</code>æ¥æ›´æ”¹ã€‚</p><h3 id="é€‚åº”æ€§è‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#é€‚åº”æ€§è‡ªæ—‹é”" aria-hidden="true">#</a> é€‚åº”æ€§è‡ªæ—‹é”</h3><p>åœ¨<code>JDK6</code>ä¸­å¼•å…¥äº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ã€‚è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒ ç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ï¼Œæ¯”å¦‚100æ¬¡å¾ªç¯ã€‚å¦å¤–ï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åè¦è·å– è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œå’Œæ€§èƒ½ç›‘æ§ ä¿¡æ¯çš„ä¸æ–­å®Œå–„ï¼Œè™šæ‹Ÿæœºå¯¹ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œè™›æ‹Ÿæœºå°±ä¼šå˜å¾—è¶Šæ¥è¶Šâ€œèªæ˜â€äº†ã€‚</p><h2 id="é”æ¶ˆé™¤" tabindex="-1"><a class="header-anchor" href="#é”æ¶ˆé™¤" aria-hidden="true">#</a> é”æ¶ˆé™¤</h2><p>é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨(<code>JIT</code>)åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p><p>é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åœ¨ä¸€æ®µä»£ç ä¸­ï¼Œ å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬å½“åšæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬ æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶å°±æ— é¡»è¿›è¡Œã€‚å˜é‡æ˜¯å¦é€ƒé€¸ï¼Œå¯¹äºè™šæ‹Ÿæœºæ¥è¯´éœ€è¦ä½¿ç”¨æ•°æ®æµåˆ†ææ¥ç¡®å®šï¼Œä½†æ˜¯ç¨‹åºå‘˜è‡ªå·±åº”è¯¥æ˜¯å¾ˆæ¸…æ¥šçš„ï¼Œæ€ä¹ˆä¼šåœ¨æ˜çŸ¥é“ä¸å­˜åœ¨æ•°æ®äº‰ç”¨çš„æƒ…å†µä¸‹è¦æ±‚åŒæ­¥å‘¢?</p><p>å®é™…ä¸Šæœ‰è®¸å¤šåŒæ­¥æªæ–½å¹¶ä¸æ˜¯ç¨‹åºå‘˜è‡ªå·±åŠ å…¥çš„ï¼ŒåŒæ­¥çš„ä»£ç åœ¨Javaç¨‹åºä¸­çš„æ™®éç¨‹åº¦ä¹Ÿè®¸è¶…è¿‡äº†å¤§éƒ¨åˆ†è¯»è€…çš„ æƒ³è±¡ã€‚ä¸‹é¢è¿™æ®µéå¸¸ç®€å•çš„ä»£ç ä»…ä»…æ˜¯è¾“å‡º3ä¸ªå­—ç¬¦ä¸²ç›¸åŠ çš„ç»“æœï¼Œæ— è®ºæ˜¯æºç å­—é¢ä¸Šè¿˜æ˜¯ç¨‹åºè¯­ä¹‰ä¸Šéƒ½æ²¡æœ‰åŒæ­¥ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">contactString</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">contactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">,</span> <span class="token class-name">String</span> s2<span class="token punctuation">,</span> <span class="token class-name">String</span> s3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>StringBuffer</code>çš„<code>append ()</code> æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œé”å°±æ˜¯<code>this</code>ä¹Ÿå°±æ˜¯<code>new StringBuilder()</code>ã€‚</p><p>è™šæ‹Ÿæœºå‘ç°å®ƒçš„ åŠ¨æ€ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨<code>concatString()</code>æ–¹æ³•å†…éƒ¨ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´, <code>new StringBuilder()</code>å¯¹è±¡çš„å¼•ç”¨æ°¸è¿œä¸ä¼šâ€œé€ƒé€¸â€åˆ°<code>concatString()</code>æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å®ƒï¼Œå› æ­¤ï¼Œè™½ç„¶è¿™é‡Œæœ‰é”ï¼Œä½†æ˜¯å¯ä»¥è¢«å®‰å…¨åœ°æ¶ˆé™¤5æ‰ï¼Œåœ¨å³æ—¶ç¼–è¯‘ä¹‹åï¼Œè¿™æ®µä»£ç å°±ä¼šå¿½ç•¥æ‰æ‰€æœ‰çš„åŒæ­¥è€Œç›´æ¥æ‰§è¡Œäº†ã€‚</p><h2 id="é”ç²—åŒ–" tabindex="-1"><a class="header-anchor" href="#é”ç²—åŒ–" aria-hidden="true">#</a> é”ç²—åŒ–</h2><p>å°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°ï¼Œåªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°ï¼Œå¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé‚£ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿèƒ½å°½å¿«æ‹¿åˆ°é”ã€‚</p><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„åŸåˆ™éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ï¼Œé¢‘ç¹åœ°è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>JVM</code>ä¼šæ¢æµ‹åˆ°ä¸€è¿ä¸²ç»†å°çš„æ“ä½œéƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†åŒæ­¥ä»£ç å—çš„èŒƒå›´æ”¾å¤§ï¼Œæ”¾åˆ°è¿™ä¸²æ“ä½œçš„å¤–é¢ï¼Œè¿™æ ·åªéœ€è¦åŠ ä¸€æ¬¡é”å³å¯ã€‚</p><h2 id="å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" aria-hidden="true">#</a> å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–</h2><p>å‡å°‘synchronizedçš„èŒƒå›´ï¼šåŒæ­¥ä»£ç å—ä¸­å°½é‡çŸ­ï¼Œå‡å°‘åŒæ­¥ä»£ç å—ä¸­ä»£ç çš„æ‰§è¡Œæ—¶é—´ï¼Œå‡å°‘é”çš„ç«äº‰ï¼›</p><p>é™ä½synchronizedé”çš„ç²’åº¦ï¼šå°†ä¸€ä¸ªé”æ‹†åˆ†ä¸ºå¤šä¸ªé”æé«˜å¹¶å‘åº¦ï¼›</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Hashtable</span> hs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;xx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/blog/assets/6-9-1.1bf8072d.png" alt="å…ƒç´ ä¸Šé”" loading="lazy"></p><p><img src="/blog/assets/6-9-2.93469094.png" alt="å…ƒç´ ä¸Šé”" loading="lazy"></p><p><img src="/blog/assets/6-9-3.9bcd1310.png" alt="å…ƒç´ ä¸Šé”" loading="lazy"></p><p><code>LinkedBlockingQueue</code> å…¥é˜Ÿå’Œå‡ºé˜Ÿä½¿ç”¨ä¸åŒçš„é”ï¼Œç›¸å¯¹äºè¯»å†™åªæœ‰ä¸€ä¸ªé”æ•ˆç‡è¦é«˜</p><p><img src="/blog/assets/6-9-4.a6cd1fad.png" alt="å…ƒç´ ä¸Šé”" loading="lazy"></p><h3 id="è¯»å†™åˆ†ç¦»" tabindex="-1"><a class="header-anchor" href="#è¯»å†™åˆ†ç¦»" aria-hidden="true">#</a> è¯»å†™åˆ†ç¦»</h3><p>è¯»å–æ—¶ä¸åŠ é”ï¼Œå†™å…¥å’Œåˆ é™¤æ—¶åŠ é”ï¼š<code>ConcurrentHashMap</code>ï¼Œ<code>CopyOnWriteArrayList</code> å’Œ <code>ConyOnWriteSet</code></p><p>workbench.action.openEditorAtIndex4</p><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/coderzsj/blog/edit/dev/docs/java/concurrent/synchronized-principle-analysis-and-optimization.md" rel="noopener noreferrer" target="_blank" arialabel="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/5/24 15:41:09</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 945892500@qq.com">SHIJINGSPACE</span>,<!--]--><!--[--><span class="contributor" title="email: 945892500@qq.com">zhangshijing</span><!--]--><!--]--></div></footer><nav class="page-nav"><!----><a href="/blog/java/concurrent/thread-life-cycle.html" class="nav-link next" arialabel="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ<!----></div></a></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://beian.miit.gov.cn/" target="_blank">æ™‹ICPå¤‡2021007439å·</a></div><div class="copyright">Copyright Â© 2022 shijing</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/blog/assets/app.9da19d67.js" defer></script>
  </body>
</html>
