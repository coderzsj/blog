<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>synchronized | zhangsjçš„ä¸ªäººåšå®¢</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script>var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })();</script>
    <link rel="alternate" type="application/atom+xml" href="http://www.zhangsj.xyz/blog/atom.xml" title="zhangsjçš„ä¸ªäººåšå®¢ Atom Feed">
    <link rel="alternate" type="application/json" href="http://www.zhangsj.xyz/blog/feed.json" title="zhangsjçš„ä¸ªäººåšå®¢ JSON Feed">
    <link rel="alternate" type="application/rss+xml" href="http://www.zhangsj.xyz/blog/rss.xml" title="zhangsjçš„ä¸ªäººåšå®¢ RSS Feed">
    <link rel="icon" href="/logo.svg">
    <link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials">
    <link rel="apple-touch-icon" href="/assets/icon/logo.svg">
    <meta name="description" content="Javaå­¦ä¹ ">
    <meta property="og:url" content="/blog/java/concurrent/synchronized-principle-analysis-and-optimization.html">
    <meta property="og:site_name" content="zhangsjçš„ä¸ªäººåšå®¢">
    <meta property="og:title" content="synchronized">
    <meta property="og:description" content="å¯è§æ€§ æ¦‚å¿µ å¯è§æ€§æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å…ˆç«‹å³è·å–åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚ å¯è§æ€§æ¼”ç¤º ä¸€ä¸ªçº¿ç¨‹æ ¹æ® boolean ç±»å‹çš„æ ‡è®° flagï¼Œ while å¾ªç¯ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜è¿™ä¸ª flag å˜é‡çš„å€¼ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœæ­¢å¾ªç¯ã€‚ å¤šä¸ªçº¿ç¨‹éƒ½ä¼šè®¿é—®çš„æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¸ºçº¿ç¨‹çš„å…±äº«æ•°æ®æ€»ç»“ å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼šå‡ºç°å¯è§æ€§é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œ">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh-CN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="zhangsjçš„ä¸ªäººåšå®¢">
    <meta property="article:author" content="zhangsj">
    <meta property="article:tag" content="concurrent">
    <meta property="article:published_time" content="2022-01-28T00:00:00.000Z">
    <meta name="baidu-site-verification" content="code-IZvTs9l2OK">
    <meta name="theme-color" content="#5c92d1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/assets/icon/logo.svg">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c746778c.css" as="style"><link rel="preload" href="/blog/assets/js/app.b3564ef4.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Layout.6ebf0a5a.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.207dde08.js" as="script"><link rel="preload" href="/blog/assets/js/page-synchronized.6c02a55d.js" as="script"><link rel="prefetch" href="/blog/assets/js/136.4e30e165.js"><link rel="prefetch" href="/blog/assets/js/137.6a90ab98.js"><link rel="prefetch" href="/blog/assets/js/138.61fe5fb4.js"><link rel="prefetch" href="/blog/assets/js/139.7af56254.js"><link rel="prefetch" href="/blog/assets/js/140.fbb5ada4.js"><link rel="prefetch" href="/blog/assets/js/141.c192a711.js"><link rel="prefetch" href="/blog/assets/js/142.555b021d.js"><link rel="prefetch" href="/blog/assets/js/layout-Blog.35f05fc5.js"><link rel="prefetch" href="/blog/assets/js/layout-Layout.64d6cdf7.js"><link rel="prefetch" href="/blog/assets/js/layout-NotFound.40a90269.js"><link rel="prefetch" href="/blog/assets/js/layout-Slide.85c2edb7.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.95c1812d.js"><link rel="prefetch" href="/blog/assets/js/vendors~photo-swipe.4369f3a2.js"><link rel="prefetch" href="/blog/assets/js/vendors~reveal.dcb30a7b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c746778c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.svg" alt="zhangsjçš„ä¸ªäººåšå®¢" class="logo"> <!----> <span class="site-name can-hide">zhangsjçš„ä¸ªäººåšå®¢</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">ä¸»é¢˜è‰²:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">ä¸»é¢˜æ¨¡å¼:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><i class="iconfont icon-bloghome"></i>
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont icon-blogguide"></i>
  Guide
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_43183527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icon-blogblog"></i>
  åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/SHIJINGSPACE" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icon-bloggitee"></i>
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div vocab="https://schema.org/" typeof="Person" class="blogger-info mobile"><div data-balloon-pos="" role="navigation" class="blogger"><img property="image" alt="Blogger Avatar" src="/blog/logo.svg" class="avatar round"> <div property="name" class="name">zhangsj</div> <!----></div> <div class="num-wrapper"><div><div class="num">103</div> <div>æ–‡ç« </div></div> <div><div class="num">21</div> <div>åˆ†ç±»</div></div> <div><div class="num">52</div> <div>æ ‡ç­¾</div></div> <div><div class="num">102</div> <div>æ—¶é—´è½´</div></div></div> <div class="media-links-wrapper"></div></div> <hr> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><i class="iconfont icon-bloghome"></i>
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont icon-blogguide"></i>
  Guide
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_43183527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icon-blogblog"></i>
  åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/SHIJINGSPACE" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icon-bloggitee"></i>
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/blog/java/" aria-current="page" class="sidebar-link"><i class="iconfont icon-blogmulu"></i>java</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/#javaç›®å½•" class="sidebar-link">javaç›®å½•</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogbasic"></i> <span class="title">åŸºç¡€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogredis"></i> <span class="title">ç¼“å­˜</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable open"><i class="iconfont icon-blogbingfazheng"></i> <span class="title">å¹¶å‘ç¼–ç¨‹</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/" aria-current="page" class="active sidebar-link">synchronized</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯è§æ€§" class="sidebar-link">å¯è§æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯è§æ€§æ¼”ç¤º" class="sidebar-link heading3">å¯è§æ€§æ¼”ç¤º</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åŸå­æ€§" class="sidebar-link">åŸå­æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-2" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¼”ç¤º" class="sidebar-link heading3">æ¼”ç¤º</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§" class="sidebar-link">æœ‰åºæ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§æ¦‚å¿µ" class="sidebar-link heading3">æœ‰åºæ€§æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§æ¼”ç¤º" class="sidebar-link heading3">æœ‰åºæ€§æ¼”ç¤º</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è®¡ç®—æœºç»“æ„ç®€ä»‹" class="sidebar-link heading3">è®¡ç®—æœºç»“æ„ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cpu" class="sidebar-link heading3">CPU</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å†…å­˜" class="sidebar-link heading3">å†…å­˜</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ç¼“å­˜" class="sidebar-link heading3">ç¼“å­˜</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#java-å†…å­˜æ¨¡å‹" class="sidebar-link">Java å†…å­˜æ¨¡å‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-3" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä½œç”¨" class="sidebar-link heading3">ä½œç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" class="sidebar-link heading3">CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" class="sidebar-link">ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸åŸå­æ€§" class="sidebar-link">synchronized ä¸åŸå­æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¡ˆä¾‹æ¼”ç¤º" class="sidebar-link heading3">æ¡ˆä¾‹æ¼”ç¤º</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯åŸå­æ€§çš„åŸç†" class="sidebar-link heading3">ä¿è¯åŸå­æ€§çš„åŸç†</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸å¯è§æ€§" class="sidebar-link">synchronized ä¸å¯è§æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯å¯è§æ€§" class="sidebar-link heading3">ä¿è¯å¯è§æ€§</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯å¯è§æ€§çš„åŸç†" class="sidebar-link heading3">ä¿è¯å¯è§æ€§çš„åŸç†</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸æœ‰åºæ€§" class="sidebar-link">synchronized ä¸æœ‰åºæ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸ºä»€ä¹ˆè¦é‡æ’åº" class="sidebar-link heading3">ä¸ºä»€ä¹ˆè¦é‡æ’åº</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#as-if-serial-è¯­ä¹‰" class="sidebar-link heading3">as-if-serial è¯­ä¹‰</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¡ˆä¾‹æ¼”ç¤º-2" class="sidebar-link heading3">æ¡ˆä¾‹æ¼”ç¤º</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯æœ‰åºæ€§çš„åŸç†" class="sidebar-link heading3">ä¿è¯æœ‰åºæ€§çš„åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥ç‰¹æ€§" class="sidebar-link heading3">å¯é‡å…¥ç‰¹æ€§</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥çš„å¥½å¤„" class="sidebar-link heading3">å¯é‡å…¥çš„å¥½å¤„</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥åŸç†" class="sidebar-link heading3">å¯é‡å…¥åŸç†</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸å¯ä¸­æ–­ç‰¹æ€§" class="sidebar-link">ä¸å¯ä¸­æ–­ç‰¹æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-4" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º" class="sidebar-link heading3">ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#javap-åæ±‡ç¼–" class="sidebar-link">javap åæ±‡ç¼–</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitorenter" class="sidebar-link heading3">monitorenter</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitorexit" class="sidebar-link heading3">monitorexit</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åŒæ­¥æ–¹æ³•" class="sidebar-link heading3">åŒæ­¥æ–¹æ³•</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" class="sidebar-link heading3">é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ·±å…¥-jvm-æºç " class="sidebar-link">æ·±å…¥ JVM æºç </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#jvm-æºç ä¸‹è½½" class="sidebar-link heading3">JVM æºç ä¸‹è½½</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ide-clion-ä¸‹è½½" class="sidebar-link heading3">IDE(Clion )ä¸‹è½½</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç›‘è§†å™¨é”" class="sidebar-link heading3">monitor ç›‘è§†å™¨é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç«äº‰" class="sidebar-link heading3">monitor ç«äº‰</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç­‰å¾…" class="sidebar-link heading3">monitor ç­‰å¾…</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-é‡Šæ”¾" class="sidebar-link heading3">monitor é‡Šæ”¾</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-æ˜¯é‡é‡çº§é”" class="sidebar-link heading3">monitor æ˜¯é‡é‡çº§é”</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas" class="sidebar-link">CAS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-5" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas-å’Œ-volatile-å®ç°æ— é”å¹¶å‘" class="sidebar-link heading3">CAS å’Œ volatile å®ç°æ— é”å¹¶å‘</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas-åŸç†" class="sidebar-link heading3">CAS åŸç†</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-é”å‡çº§è¿‡ç¨‹" class="sidebar-link">synchronized é”å‡çº§è¿‡ç¨‹</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#java-å¯¹è±¡çš„å¸ƒå±€" class="sidebar-link">Java å¯¹è±¡çš„å¸ƒå±€</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯¹è±¡å¤´" class="sidebar-link heading3">å¯¹è±¡å¤´</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å®ä¾‹æ•°æ®" class="sidebar-link heading3">å®ä¾‹æ•°æ®</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯¹é½å¡«å……" class="sidebar-link heading3">å¯¹é½å¡«å……</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" class="sidebar-link heading3">æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”" class="sidebar-link">åå‘é”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä»€ä¹ˆæ˜¯åå‘é”" class="sidebar-link heading3">ä»€ä¹ˆæ˜¯åå‘é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”åŸç†" class="sidebar-link heading3">åå‘é”åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”çš„æ’¤é”€" class="sidebar-link heading3">åå‘é”çš„æ’¤é”€</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”å¥½å¤„" class="sidebar-link heading3">åå‘é”å¥½å¤„</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”" class="sidebar-link">è½»é‡çº§é”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" class="sidebar-link heading3">ä»€ä¹ˆæ˜¯è½»é‡çº§é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”åŸç†" class="sidebar-link heading3">è½»é‡çº§é”åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”çš„é‡Šæ”¾" class="sidebar-link heading3">è½»é‡çº§é”çš„é‡Šæ”¾</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”å¥½å¤„" class="sidebar-link heading3">è½»é‡çº§é”å¥½å¤„</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è‡ªæ—‹é”" class="sidebar-link">è‡ªæ—‹é”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è‡ªæ—‹é”åŸç†" class="sidebar-link heading3">è‡ªæ—‹é”åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é€‚åº”æ€§è‡ªæ—‹é”" class="sidebar-link heading3">é€‚åº”æ€§è‡ªæ—‹é”</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é”æ¶ˆé™¤" class="sidebar-link">é”æ¶ˆé™¤</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é”ç²—åŒ–" class="sidebar-link">é”ç²—åŒ–</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" class="sidebar-link">å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å‡å°‘-synchronized-çš„èŒƒå›´" class="sidebar-link heading3">å‡å°‘ synchronized çš„èŒƒå›´</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é™ä½-synchronized-é”çš„ç²’åº¦" class="sidebar-link heading3">é™ä½ synchronized é”çš„ç²’åº¦</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è¯»å†™åˆ†ç¦»" class="sidebar-link heading3">è¯»å†™åˆ†ç¦»</a></li></ul></li></ul></li><li><a href="/blog/java/concurrent/thread-life-cycle/" class="sidebar-link">thread-life-cycle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#ä¸€ã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ" class="sidebar-link">ä¸€ã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#_1-new-é˜¶æ®µ" class="sidebar-link heading3">1.new é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#_2-runnable-é˜¶æ®µ" class="sidebar-link heading3">2. Runnable é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#_3-running-é˜¶æ®µ" class="sidebar-link heading3">3.Running é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/thread-life-cycle/#wait" class="sidebar-link heading3">wait</a></li></ul></li></ul></li><li><a href="/blog/java/concurrent/4-reference-types/" class="sidebar-link">referencequeue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/4-reference-types/#_1-å¼ºå¼•ç”¨" class="sidebar-link">1. å¼ºå¼•ç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/4-reference-types/#_2-è½¯å¼•ç”¨" class="sidebar-link">2. è½¯å¼•ç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/4-reference-types/#_3-å¼±å¼•ç”¨" class="sidebar-link">3. å¼±å¼•ç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/4-reference-types/#_4-phantomreference-è™šå¼•ç”¨" class="sidebar-link">4. PhantomReference è™šå¼•ç”¨</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/4-reference-types/#åº”ç”¨åœºæ™¯" class="sidebar-link heading3">åº”ç”¨åœºæ™¯</a></li></ul></li></ul></li><li><a href="/blog/java/concurrent/aqs-source-code-reading-notes/" class="sidebar-link">aqs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#æ¦‚è¿°" class="sidebar-link">æ¦‚è¿°</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#node-js-å†…éƒ¨ç±»" class="sidebar-link">Node.js å†…éƒ¨ç±»</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#fifo-ç»“æ„å›¾" class="sidebar-link">FIFO ç»“æ„å›¾</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#ç‹¬å å¼åŒæ­¥çŠ¶æ€è¿‡ç¨‹" class="sidebar-link">ç‹¬å å¼åŒæ­¥çŠ¶æ€è¿‡ç¨‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#acquire" class="sidebar-link heading3">acquire</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#tryacquire" class="sidebar-link heading3">tryAcquire</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#addwaiter" class="sidebar-link heading3">addWaiter</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#enq" class="sidebar-link heading3">enq</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#acquirequeued" class="sidebar-link heading3">acquireQueued</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#shouldparkafterfailedacquire" class="sidebar-link heading3">shouldParkAfterFailedAcquire</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/aqs-source-code-reading-notes/#parkandcheckinterrupt" class="sidebar-link heading3">parkAndCheckInterrupt</a></li></ul></li></ul></li><li><a href="/blog/java/concurrent/threadpool-code-analysis/" class="sidebar-link">threadpool</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_1ã€æ„é€ æ–¹æ³•" class="sidebar-link">1ã€æ„é€ æ–¹æ³•</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#çº¿ç¨‹æ± ä¸­å®šä¹‰äº†å››ç§é¥±å’Œç­–ç•¥-æ‹’ç»ç­–ç•¥" class="sidebar-link">çº¿ç¨‹æ± ä¸­å®šä¹‰äº†å››ç§é¥±å’Œç­–ç•¥ (æ‹’ç»ç­–ç•¥)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_1ã€callerrunspolicy" class="sidebar-link heading3">1ã€CallerRunsPolicy</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_2ã€-abortpolicy-çº¿ç¨‹æ± é»˜è®¤çš„ç­–ç•¥" class="sidebar-link heading3">2ã€ AbortPolicy(çº¿ç¨‹æ± é»˜è®¤çš„ç­–ç•¥)</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_3ã€discardpolicy" class="sidebar-link heading3">3ã€DiscardPolicy</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_4ã€discardoldestpolicy" class="sidebar-link heading3">4ã€DiscardOldestPolicy</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_3ã€é˜»å¡é˜Ÿåˆ—" class="sidebar-link">3ã€é˜»å¡é˜Ÿåˆ—</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadpool-code-analysis/#_4ã€execute-æ–¹æ³•" class="sidebar-link">4ã€execute æ–¹æ³•</a></li></ul></li><li><a href="/blog/java/concurrent/threadlocal/" class="sidebar-link">ThreadLocal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadlocal/#threadlocal" class="sidebar-link">ThreadLocal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadlocal/#æ¦‚å¿µ" class="sidebar-link heading3">æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/concurrent/threadlocal/#entry-æ˜¯ç»§æ‰¿-weakreference" class="sidebar-link heading3">Entry æ˜¯ç»§æ‰¿ WeakReference</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogbxl-spring-boot"></i> <span class="title">spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogbxl-spring-boot"></i> <span class="title">å¾®æœåŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogmqxiaoxiduilieMQ"></i> <span class="title">æ¶ˆæ¯é˜Ÿåˆ—</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogdatasource"></i> <span class="title">æ•°æ®åº“</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogfenbushi"></i> <span class="title">åˆ†å¸ƒå¼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogsuanfaku"></i> <span class="title">ç®—æ³•</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-blogxuniji"></i> <span class="title">è™šæ‹Ÿæœº</span> <span class="arrow right"></span></p> <!----></section></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav display="true" class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/blog/java/" property="item" typeof="WebPage" class="router-link-active"><i class="iconfont icon-blogmulu"></i> <span property="name">java</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a href="/blog/java/concurrent/" property="item" typeof="WebPage" class="router-link-active"><i class="iconfont icon-blogmulu"></i> <span property="name">concurrent-content</span></a> <meta property="position" content="2"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">synchronized</span></a> <meta property="position" content="3"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">synchronized</span></h1> <div class="page-info"><!----> <span aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down" categoryPath="/category/$category/" tagPath="/tag/$tag/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon author-icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z" fill="currentColor"></path></svg> <span property="author">zhangsj</span></span><span aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="down" defaultAuthor="zhangsj" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 0 0-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/" data-flag-title="synchronized" class="leancloud_visitors waline-visitor-count"><span class="leancloud-visitors-count">...</span></span></span><span aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" defaultAuthor="zhangsj" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-01-28 </span></span><span role="navigation" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down" defaultAuthor="zhangsj" tagPath="/tag/$tag/" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">Concurrent</span></span><span aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down" defaultAuthor="zhangsj" categoryPath="/category/$category/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">Concurrent</span></li><li class="tag clickable tag1"><span role="navigation">Synchronized</span></li></ul> <meta property="keywords" content="Concurrent,Synchronized"></span><span aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" defaultAuthor="zhangsj" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>å¤§çº¦ 51 åˆ†é’Ÿ</span> <meta property="timeRequired" content="PT51M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯è§æ€§" class="anchor-link heading2"><div>å¯è§æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ" class="anchor-link heading3"><div>æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯è§æ€§æ¼”ç¤º" class="anchor-link heading3"><div>å¯è§æ€§æ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åŸå­æ€§" class="anchor-link heading2"><div>åŸå­æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-2" class="anchor-link heading3"><div>æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¼”ç¤º" class="anchor-link heading3"><div>æ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§" class="anchor-link heading2"><div>æœ‰åºæ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§æ¦‚å¿µ" class="anchor-link heading3"><div>æœ‰åºæ€§æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æœ‰åºæ€§æ¼”ç¤º" class="anchor-link heading3"><div>æœ‰åºæ€§æ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è®¡ç®—æœºç»“æ„ç®€ä»‹" class="anchor-link heading3"><div>è®¡ç®—æœºç»“æ„ç®€ä»‹</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cpu" class="anchor-link heading3"><div>CPU</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å†…å­˜" class="anchor-link heading3"><div>å†…å­˜</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ç¼“å­˜" class="anchor-link heading3"><div>ç¼“å­˜</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#java-å†…å­˜æ¨¡å‹" class="anchor-link heading2"><div>Java å†…å­˜æ¨¡å‹</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-3" class="anchor-link heading3"><div>æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä½œç”¨" class="anchor-link heading3"><div>ä½œç”¨</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" class="anchor-link heading3"><div>CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" class="anchor-link heading2"><div>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸åŸå­æ€§" class="anchor-link heading2"><div>synchronized ä¸åŸå­æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¡ˆä¾‹æ¼”ç¤º" class="anchor-link heading3"><div>æ¡ˆä¾‹æ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯åŸå­æ€§çš„åŸç†" class="anchor-link heading3"><div>ä¿è¯åŸå­æ€§çš„åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸å¯è§æ€§" class="anchor-link heading2"><div>synchronized ä¸å¯è§æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯å¯è§æ€§" class="anchor-link heading3"><div>ä¿è¯å¯è§æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯å¯è§æ€§çš„åŸç†" class="anchor-link heading3"><div>ä¿è¯å¯è§æ€§çš„åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-ä¸æœ‰åºæ€§" class="anchor-link heading2"><div>synchronized ä¸æœ‰åºæ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸ºä»€ä¹ˆè¦é‡æ’åº" class="anchor-link heading3"><div>ä¸ºä»€ä¹ˆè¦é‡æ’åº</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#as-if-serial-è¯­ä¹‰" class="anchor-link heading3"><div>as-if-serial è¯­ä¹‰</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¡ˆä¾‹æ¼”ç¤º-2" class="anchor-link heading3"><div>æ¡ˆä¾‹æ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¿è¯æœ‰åºæ€§çš„åŸç†" class="anchor-link heading3"><div>ä¿è¯æœ‰åºæ€§çš„åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥ç‰¹æ€§" class="anchor-link heading3"><div>å¯é‡å…¥ç‰¹æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥çš„å¥½å¤„" class="anchor-link heading3"><div>å¯é‡å…¥çš„å¥½å¤„</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯é‡å…¥åŸç†" class="anchor-link heading3"><div>å¯é‡å…¥åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸å¯ä¸­æ–­ç‰¹æ€§" class="anchor-link heading2"><div>ä¸å¯ä¸­æ–­ç‰¹æ€§</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-4" class="anchor-link heading3"><div>æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º" class="anchor-link heading3"><div>ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#javap-åæ±‡ç¼–" class="anchor-link heading2"><div>javap åæ±‡ç¼–</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitorenter" class="anchor-link heading3"><div>monitorenter</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitorexit" class="anchor-link heading3"><div>monitorexit</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åŒæ­¥æ–¹æ³•" class="anchor-link heading3"><div>åŒæ­¥æ–¹æ³•</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" class="anchor-link heading3"><div>é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ·±å…¥-jvm-æºç " class="anchor-link heading2"><div>æ·±å…¥ JVM æºç </div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#jvm-æºç ä¸‹è½½" class="anchor-link heading3"><div>JVM æºç ä¸‹è½½</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ide-clion-ä¸‹è½½" class="anchor-link heading3"><div>IDE(Clion )ä¸‹è½½</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç›‘è§†å™¨é”" class="anchor-link heading3"><div>monitor ç›‘è§†å™¨é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç«äº‰" class="anchor-link heading3"><div>monitor ç«äº‰</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-ç­‰å¾…" class="anchor-link heading3"><div>monitor ç­‰å¾…</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-é‡Šæ”¾" class="anchor-link heading3"><div>monitor é‡Šæ”¾</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#monitor-æ˜¯é‡é‡çº§é”" class="anchor-link heading3"><div>monitor æ˜¯é‡é‡çº§é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas" class="anchor-link heading2"><div>CAS</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æ¦‚å¿µ-5" class="anchor-link heading3"><div>æ¦‚å¿µ</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas-å’Œ-volatile-å®ç°æ— é”å¹¶å‘" class="anchor-link heading3"><div>CAS å’Œ volatile å®ç°æ— é”å¹¶å‘</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#cas-åŸç†" class="anchor-link heading3"><div>CAS åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#synchronized-é”å‡çº§è¿‡ç¨‹" class="anchor-link heading2"><div>synchronized é”å‡çº§è¿‡ç¨‹</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#java-å¯¹è±¡çš„å¸ƒå±€" class="anchor-link heading2"><div>Java å¯¹è±¡çš„å¸ƒå±€</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯¹è±¡å¤´" class="anchor-link heading3"><div>å¯¹è±¡å¤´</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å®ä¾‹æ•°æ®" class="anchor-link heading3"><div>å®ä¾‹æ•°æ®</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¯¹é½å¡«å……" class="anchor-link heading3"><div>å¯¹é½å¡«å……</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" class="anchor-link heading3"><div>æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”" class="anchor-link heading2"><div>åå‘é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä»€ä¹ˆæ˜¯åå‘é”" class="anchor-link heading3"><div>ä»€ä¹ˆæ˜¯åå‘é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”åŸç†" class="anchor-link heading3"><div>åå‘é”åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”çš„æ’¤é”€" class="anchor-link heading3"><div>åå‘é”çš„æ’¤é”€</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#åå‘é”å¥½å¤„" class="anchor-link heading3"><div>åå‘é”å¥½å¤„</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”" class="anchor-link heading2"><div>è½»é‡çº§é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" class="anchor-link heading3"><div>ä»€ä¹ˆæ˜¯è½»é‡çº§é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”åŸç†" class="anchor-link heading3"><div>è½»é‡çº§é”åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”çš„é‡Šæ”¾" class="anchor-link heading3"><div>è½»é‡çº§é”çš„é‡Šæ”¾</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è½»é‡çº§é”å¥½å¤„" class="anchor-link heading3"><div>è½»é‡çº§é”å¥½å¤„</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è‡ªæ—‹é”" class="anchor-link heading2"><div>è‡ªæ—‹é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è‡ªæ—‹é”åŸç†" class="anchor-link heading3"><div>è‡ªæ—‹é”åŸç†</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é€‚åº”æ€§è‡ªæ—‹é”" class="anchor-link heading3"><div>é€‚åº”æ€§è‡ªæ—‹é”</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é”æ¶ˆé™¤" class="anchor-link heading2"><div>é”æ¶ˆé™¤</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é”ç²—åŒ–" class="anchor-link heading2"><div>é”ç²—åŒ–</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" class="anchor-link heading2"><div>å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#å‡å°‘-synchronized-çš„èŒƒå›´" class="anchor-link heading3"><div>å‡å°‘ synchronized çš„èŒƒå›´</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#é™ä½-synchronized-é”çš„ç²’åº¦" class="anchor-link heading3"><div>é™ä½ synchronized é”çš„ç²’åº¦</div></a></li><li class="anchor"><a href="/blog/java/concurrent/synchronized-principle-analysis-and-optimization/#è¯»å†™åˆ†ç¦»" class="anchor-link heading3"><div>è¯»å†™åˆ†ç¦»</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="header-anchor">#</a> å¯è§æ€§</h2> <h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="header-anchor">#</a> æ¦‚å¿µ</h3> <p>å¯è§æ€§æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å…ˆç«‹å³è·å–åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚</p> <h3 id="å¯è§æ€§æ¼”ç¤º"><a href="#å¯è§æ€§æ¼”ç¤º" class="header-anchor">#</a> å¯è§æ€§æ¼”ç¤º</h3> <p>ä¸€ä¸ªçº¿ç¨‹æ ¹æ® <code>boolean</code> ç±»å‹çš„æ ‡è®° flagï¼Œ while å¾ªç¯ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜è¿™ä¸ª flag å˜é‡çš„å€¼ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœæ­¢å¾ªç¯ã€‚</p> <p>å¤šä¸ªçº¿ç¨‹éƒ½ä¼šè®¿é—®çš„æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¸ºçº¿ç¨‹çš„å…±äº«æ•°æ®</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
æ¼”ç¤º:
ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹,å¦ä¸€ä¸ªçº¿ç¨‹ä¸èƒ½ç«‹å³å¾—åˆ°æœ€æ–°å€¼
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01Visibility</span> <span class="token punctuation">{</span>

<span class="token comment">// å…±äº«æ•°æ®</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ—¶é—´åˆ°ï¼Œçº¿ç¨‹2è®¾ç½®ä¸ºfalse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼šå‡ºç°å¯è§æ€§é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¦å¤–çš„çº¿ç¨‹å¹¶æ²¡æœ‰ç«‹å³çœ‹åˆ°ä¿®æ”¹ åçš„æœ€æ–°å€¼ã€‚Synchronized volatile å¯è§£å†³</p></div> <h2 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="header-anchor">#</a> åŸå­æ€§</h2> <h3 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="header-anchor">#</a> æ¦‚å¿µ</h3> <p>åœ¨ä¸€æ¬¡æˆ–å¤šæ¬¡æ“ä½œä¸­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—å…¶ä»–å› ç´ å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½ä¸æ‰§è¡Œã€‚</p> <h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="header-anchor">#</a> æ¼”ç¤º</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
æ¡ˆä¾‹æ¼”ç¤º:5ä¸ªçº¿ç¨‹å„æ‰§è¡Œ1000æ¬¡ i++;
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test02Atomicity</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> increment <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            number<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ä½¿ç”¨ javap åæ±‡ç¼– class æ–‡ä»¶ï¼Œå¾—åˆ°ä¸‹é¢çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š</p> <p><img src="/blog/assets/img/1-2-1.ef6a03f2.png" alt="" loading="lazy"></p> <p>å…¶ä¸­ï¼Œå¯¹äº number++ è€Œè¨€(number ä¸ºé™æ€å˜é‡)ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼šç”±æ­¤å¯è§ number++æ˜¯ç”±å¤šæ¡è¯­å¥ç»„æˆï¼Œä»¥ä¸Šå¤šæ¡æŒ‡ä»¤åœ¨ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤š çº¿ç¨‹æƒ…å†µä¸‹å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ 13: iadd æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åˆæ‰§è¡Œ 9: getstaticã€‚ä¼šå¯¼ è‡´ä¸¤æ¬¡ number++ï¼Œå®é™…ä¸ŠåªåŠ äº† 1ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼šå‡ºç°åŸå­æ€§é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡æ“ä½œåˆ°ä¸€åŠæ—¶ï¼Œå¦å¤–çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½æ¥æ“ä½œå…±äº«å˜é‡ï¼Œå¹²æ‰°äº†å‰ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œã€‚</p></div> <h2 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="header-anchor">#</a> æœ‰åºæ€§</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-0" class="task-list-item-checkbox"><label for="task-item-0" class="task-list-item-label"> å­¦ä¹ ä»€ä¹ˆæ˜¯æœ‰åºæ€§é—®é¢˜</label></li></ul> <h3 id="æœ‰åºæ€§æ¦‚å¿µ"><a href="#æœ‰åºæ€§æ¦‚å¿µ" class="header-anchor">#</a> æœ‰åºæ€§æ¦‚å¿µ</h3> <p>æœ‰åºæ€§(Ordering)ï¼šæ˜¯æŒ‡ç¨‹åºä¸­ä»£ç çš„æ‰§è¡Œé¡ºåºï¼ŒJava åœ¨ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶ä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä¼šå¯¼è‡´ ç¨‹åºæœ€ç»ˆçš„æ‰§è¡Œé¡ºåºä¸ä¸€å®šå°±æ˜¯æˆ‘ä»¬ç¼–å†™ä»£ç æ—¶çš„é¡ºåºã€‚</p> <h3 id="æœ‰åºæ€§æ¼”ç¤º"><a href="#æœ‰åºæ€§æ¼”ç¤º" class="header-anchor">#</a> æœ‰åºæ€§æ¼”ç¤º</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Jcstress æ˜¯ java å¹¶å‘å‹æµ‹å·¥å…·ã€‚<a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress" target="_blank" rel="noopener noreferrer">https://wiki.openjdk.java.net/display/CodeTools/jcstress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¿®æ”¹ pom æ–‡ä»¶ï¼Œæ·»åŠ ä¾èµ–ï¼š</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jcstress<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jcstress-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jcstress.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">9</span>: getstatic <span class="token comment">#12 // Field number:I</span>
<span class="token number">12</span>: iconst_1
<span class="token number">13</span>: iadd
<span class="token number">14</span>: putstatic <span class="token comment">#12 // Field number:I</span>
ä»£ç 
Test03Orderliness.java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>concurrent_problem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>infra<span class="token punctuation">.</span>results<span class="token punctuation">.</span></span><span class="token class-name">I_Result</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@JCStressTest</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span>ï¼Œ expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLEï¼Œ desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span>ï¼Œ expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTINGï¼Œ desc <span class="token operator">=</span> <span class="token string">&quot;danger&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test03Orderliness</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// çº¿ç¨‹ä¸€æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§r1ç”¨æ¥ä¿å­˜ç»“æœï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯èƒ½å‡ºç°å‡ ç§ç»“æœï¼Ÿ</p> <p>æƒ…å†µ 1ï¼šçº¿ç¨‹1å…ˆæ‰§è¡Œ actor1ï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1ã€‚</p> <p>æƒ…å†µ 2ï¼šçº¿ç¨‹2æ‰§è¡Œåˆ°actor2ï¼Œæ‰§è¡Œäº† num = 2;å’Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ã€‚</p> <p>æƒ…å†µ 3ï¼šçº¿ç¨‹2å…ˆæ‰§è¡Œactor2ï¼Œåªæ‰§è¡Œnum=2ï¼›ä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥Elseåˆ†æ”¯ï¼Œç»“æœä¸º1ã€‚</p> <p>è¿˜æœ‰ä¸€ç§ç»“æœ 0ã€‚</p> <p>è¿è¡Œæµ‹è¯•ï¼š</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>mvn clean <span class="token function">install</span>
java -jar target/jcstress.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>ç¨‹åºä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…ˆåé¡ºåºï¼Œç”±äº Java åœ¨ç¼–è¯‘æœŸä»¥åŠè¿è¡ŒæœŸçš„ä¼˜åŒ–ï¼Œå¯¼è‡´äº†ä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯å¼€å‘è€…ç¼–å†™ä»£ç æ—¶çš„é¡ºåºã€‚</p></div> <h1 id="äºŒã€java-å†…å­˜æ¨¡å‹-jmm"><a href="#äºŒã€java-å†…å­˜æ¨¡å‹-jmm" class="header-anchor">#</a> äºŒã€Java å†…å­˜æ¨¡å‹(JMM)</h1> <p>åœ¨ä»‹ç» Java å†…å­˜æ¨¡å‹ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹åˆ°åº•ä»€ä¹ˆæ˜¯è®¡ç®—æœºå†…å­˜æ¨¡å‹ã€‚</p> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-1" class="task-list-item-checkbox"><label for="task-item-1" class="task-list-item-label"> è®¡ç®—æœºçš„ä¸»è¦ç»„æˆ</label></li> <li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-2" class="task-list-item-checkbox"><label for="task-item-2" class="task-list-item-label"> å­¦ä¹ ç¼“å­˜çš„ä½œç”¨</label></li></ul> <h3 id="è®¡ç®—æœºç»“æ„ç®€ä»‹"><a href="#è®¡ç®—æœºç»“æ„ç®€ä»‹" class="header-anchor">#</a> è®¡ç®—æœºç»“æ„ç®€ä»‹</h3> <p>å†¯è¯ºä¾æ›¼ï¼Œæå‡ºè®¡ç®—æœºç”±äº”å¤§ç»„æˆéƒ¨åˆ†ï¼Œè¾“å…¥è®¾å¤‡ï¼Œè¾“å‡ºè®¾å¤‡å­˜å‚¨å™¨ï¼Œæ§åˆ¶å™¨ï¼Œè¿ç®—å™¨ã€‚</p> <p><img src="/blog/assets/img/2-1-1.d085105f.png" alt="" loading="lazy"></p> <h3 id="cpu"><a href="#cpu" class="header-anchor">#</a> CPU</h3> <p>ä¸­å¤®å¤„ç†å™¨ï¼Œæ˜¯è®¡ç®—æœºçš„æ§åˆ¶å’Œè¿<br>
çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬çš„ç¨‹åºæœ€ç»ˆéƒ½ä¼šå˜æˆæŒ‡ä»¤ è®© CPU
å»æ‰§è¡Œï¼Œå¤„ç†ç¨‹åºä¸­ çš„æ•°æ®ã€‚</p> <h3 id="å†…å­˜"><a href="#å†…å­˜" class="header-anchor">#</a> å†…å­˜</h3> <p>æˆ‘ä»¬çš„ç¨‹åºéƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿è¡Œçš„ï¼Œå†…å­˜ä¼šä¿å­˜ç¨‹åºè¿è¡Œæ—¶çš„æ•°æ®ï¼Œä¾› CPU å¤„ç†ã€‚</p> <h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="header-anchor">#</a> ç¼“å­˜</h3> <p>CPUçš„è¿ç®—é€Ÿåº¦å’Œå†…å­˜çš„è®¿é—®é€Ÿåº¦ç›¸å·®æ¯”è¾ƒå¤§ã€‚è¿™å°±å¯¼è‡´ CPU æ¯æ¬¡æ“ä½œå†…å­˜éƒ½è¦è€—è´¹å¾ˆå¤šç­‰å¾…æ—¶é—´ã€‚å†…
å­˜çš„è¯»å†™é€Ÿåº¦æˆä¸ºäº†è®¡ç®—æœºè¿è¡Œçš„ç“¶é¢ˆã€‚äºæ˜¯å°±æœ‰äº†åœ¨ CPU å’Œä¸»å†…å­˜ä¹‹é—´å¢åŠ ç¼“å­˜çš„è®¾è®¡ã€‚æœ€é è¿‘ CPU
çš„ç¼“å­˜ç§°ä¸º L1ï¼Œç„¶åä¾æ¬¡æ˜¯ L2ï¼ŒL3 å’Œä¸»å†…å­˜ï¼ŒCPU ç¼“å­˜æ¨¡å‹å¦‚å›¾ä¸‹å›¾æ‰€ç¤ºã€‚</p> <p><img src="/blog/assets/img/2-1-4.deb5f955.png" alt="" loading="lazy"></p> <p>CPU Cache åˆ†æˆäº†ä¸‰ä¸ªçº§åˆ«: L1ï¼Œ L2ï¼Œ L3ã€‚çº§åˆ«è¶Šå°è¶Šæ¥è¿‘ CPUï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«ï¼ŒåŒæ—¶ä¹Ÿä»£è¡¨ç€å®¹é‡è¶Š
å°ã€‚</p> <ol><li>L1 æ˜¯æœ€æ¥è¿‘ CPU çš„ï¼Œå®ƒå®¹é‡æœ€å°ï¼Œä¾‹å¦‚ 32Kï¼Œé€Ÿåº¦æœ€å¿«ï¼Œæ¯ä¸ªæ ¸ä¸Šéƒ½æœ‰ä¸€ä¸ª L1 Cacheã€‚</li> <li>L2 Cache æ›´å¤§ä¸€äº›ï¼Œä¾‹å¦‚ 256Kï¼Œé€Ÿåº¦è¦æ…¢ä¸€äº›ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ¯ä¸ªæ ¸ä¸Šéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ L2 Cacheã€‚</li> <li>L3 Cache æ˜¯ä¸‰çº§ç¼“å­˜ä¸­æœ€å¤§çš„ä¸€çº§ï¼Œä¾‹å¦‚ 12MBï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç¼“å­˜ä¸­æœ€æ…¢çš„ä¸€çº§ï¼Œåœ¨åŒä¸€ä¸ª CPU æ’æ§½
ä¹‹é—´çš„æ ¸å…±äº«ä¸€ä¸ª L3 Cacheã€‚</li></ol> <p><img src="/blog/assets/img/2-1-5.4d03846e.png" alt="" loading="lazy"></p> <p>Cache çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³CPUç›´æ¥è®¿é—®å†…å­˜æ•ˆç‡ä½ä¸‹é—®é¢˜çš„ï¼Œ</p> <p>ç¨‹åºåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒCPU æ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œå®ƒä¼šæœ€å…ˆå‘CPUä¸­çš„ä¸€çº§ç¼“å­˜(L1 Cache)å»å¯»æ‰¾ç›¸å…³çš„æ•°æ®ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼ŒCPU è¿›è¡Œè®¡ç®—æ—¶å°± å¯ä»¥ç›´æ¥å¯¹ CPU Cache ä¸­çš„æ•°æ®è¿›è¡Œè¯»å–å’Œå†™äººï¼Œ</p> <p>å½“è¿ç®—ç»“æŸä¹‹åï¼Œå†å°† CPUCache ä¸­çš„æœ€æ–°æ•°æ®åˆ·æ–° åˆ°ä¸»å†…å­˜å½“ä¸­ï¼ŒCPU é€šè¿‡ç›´æ¥è®¿é—® Cache çš„æ–¹å¼æ›¿ä»£ç›´æ¥è®¿é—®ä¸»å­˜çš„æ–¹å¼æå¤§åœ°æé«˜äº† CPU çš„ååèƒ½ åŠ›ã€‚</p> <p>ä½†æ˜¯ç”±äºä¸€çº§ç¼“å­˜(L1 Cache)å®¹é‡è¾ƒå°ï¼Œæ‰€ä»¥ä¸å¯èƒ½æ¯æ¬¡éƒ½å‘½ä¸­ã€‚</p> <p>è¿™æ—¶ CPU ä¼šç»§ç»­å‘ä¸‹ä¸€çº§çš„äºŒçº§ç¼“å­˜(L2 Cache)å¯»æ‰¾ï¼ŒåŒæ ·çš„é“ç†ï¼Œå½“æ‰€éœ€è¦çš„æ•°æ®åœ¨äºŒçº§ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰çš„è¯ï¼Œä¼šç»§ç»­è½¬å‘ L3 Cacheã€å†…å­˜(ä¸»å­˜)å’Œç¡¬ç›˜ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>è®¡ç®—æœºçš„ä¸»è¦ç»„æˆCPUï¼Œå†…å­˜ï¼Œè¾“å…¥è®¾å¤‡ï¼Œè¾“å‡ºè®¾å¤‡ã€‚</p></div> <h2 id="java-å†…å­˜æ¨¡å‹"><a href="#java-å†…å­˜æ¨¡å‹" class="header-anchor">#</a> Java å†…å­˜æ¨¡å‹</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-3" class="task-list-item-checkbox"><label for="task-item-3" class="task-list-item-label"> å­¦ä¹  Java å†…å­˜æ¨¡å‹çš„æ¦‚å¿µå’Œä½œç”¨</label></li></ul> <h3 id="æ¦‚å¿µ-3"><a href="#æ¦‚å¿µ-3" class="header-anchor">#</a> æ¦‚å¿µ</h3> <p>Java Memory Molde (Java å†…å­˜æ¨¡å‹/JMM)ï¼Œåƒä¸‡ä¸è¦å’Œ Java å†…å­˜ç»“æ„æ··æ·†</p> <p>å…³äºâ€œJava å†…å­˜æ¨¡å‹â€çš„æƒå¨è§£é‡Šï¼Œè¯·å‚è€ƒ <a href="https://download.oracle.com/otn-pub/jcp/memory_model1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.PDF" target="_blank" rel="noopener noreferrer">https://download.oracle.com/otn-pub/jcp/memory_model1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.PDF<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <p>Java å†…å­˜æ¨¡å‹ï¼Œæ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­æ‰€å®šä¹‰çš„ä¸€ç§å†…å­˜æ¨¡å‹ï¼ŒJava å†…å­˜æ¨¡å‹æ˜¯æ ‡å‡†åŒ–çš„ï¼Œå±è”½æ‰äº†åº•å±‚
ä¸åŒè®¡ç®—æœºçš„åŒºåˆ«ã€‚</p> <p>Java å†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—è§„èŒƒï¼Œæè¿°äº† Java ç¨‹åºä¸­å„ç§å˜é‡(çº¿ç¨‹å…±äº«å˜é‡)çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨ JVM ä¸­å°†å˜é‡
å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p> <ul><li>ä¸»å†…å­˜
ä¸»å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹éƒ½å…±äº«çš„ï¼Œéƒ½èƒ½è®¿é—®çš„ã€‚æ‰€æœ‰çš„å…±äº«å˜é‡éƒ½å­˜å‚¨äºä¸»å†…å­˜ã€‚</li> <li>å·¥ä½œå†…å­˜
æ¯ä¸€ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜åªå­˜å‚¨è¯¥çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰çš„æ“ ä½œ(è¯»ï¼Œå–)éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿä¸èƒ½ç›´æ¥ è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ã€‚</li></ul> <p><img src="/blog/assets/img/2-2-1.dc603045.png" alt="" loading="lazy"></p> <h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="header-anchor">#</a> ä½œç”¨</h3> <p>Java å†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—åœ¨å¤šçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ—¶ï¼Œå¯¹å…±äº«æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸå­æ€§çš„è§„åˆ™å’Œä¿éšœã€‚</p> <p>Synchronized,volatile</p> <h3 id="cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»"><a href="#cpu-ç¼“å­˜-å†…å­˜ä¸-jmmçš„å…³ç³»" class="header-anchor">#</a> CPU ç¼“å­˜ï¼Œå†…å­˜ä¸ JMMçš„å…³ç³»</h3> <p>é€šè¿‡å¯¹å‰é¢çš„ CPU ç¡¬ä»¶å†…å­˜æ¶æ„ã€Java å†…å­˜æ¨¡å‹ä»¥åŠ Java å¤šçº¿ç¨‹çš„å®ç°åŸç†çš„äº†è§£ï¼Œæˆ‘ä»¬åº”è¯¥å·²ç»æ„è¯†åˆ°ï¼Œå¤šçº¿ç¨‹çš„æ‰§è¡Œæœ€ç»ˆéƒ½ä¼šæ˜ å°„åˆ°ç¡¬ä»¶å¤„ç†å™¨ä¸Šè¿›è¡Œæ‰§è¡Œã€‚</p> <p>ä½† Java å†…å­˜æ¨¡å‹å’Œç¡¬ä»¶å†…å­˜æ¶æ„å¹¶ä¸å®Œå…¨ä¸€è‡´ã€‚</p> <p>å¯¹äºç¡¬ä»¶å†…å­˜æ¥è¯´åªæœ‰å¯„å­˜å™¨ã€ç¼“å­˜å†…å­˜ã€ä¸»å†…å­˜çš„æ¦‚ å¿µï¼Œå¹¶æ²¡æœ‰å·¥ä½œå†…å­˜å’Œä¸»å†…å­˜ä¹‹åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´ Java å†…å­˜æ¨¡å‹å¯¹å†…å­˜çš„åˆ’åˆ†å¯¹ç¡¬ä»¶å†…å­˜å¹¶æ²¡æœ‰ä»»ä½•å½±å“ï¼Œ å› ä¸º JMM åªæ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯ä¸€ç»„è§„åˆ™ï¼Œä¸ç®¡æ˜¯å·¥ä½œå†…å­˜çš„æ•°æ®è¿˜æ˜¯ä¸»å†…å­˜çš„æ•°æ®ï¼Œå¯¹äºè®¡ç®—æœºç¡¬ ä»¶æ¥è¯´éƒ½ä¼šå­˜å‚¨åœ¨è®¡ç®—æœºä¸»å†…å­˜ä¸­ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½å­˜å‚¨åˆ° CPU ç¼“å­˜æˆ–è€…å¯„å­˜å™¨ä¸­ï¼Œå› æ­¤æ€»ä½“ä¸Šæ¥è¯´ï¼Œ Java å†…å­˜æ¨¡å‹å’Œè®¡ç®—æœºç¡¬ä»¶å†…å­˜æ¶æ„æ˜¯ä¸€ä¸ªç›¸äº’äº¤å‰çš„å…³ç³»ï¼Œæ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µåˆ’åˆ†ä¸çœŸå®ç‰©ç†ç¡¬ä»¶çš„äº¤ å‰ã€‚</p> <p><strong>JMM å†…å­˜æ¨¡å‹ä¸ CPU ç¡¬ä»¶å†…å­˜æ¶æ„çš„å…³ç³»ï¼š</strong></p> <p><img src="/blog/assets/img/2-2-2.062d7111.png" alt="" loading="lazy"></p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Java å†…å­˜æ¨¡å‹æ˜¯ä¸€å¥—è§„èŒƒï¼Œæè¿°äº† Java ç¨‹åºä¸­å„ç§å˜é‡(çº¿ç¨‹å…±äº«å˜é‡)çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨ JVM ä¸­å°†å˜é‡
å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡å‹æ˜¯å¯¹å…±äº«æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸ
å­æ€§çš„è§„åˆ™å’Œä¿éšœã€‚</p></div> <h2 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’"><a href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’" class="header-anchor">#</a> ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-4" class="task-list-item-checkbox"><label for="task-item-4" class="task-list-item-label"> äº†è§£ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„æ•°æ®äº¤äº’è¿‡ç¨‹</label></li></ul> <p><img src="/blog/assets/img/2-3-1.4334babb.png" alt="" loading="lazy"></p> <p>Java å†…å­˜æ¨¡å‹ä¸­å®šä¹‰äº†ä»¥ä¸‹ 8 ç§æ“ä½œæ¥å®Œæˆï¼Œä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•
ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¹‹ç±»çš„å®ç°ç»†èŠ‚ï¼Œè™šæ‹Ÿæœºå®ç°æ—¶å¿…é¡»ä¿è¯ä¸‹é¢
æåŠçš„æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŸå­çš„ã€ä¸å¯å†åˆ†çš„ã€‚</p> <p>å¯¹åº”å¦‚ä¸‹çš„æµç¨‹å›¾ï¼š</p> <p><img src="/blog/assets/img/2-3-2.eef71e06.png" alt="" loading="lazy"></p> <p>æ³¨æ„:</p> <ol><li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼</li> <li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­</li></ol> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„æ•°æ®äº¤äº’è¿‡ç¨‹</p></div> <div class="language-text line-numbers-mode"><pre class="language-text"><code>lock -&gt; read -&gt; load -&gt; use -&gt; assign -&gt; store -&gt; write -&gt; unlock
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§"><a href="#ä¸‰ã€synchronized-ä¿è¯ä¸‰å¤§ç‰¹æ€§" class="header-anchor">#</a> ä¸‰ã€synchronized ä¿è¯ä¸‰å¤§ç‰¹æ€§</h1> <p>Synchronized èƒ½å¤Ÿä¿è¯åœ¨åŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ®µä»£ç ï¼Œä»¥è¾¾åˆ°ä¿è¯å¹¶å‘å®‰å…¨çš„æ•ˆæœã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>é”å¯¹è±¡<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å—ä¿æŠ¤èµ„æº;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="synchronized-ä¸åŸå­æ€§"><a href="#synchronized-ä¸åŸå­æ€§" class="header-anchor">#</a> synchronized ä¸åŸå­æ€§</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-5" class="task-list-item-checkbox"><label for="task-item-5" class="task-list-item-label"> å­¦ä¹ ä½¿ç”¨ synchronized ä¿è¯åŸå­æ€§çš„åŸç†</label></li></ul> <h3 id="æ¡ˆä¾‹æ¼”ç¤º"><a href="#æ¡ˆä¾‹æ¼”ç¤º" class="header-anchor">#</a> æ¡ˆä¾‹æ¼”ç¤º</h3> <p>æ¡ˆä¾‹æ¼”ç¤º:5 ä¸ªçº¿ç¨‹å„æ‰§è¡Œ 1000 æ¬¡ i++;</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo02_concurrent_problem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token comment">/**
æ¡ˆä¾‹æ¼”ç¤º:5ä¸ªçº¿ç¨‹å„æ‰§è¡Œ1000æ¬¡ i++;
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01Atomicity</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> increment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Test01Atomicity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 number<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Test01Atomicity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    number<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="ä¿è¯åŸå­æ€§çš„åŸç†"><a href="#ä¿è¯åŸå­æ€§çš„åŸç†" class="header-anchor">#</a> ä¿è¯åŸå­æ€§çš„åŸç†</h3> <p>å¯¹ number++;å¢åŠ åŒæ­¥ä»£ç å—åï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œ number++;ã€‚å°±ä¸ä¼šå‡ºç°å®‰å…¨é—®é¢˜ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Synchronized ä¿è¯åŸå­æ€§çš„åŸç†ï¼Œsynchronized ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”ï¼Œèƒ½å¤Ÿè¿›å…¥åŒæ­¥ä»£ç å—ã€‚</p></div> <h2 id="synchronized-ä¸å¯è§æ€§"><a href="#synchronized-ä¸å¯è§æ€§" class="header-anchor">#</a> synchronized ä¸å¯è§æ€§</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-6" class="task-list-item-checkbox"><label for="task-item-6" class="task-list-item-label"> å­¦ä¹ ä½¿ç”¨ synchronized ä¿è¯å¯è§æ€§çš„åŸç†</label></li></ul> <h3 id="ä¿è¯å¯è§æ€§"><a href="#ä¿è¯å¯è§æ€§" class="header-anchor">#</a> ä¿è¯å¯è§æ€§</h3> <p>æ¡ˆä¾‹æ¼”ç¤ºï¼š</p> <p>ä¸€ä¸ªçº¿ç¨‹æ ¹æ® boolean ç±»å‹çš„æ ‡è®° flagï¼Œ while å¾ªç¯ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜è¿™ä¸ª flag å˜é‡çš„å€¼ï¼Œå¦
ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœæ­¢å¾ªç¯ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo02_concurrent_problem</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01Visibility</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤šä¸ªçº¿ç¨‹éƒ½ä¼šè®¿é—®çš„æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¸ºçº¿ç¨‹çš„å…±äº«æ•°æ®</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¢åŠ å¯¹è±¡å…±äº«æ•°æ®çš„æ‰“å°ï¼Œprintlnæ˜¯åŒæ­¥æ–¹æ³•</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;run = &quot;</span> <span class="token operator">+</span> run<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ—¶é—´åˆ°ï¼Œçº¿ç¨‹2è®¾ç½®ä¸ºfalse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="ä¿è¯å¯è§æ€§çš„åŸç†"><a href="#ä¿è¯å¯è§æ€§çš„åŸç†" class="header-anchor">#</a> ä¿è¯å¯è§æ€§çš„åŸç†</h3> <p><img src="/blog/assets/img/3-2-1.08d0f77a.png" alt="" loading="lazy"></p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Synchronized ä¿è¯å¯è§æ€§çš„åŸç†ï¼Œæ‰§è¡Œ synchronized æ—¶ï¼Œä¼šå¯¹åº” lock åŸå­æ“ä½œä¼šåˆ·æ–°å·¥ä½œå†…å­˜ä¸­å…±äº«å˜
é‡çš„å€¼</p></div> <h2 id="synchronized-ä¸æœ‰åºæ€§"><a href="#synchronized-ä¸æœ‰åºæ€§" class="header-anchor">#</a> synchronized ä¸æœ‰åºæ€§</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-7" class="task-list-item-checkbox"><label for="task-item-7" class="task-list-item-label"> å­¦ä¹ ä½¿ç”¨ synchronized ä¿è¯æœ‰åºæ€§çš„åŸç†</label></li></ul> <h3 id="ä¸ºä»€ä¹ˆè¦é‡æ’åº"><a href="#ä¸ºä»€ä¹ˆè¦é‡æ’åº" class="header-anchor">#</a> ä¸ºä»€ä¹ˆè¦é‡æ’åº</h3> <p>ä¸ºäº†æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œç¼–è¯‘å™¨å’Œ CPU ä¼šå¯¹ç¨‹åºä¸­ä»£ç è¿›è¡Œé‡æ’åºã€‚</p> <h3 id="as-if-serial-è¯­ä¹‰"><a href="#as-if-serial-è¯­ä¹‰" class="header-anchor">#</a> as-if-serial è¯­ä¹‰</h3> <p>As-if-serial è¯­ä¹‰çš„æ„æ€æ˜¯ï¼šä¸ç®¡ç¼–è¯‘å™¨å’Œ CPU å¦‚ä½•é‡æ’åºï¼Œå¿…é¡»ä¿è¯åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ç¨‹åºçš„ç»“æœæ˜¯æ­£ç¡® çš„ã€‚</p> <p>ä»¥ä¸‹æ•°æ®æœ‰ä¾èµ–å…³ç³»ï¼Œä¸èƒ½é‡æ’åºã€‚</p> <p>å†™åè¯»ï¼š</p> <p><code>int a = 1; int b = a;</code></p> <p>å†™åå†™ï¼š</p> <p><code>int a = 1; int a = 2;</code></p> <p>è¯»åå†™ï¼š</p> <p><code>int a = 1; int b = a; int a = 2;</code></p> <p>ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚
æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå°±å¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚</p> <p><code>int a = 1; int b = 2; int c = a + b;</code></p> <p>ä¸Šé¢ 3 ä¸ªæ“ä½œçš„æ•°æ®ä¾èµ–å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š</p> <p>1574136281215</p> <p>å¦‚ä¸Šå›¾æ‰€ç¤º a å’Œ c ä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶ b å’Œ c ä¹‹é—´ä¹Ÿå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ã€‚å› æ­¤åœ¨æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åº
åˆ—ä¸­ï¼Œc ä¸èƒ½è¢«é‡æ’åºåˆ° a å’Œ b çš„å‰é¢ã€‚ä½† a å’Œ b ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥é‡æ’åº a å’Œ b
ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾æ˜¯è¯¥ç¨‹åºçš„ä¸¤ç§æ‰§è¡Œé¡ºåºã€‚</p> <p>1574136462820</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>å¯ä»¥è¿™æ ·ï¼š

int a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
int b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
int c <span class="token operator">=</span> a + b<span class="token punctuation">;</span>

ä¹Ÿå¯ä»¥é‡æ’åºè¿™æ ·ï¼š

int b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
int a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
int c <span class="token operator">=</span> a + b<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="æ¡ˆä¾‹æ¼”ç¤º-2"><a href="#æ¡ˆä¾‹æ¼”ç¤º-2" class="header-anchor">#</a> æ¡ˆä¾‹æ¼”ç¤º</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>concurrent_problem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jcstress<span class="token punctuation">.</span>infra<span class="token punctuation">.</span>results<span class="token punctuation">.</span></span><span class="token class-name">I_Result</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@JCStressTest</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span>ï¼Œ <span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span>ï¼Œ expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLEï¼Œ desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span>ï¼Œ expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTINGï¼Œ desc <span class="token operator">=</span> <span class="token string">&quot;danger&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test03Ordering</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// çº¿ç¨‹ä¸€æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç </span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="ä¿è¯æœ‰åºæ€§çš„åŸç†"><a href="#ä¿è¯æœ‰åºæ€§çš„åŸç†" class="header-anchor">#</a> ä¿è¯æœ‰åºæ€§çš„åŸç†</h3> <p>Synchronized åï¼Œè™½ç„¶è¿›è¡Œäº†é‡æ’åºï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¿›å…¥åŒæ­¥ä»£ç å—ï¼Œä¹Ÿèƒ½ä¿è¯æœ‰åºæ€§ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Synchronized ä¿è¯æœ‰åºæ€§çš„åŸç†ï¼Œæˆ‘ä»¬åŠ  synchronized åï¼Œä¾ç„¶ä¼šå‘ç”Ÿé‡æ’åºï¼Œåªä¸è¿‡ï¼Œæˆ‘ä»¬æœ‰åŒæ­¥
ä»£ç å—ï¼Œå¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ä¸­çš„ä»£ç ã€‚ä¿è¯æœ‰åºæ€§ã€‚</p></div> <h1 id="å››ã€synchronized-çš„ç‰¹æ€§"><a href="#å››ã€synchronized-çš„ç‰¹æ€§" class="header-anchor">#</a> å››ã€synchronized çš„ç‰¹æ€§</h1> <ul class="task-list-container"><li class="task-list-item"><p><input type="checkbox" disabled="disabled" id="task-item-8" class="task-list-item-checkbox"><label for="task-item-8" class="task-list-item-label"> äº†è§£ä»€ä¹ˆæ˜¯å¯é‡å…¥</label></p></li> <li class="task-list-item"><p><input type="checkbox" disabled="disabled" id="task-item-9" class="task-list-item-checkbox"><label for="task-item-9" class="task-list-item-label"> äº†è§£å¯é‡å…¥çš„åŸç†</label></p></li></ul> <h3 id="å¯é‡å…¥ç‰¹æ€§"><a href="#å¯é‡å…¥ç‰¹æ€§" class="header-anchor">#</a> å¯é‡å…¥ç‰¹æ€§</h3> <p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡æ‰§è¡Œ synchronized,é‡å¤è·å–åŒä¸€æŠŠé”ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo03_synchronized_nature</span><span class="token punctuation">;</span>
<span class="token comment">/*
å¯é‡å…¥ç‰¹æ€§
æŒ‡çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå¯ä»¥ç›´æ¥å†æ¬¡è·å–è¯¥é”ã€‚
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> sellTicket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Demo01</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘æ˜¯run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Demo01</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘æ˜¯test01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>sellTicket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>sellTicket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="å¯é‡å…¥çš„å¥½å¤„"><a href="#å¯é‡å…¥çš„å¥½å¤„" class="header-anchor">#</a> å¯é‡å…¥çš„å¥½å¤„</h3> <ol><li>å¯ä»¥é¿å…æ­»é”</li> <li>å¯ä»¥è®©æˆ‘ä»¬æ›´å¥½çš„æ¥å°è£…ä»£ç </li></ol> <h3 id="å¯é‡å…¥åŸç†"><a href="#å¯é‡å…¥åŸç†" class="header-anchor">#</a> å¯é‡å…¥åŸç†</h3> <p>Synchronized çš„é”å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªè®¡æ•°å™¨(recursions å˜é‡)ä¼šè®°å½•çº¿ç¨‹è·å¾—å‡ æ¬¡é”.</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Synchronized æ˜¯å¯é‡å…¥é”ï¼Œå†…éƒ¨é”å¯¹è±¡ä¸­ä¼šæœ‰ä¸€ä¸ªè®¡æ•°å™¨è®°å½•çº¿ç¨‹è·å–å‡ æ¬¡é”å•¦ï¼Œåœ¨æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—
æ—¶ï¼Œè®¡æ•°å™¨çš„æ•°é‡ä¼š-1ï¼ŒçŸ¥é“è®¡æ•°å™¨çš„æ•°é‡ä¸º 0ï¼Œå°±é‡Šæ”¾è¿™ä¸ªé”ã€‚</p></div> <h2 id="ä¸å¯ä¸­æ–­ç‰¹æ€§"><a href="#ä¸å¯ä¸­æ–­ç‰¹æ€§" class="header-anchor">#</a> ä¸å¯ä¸­æ–­ç‰¹æ€§</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-10" class="task-list-item-checkbox"><label for="task-item-10" class="task-list-item-label"> å­¦ä¹  synchronized ä¸å¯ä¸­æ–­ç‰¹æ€§</label></li> <li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-11" class="task-list-item-checkbox"><label for="task-item-11" class="task-list-item-label"> å­¦ä¹  Lock çš„å¯ä¸­æ–­ç‰¹æ€§</label></li></ul> <h3 id="æ¦‚å¿µ-4"><a href="#æ¦‚å¿µ-4" class="header-anchor">#</a> æ¦‚å¿µ</h3> <p>ä¸€ä¸ªçº¿ç¨‹è·å¾—é”åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å¾—é”ï¼Œå¿…é¡»å¤„äºé˜»å¡æˆ–ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸é‡Šæ”¾é”ï¼Œç¬¬ äºŒä¸ªçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡æˆ–ç­‰å¾…ï¼Œä¸å¯è¢«ä¸­æ–­ã€‚</p> <h3 id="ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º"><a href="#ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º" class="header-anchor">#</a> ä¸å¯ä¸­æ–­æ¼”ç¤ºæ¼”ç¤º</h3> <p>Synchronized æ˜¯ä¸å¯ä¸­æ–­ï¼Œå¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…é”ã€‚</p> <!----> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>ä¸å¯ä¸­æ–­æ˜¯æŒ‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´å¤„äºé˜»å¡æˆ–ç­‰å¾…çŠ¶æ€ï¼Œå‰ä¸€ä¸ªçº¿ç¨‹ä¸é‡Šæ”¾é”ï¼Œåä¸€ä¸ªçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡æˆ–ç­‰å¾…ï¼Œä¸å¯è¢«ä¸­æ–­ã€‚</p> <ul><li>Synchronized å±äºä¸å¯è¢«ä¸­æ–­</li> <li>Lock çš„ lock æ–¹æ³•æ˜¯ä¸å¯ä¸­æ–­çš„</li> <li>Lock çš„ tryLock æ–¹æ³•æ˜¯å¯ä¸­æ–­çš„</li></ul></div> <h1 id="äº”ã€synchronized-åŸç†"><a href="#äº”ã€synchronized-åŸç†" class="header-anchor">#</a> äº”ã€synchronized åŸç†</h1> <h2 id="javap-åæ±‡ç¼–"><a href="#javap-åæ±‡ç¼–" class="header-anchor">#</a> javap åæ±‡ç¼–</h2> <p>é€šè¿‡ javap åæ±‡ç¼–å­¦ä¹  synchronized çš„åŸç†</p> <p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ synchronized ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo04_synchronized_monitor</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æˆ‘ä»¬è¦çœ‹ synchronized çš„åŸç†ï¼Œä½†æ˜¯ synchronized æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œçœ‹ä¸åˆ°æºç ã€‚æˆ‘ä»¬å¯ä»¥å°† class æ–‡ä»¶
è¿›è¡Œåæ±‡ç¼–ã€‚</p> <p>JDK è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ï¼š javap ï¼Œå¯¹å­—èŠ‚ç è¿›è¡Œåæ±‡ç¼–ï¼ŒæŸ¥çœ‹å­—èŠ‚ç æŒ‡ä»¤ã€‚</p> <p>åœ¨ DOS å‘½ä»¤è¡Œè¾“å…¥ï¼š</p> <p>åæ±‡ç¼–åçš„æ•ˆæœå¦‚ä¸‹ï¼š</p> <p>Javap -p -v -c</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>`C:\Users\13666\IdeaProjects\HeiMa\Synchronized\target\classes\com\itheima\demo04 _synchronized_monitor\Increment.class`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>
public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
        stack=2, locals=4, args_size=1
        0: iconst_0
        1: istore_1
        2: getstatic #2 // Field obj:Ljava/lang/Object;
        5: dup
        6: astore_2
        7: monitorenter
        8: iinc 1, 1
        11: aload_2
        12: monitorexit
        13: goto 21
        16: astore_3
        17: aload_2
        18: monitorexit
        19: aload_3
        20: athrow
        21: return
        Exception table:
        from to target type
        8 13 16 any
        16 19 16 any
        LineNumberTable:
        line 8: 0
        line 9: 2
        line 10: 8
        line 11: 11
        line 12: 21
        LocalVariableTable:
        Start Length Slot Name Signature
        0 22 0 args [Ljava/lang/String;
        2 20 1 number I
        StackMapTable: number_of_entries = 2
        frame_type = 255 /* full_frame */
        offset_delta = 16
        locals = [ class &quot;[Ljava/lang/String;&quot;, int, class java/lang/Object ]
        stack = [ class java/lang/Throwable ]
        frame_type = 250 /* chop */
        offset_delta = 4
public synchronized void test();
        descriptor: ()V
        flags: ACC_PUBLIC, ACC_SYNCHRONIZED
        Code:
        stack=2, locals=1, args_size=1
        0: getstatic #3 // Field
        java/lang/System.out:Ljava/io/PrintStream;
        3: ldc #4 // String a
        5: invokevirtual #5 // Method
        java/io/PrintStream.println:(Ljava/lang/String;)V
        8: return
        LineNumberTable:
        line 15: 0
        line 16: 8
        LocalVariableTable:
        Start Length Slot Name Signature
        0 9 0 this
        Lcom/itheima/demo04_synchronized_monitor/Demo01;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>}</p> <p><img src="/blog/assets/img/5-1-1.fc9c37e7.png" alt="" loading="lazy"></p> <h3 id="monitorenter"><a href="#monitorenter" class="header-anchor">#</a> monitorenter</h3> <p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JVM è§„èŒƒä¸­å¯¹äº monitorenter çš„æè¿°ï¼š</p> <p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorenter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>Each object is associated with a monitor. A monitor is locked if and only if it has an owner.
The thread that executes monitorenter attempts to gain ownership of the monitor
associated with objectrefï¼Œ as follows: â€¢ If the entry count of the monitor associated with
objectref is zeroï¼Œ the thread enters the monitor and sets its entry count to one. The thread
is then the owner of the monitor. â€¢ If the thread already owns the monitor associated with
objectrefï¼Œ it reenters the monitorï¼Œ incrementing its entry count. â€¢ If another thread
already owns the monitor associated with objectrefï¼Œ the thread blocks until the monitorâ€™s
entry count is zeroï¼Œ then tries again to gain ownership.</p></blockquote> <p>ç¿»è¯‘è¿‡æ¥ï¼š æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¼šå’Œä¸€ä¸ªç›‘è§†å™¨ monitor å…³è”ã€‚</p> <p>ç›‘è§†å™¨è¢«å ç”¨æ—¶ä¼šè¢«é”ä½ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•æ¥è· å–è¯¥ monitorã€‚</p> <p>å½“ JVM æ‰§è¡ŒæŸä¸ªçº¿ç¨‹çš„æŸä¸ªæ–¹æ³•å†…éƒ¨çš„ monitorenter æ—¶ï¼Œå®ƒä¼šå°è¯•å»è·å–å½“å‰å¯¹è±¡å¯¹åº” çš„ monitor çš„æ‰€æœ‰æƒã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p> <ol><li>è‹¥ monior çš„è¿›å…¥æ•°ä¸º 0ï¼Œçº¿ç¨‹å¯ä»¥è¿›å…¥ monitorï¼Œå¹¶å°† monitor çš„è¿›å…¥æ•°ç½®ä¸º 1ã€‚å½“å‰çº¿ç¨‹æˆä¸º monitor çš„ owner(æ‰€æœ‰è€…)</li> <li>è‹¥çº¿ç¨‹å·²æ‹¥æœ‰ monitor çš„æ‰€æœ‰æƒï¼Œå…è®¸å®ƒé‡å…¥ monitorï¼Œåˆ™è¿›å…¥ monitor çš„è¿›å…¥æ•°åŠ  1</li> <li>è‹¥å…¶ä»–çº¿ç¨‹å·²ç»å æœ‰ monitor çš„æ‰€æœ‰æƒï¼Œé‚£ä¹ˆå½“å‰å°è¯•è·å– monitor çš„æ‰€æœ‰æƒçš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´ åˆ° monitor çš„è¿›å…¥æ•°å˜ä¸º 0ï¼Œæ‰èƒ½é‡æ–°å°è¯•è·å– monitor çš„æ‰€æœ‰æƒã€‚</li></ol> <div class="custom-block info"><p class="custom-block-title">Monitorenter å°ç»“</p> <p>Synchronized çš„é”å¯¹è±¡ä¼šå…³è”ä¸€ä¸ª monitor,è¿™ä¸ª monitor ä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨åˆ›å»ºçš„,æ˜¯ JVM çš„çº¿ç¨‹æ‰§è¡Œåˆ°è¿™ä¸ª
åŒæ­¥ä»£ç å—,å‘ç°é”å¯¹è±¡æ²¡æœ‰ monitor å°±ä¼šåˆ›å»º monitor,monitor å†…éƒ¨æœ‰ä¸¤ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ owner:æ‹¥æœ‰
è¿™æŠŠé”çš„çº¿ç¨‹,recursions ä¼šè®°å½•çº¿ç¨‹æ‹¥æœ‰é”çš„æ¬¡æ•°,å½“ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ monitor åå…¶ä»–çº¿ç¨‹åªèƒ½ç­‰å¾…</p></div> <h3 id="monitorexit"><a href="#monitorexit" class="header-anchor">#</a> monitorexit</h3> <p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JVM è§„èŒƒä¸­å¯¹äº monitorexit çš„æè¿°ï¼š</p> <p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.monitorexit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>The thread that executes monitorexit must be the owner of the monitor associated with the
instance referenced by objectref. The thread decrements the entry count of the monitor
associated with objectref. If as a result the value of the entry count is zeroï¼Œ the thread
exits the monitor and is no longer its owner. Other threads that are blocking to enter the
monitor are allowed to attempt to do so.</p></blockquote> <p>ç¿»è¯‘è¿‡æ¥ï¼š</p> <ol><li>èƒ½æ‰§è¡Œ monitorexit æŒ‡ä»¤çš„çº¿ç¨‹ä¸€å®šæ˜¯æ‹¥æœ‰å½“å‰å¯¹è±¡çš„ monitor çš„æ‰€æœ‰æƒçš„çº¿ç¨‹ã€‚</li> <li>æ‰§è¡Œ monitorexit æ—¶ä¼šå°† monitor çš„è¿›å…¥æ•°å‡ 1ã€‚å½“ monitor çš„è¿›å…¥æ•°å‡ä¸º 0 æ—¶ï¼Œå½“å‰çº¿ç¨‹é€€å‡º
monitorï¼Œä¸å†æ‹¥æœ‰ monitor çš„æ‰€æœ‰æƒï¼Œæ­¤æ—¶å…¶ä»–è¢«è¿™ä¸ª monitor é˜»å¡çš„çº¿ç¨‹å¯ä»¥å°è¯•å»è·å–è¿™ä¸ª
monitor çš„æ‰€æœ‰æƒ
monitorexit é‡Šæ”¾é”ã€‚</li></ol> <p>Monitorexit æ’å…¥åœ¨æ–¹æ³•ç»“æŸå¤„å’Œå¼‚å¸¸å¤„ï¼ŒJVM ä¿è¯æ¯ä¸ª monitorenter å¿…é¡»æœ‰å¯¹åº”çš„ monitorexitã€‚</p> <p>é—®é¢˜ synchroznied å‡ºç°å¼‚å¸¸ä¼šé‡Šæ”¾é”å—?</p> <p>ä¼šé‡Šæ”¾é”</p> <h3 id="åŒæ­¥æ–¹æ³•"><a href="#åŒæ­¥æ–¹æ³•" class="header-anchor">#</a> åŒæ­¥æ–¹æ³•</h3> <p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11.10<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>å¯ä»¥çœ‹åˆ°åŒæ­¥æ–¹æ³•åœ¨åæ±‡ç¼–åï¼Œä¼šå¢åŠ  ACC_SYNCHRONIZED ä¿®é¥°ã€‚ä¼šéšå¼è°ƒç”¨ monitorenter å’Œ
monitorexitã€‚åœ¨æ‰§è¡ŒåŒæ­¥æ–¹æ³•å‰ä¼šè°ƒç”¨ monitorenterï¼Œåœ¨æ‰§è¡Œå®ŒåŒæ­¥æ–¹æ³•åä¼šè°ƒç”¨ monitorexitã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>é€šè¿‡ javap åæ±‡ç¼–æˆ‘ä»¬çœ‹åˆ° synchronized ä½¿ç”¨ç¼–ç¨‹äº† monitorentor å’Œ monitorexit ä¸¤ä¸ªæŒ‡ä»¤ã€‚</p> <p>æ¯ä¸ªé”å¯¹è±¡éƒ½ä¼šå…³è”ä¸€ä¸ª monitor(ç›‘è§†å™¨,å®ƒæ‰æ˜¯çœŸæ­£çš„é”å¯¹è±¡),å®ƒå†…éƒ¨æœ‰ä¸¤ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š</p> <ul><li>owner ä¼šä¿å­˜è·å¾—é”çš„çº¿ç¨‹,</li> <li>recursions ä¼šä¿å­˜çº¿ç¨‹è·å¾—é”çš„æ¬¡æ•°,</li></ul> <p>å½“æ‰§è¡Œåˆ° monitorexit æ—¶,recursions ä¼š-1,å½“è®¡æ•°å™¨å‡åˆ° 0 æ—¶è¿™ä¸ªçº¿ç¨‹å°±ä¼šé‡Šæ”¾é”ã€‚</p></div> <h3 id="é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«"><a href="#é—®é¢˜-synchronized-ä¸-lock-çš„åŒºåˆ«" class="header-anchor">#</a> é—®é¢˜ï¼šsynchronized ä¸ Lock çš„åŒºåˆ«</h3> <ol><li>synchronized æ˜¯å…³é”®å­—ï¼Œè€Œ Lock æ˜¯ä¸€ä¸ªæ¥å£ã€‚</li> <li>synchronized ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œè€Œ Lock å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾é”ã€‚</li> <li>synchronized æ˜¯ä¸å¯ä¸­æ–­çš„ï¼ŒLock å¯ä»¥ä¸­æ–­ä¹Ÿå¯ä»¥ä¸ä¸­æ–­ã€‚</li> <li>é€šè¿‡ Lock å¯ä»¥çŸ¥é“çº¿ç¨‹æœ‰æ²¡æœ‰æ‹¿åˆ°é”ï¼Œè€Œ synchronized ä¸èƒ½ã€‚</li> <li>synchronized èƒ½é”ä½æ–¹æ³•å’Œä»£ç å—ï¼Œè€Œ Lock åªèƒ½é”ä½ä»£ç å—ã€‚</li> <li>Lock å¯ä»¥ä½¿ç”¨è¯»é”æé«˜å¤šçº¿ç¨‹è¯»æ•ˆç‡ã€‚</li> <li>synchronized æ˜¯éå…¬å¹³é”ï¼ŒReentrantLock å¯ä»¥æ§åˆ¶æ˜¯å¦æ˜¯å…¬å¹³é”ã€‚</li></ol> <h2 id="æ·±å…¥-jvm-æºç "><a href="#æ·±å…¥-jvm-æºç " class="header-anchor">#</a> æ·±å…¥ JVM æºç </h2> <p>é€šè¿‡ JVM æºç åˆ†æ synchronized çš„åŸç†</p> <h3 id="jvm-æºç ä¸‹è½½"><a href="#jvm-æºç ä¸‹è½½" class="header-anchor">#</a> JVM æºç ä¸‹è½½</h3> <p><a href="http://openjdk.java.net/" target="_blank" rel="noopener noreferrer">http://openjdk.java.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> --&gt; Mercurial --&gt; jdk8 --&gt; hotspot --&gt; zip</p> <h3 id="ide-clion-ä¸‹è½½"><a href="#ide-clion-ä¸‹è½½" class="header-anchor">#</a> IDE(Clion )ä¸‹è½½</h3> <p><a href="https://www.jetbrains.com/" target="_blank" rel="noopener noreferrer">https://www.jetbrains.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="monitor-ç›‘è§†å™¨é”"><a href="#monitor-ç›‘è§†å™¨é”" class="header-anchor">#</a> monitor ç›‘è§†å™¨é”</h3> <p>å¯ä»¥çœ‹å‡ºæ— è®ºæ˜¯ synchronized ä»£ç å—è¿˜æ˜¯ synchronized æ–¹æ³•ï¼Œå…¶çº¿ç¨‹å®‰å…¨çš„è¯­ä¹‰å®ç°æœ€ç»ˆä¾èµ–ä¸€ä¸ªå« monitor çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆè¿™ä¸ªç¥ç§˜çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢è®©æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p> <p>åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œmonitor æ˜¯ç”± ObjectMonitor å®ç°çš„ã€‚å…¶æºç æ˜¯ç”¨ c++æ¥å®ç°çš„ï¼Œä½äº HotSpot è™š æ‹Ÿæœºæºç  ObjectMonitor.hpp æ–‡ä»¶ä¸­(src/share/vm/runtime/objectMonitor.hpp)ã€‚ObjectMonitor ä¸» è¦æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token function">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
_header <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
_waiters <span class="token operator">=</span> <span class="token number">0</span>ï¼Œ
_recursions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°</span>
_object <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å­˜å‚¨è¯¥monitorçš„å¯¹è±¡</span>
_owner <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// æ ‡è¯†æ‹¥æœ‰è¯¥monitorçš„çº¿ç¨‹</span>
_WaitSet <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°_WaitSet</span>
_WaitSetLock <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
_Responsible <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
_succ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
_cxq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å¤šçº¿ç¨‹ç«äº‰é”æ—¶çš„å•å‘åˆ—è¡¨</span>
FreeNext <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
_EntryList <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å¤„äºç­‰å¾…é”blockçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°è¯¥åˆ—è¡¨</span>
_SpinFreq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
_SpinClock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
OwnerIsThread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol><li>_ownerï¼šåˆå§‹æ—¶ä¸º NULLã€‚å½“æœ‰çº¿ç¨‹å æœ‰è¯¥ monitor æ—¶ï¼Œowner æ ‡è®°ä¸ºè¯¥çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ã€‚å½“çº¿ç¨‹
é‡Šæ”¾ monitor æ—¶ï¼Œowner åˆæ¢å¤ä¸º NULLã€‚owner æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æºï¼ŒJVM æ˜¯é€šè¿‡ CAS æ“ä½œæ¥ä¿è¯å…¶çº¿
ç¨‹å®‰å…¨çš„ã€‚</li> <li>_cxqï¼šç«äº‰é˜Ÿåˆ—ï¼Œæ‰€æœ‰è¯·æ±‚é”çš„çº¿ç¨‹é¦–å…ˆä¼šè¢«æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­(å•å‘é“¾æ¥)ã€‚_cxq æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„
æºï¼ŒJVM é€šè¿‡ CAS åŸå­æŒ‡ä»¤æ¥ä¿®æ”¹_cxq é˜Ÿåˆ—ã€‚ä¿®æ”¹å‰_cxq çš„æ—§å€¼å¡«å…¥äº† Node.js çš„ next å­—æ®µï¼Œ_cxq æŒ‡
å‘æ–°å€¼(æ–°çº¿ç¨‹)ã€‚å› æ­¤_cxq æ˜¯ä¸€ä¸ªåè¿›å…ˆå‡ºçš„ stack(æ ˆ)ã€‚</li> <li>_EntryListï¼š_cxq é˜Ÿåˆ—ä¸­æœ‰èµ„æ ¼æˆä¸ºå€™é€‰èµ„æºçš„çº¿ç¨‹ä¼šè¢«ç§»åŠ¨åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚</li> <li>_WaitSetï¼šå› ä¸ºè°ƒç”¨ wait æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«æ”¾åœ¨è¯¥é˜Ÿåˆ—ä¸­ã€‚</li></ol> <p>æ¯ä¸€ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥ä¸ä¸€ä¸ªç›‘è§†å™¨ monitor å…³è”ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸ºä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦æ‰§
è¡Œä¸€æ®µè¢« synchronized åœˆèµ·æ¥çš„åŒæ­¥æ–¹æ³•æˆ–è€…ä»£ç å—æ—¶ï¼Œè¯¥çº¿ç¨‹å¾—å…ˆè·å–åˆ° synchronized ä¿®é¥°çš„å¯¹è±¡
å¯¹åº”çš„ monitorã€‚</p> <p>æˆ‘ä»¬çš„ Java ä»£ç é‡Œä¸ä¼šæ˜¾ç¤ºåœ°å»åˆ›é€ è¿™ä¹ˆä¸€ä¸ª monitor å¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿæ— éœ€åˆ›å»ºï¼Œäº‹å®ä¸Šå¯ä»¥è¿™ä¹ˆç†è§£ï¼š
monitor å¹¶ä¸æ˜¯éšç€å¯¹è±¡åˆ›å»ºè€Œåˆ›å»ºçš„ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡ synchronized ä¿®é¥°ç¬¦å‘Šè¯‰ JVM éœ€è¦ä¸ºæˆ‘ä»¬çš„æŸä¸ªå¯¹
è±¡åˆ›å»ºå…³è”çš„ monitor å¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å­˜åœ¨ä¸¤ä¸ª ObjectMonitor å¯¹è±¡åˆ—è¡¨ï¼Œåˆ†åˆ«ä¸º free å’Œ used åˆ—è¡¨ã€‚
åŒæ—¶ JVM ä¸­ä¹Ÿç»´æŠ¤ç€ global locklistã€‚å½“çº¿ç¨‹éœ€è¦ ObjectMonitor å¯¹è±¡æ—¶ï¼Œé¦–å…ˆä»çº¿ç¨‹è‡ªèº«çš„ free è¡¨ä¸­ç”³
è¯·ï¼Œè‹¥å­˜åœ¨åˆ™ä½¿ç”¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä» global list ä¸­ç”³è¯·ã€‚</p> <p>ObjectMonitor çš„æ•°æ®ç»“æ„ä¸­åŒ…å«ï¼š_ownerã€_WaitSet å’Œ_EntryListï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»è½¬æ¢å¯ä»¥ç”¨ä¸‹å›¾
è¡¨ç¤ºï¼š</p> <p><img src="/blog/assets/img/5-2-1.33af8996.png" alt="" loading="lazy"></p> <h3 id="monitor-ç«äº‰"><a href="#monitor-ç«äº‰" class="header-anchor">#</a> monitor ç«äº‰</h3> <ol><li>æ‰§è¡Œ monitorenter æ—¶ï¼Œä¼šè°ƒç”¨ InterpreterRuntime.cpp
(ä½äºï¼šsrc/share/vm/interpreter/interpreterRuntime.cpp) çš„ InterpreterRuntime::monitorenter å‡½
æ•°ã€‚å…·ä½“ä»£ç å¯å‚è§ HotSpot æºç ã€‚</li></ol> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token function">IRT_ENTRY_NO_ASYNC</span><span class="token punctuation">(</span><span class="token keyword">void</span>ï¼Œ InterpreterRuntime<span class="token operator">::</span><span class="token function">monitorenter</span><span class="token punctuation">(</span>JavaThread<span class="token operator">*</span> threadï¼Œ
BasicObjectLock<span class="token operator">*</span> elem<span class="token punctuation">)</span><span class="token punctuation">)</span> #ifdef ASSERT thread<span class="token operator">-&gt;</span><span class="token function">last_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpreter_frame_verify_monitor</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span> #endif
<span class="token keyword">if</span> <span class="token punctuation">(</span>PrintBiasedLockingStatistics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
Atomic<span class="token operator">::</span><span class="token function">inc</span><span class="token punctuation">(</span>BiasedLocking<span class="token operator">::</span><span class="token function">slow_path_entry_count_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Handle <span class="token function">h_obj</span><span class="token punctuation">(</span>threadï¼Œ elem<span class="token operator">-&gt;</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_in_reserved_or_null</span><span class="token punctuation">(</span><span class="token function">h_obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ï¼Œ
<span class="token string">&quot;must be NULL or an object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>UseBiasedLocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Retry fast entry if bias is revoked to avoid unnecessary inflation</span>
ObjectSynchronizer<span class="token operator">::</span><span class="token function">fast_enter</span><span class="token punctuation">(</span>h_objï¼Œ elem<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼Œ trueï¼Œ CHECK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
ObjectSynchronizer<span class="token operator">::</span><span class="token function">slow_enter</span><span class="token punctuation">(</span>h_objï¼Œ elem<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼Œ CHECK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">assert</span><span class="token punctuation">(</span>Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_in_reserved_or_null</span><span class="token punctuation">(</span>elem<span class="token operator">-&gt;</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ï¼Œ
<span class="token string">&quot;must be NULL or an object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>2.å¯¹äºé‡é‡çº§é”ï¼Œmonitorenter å‡½æ•°ä¸­ä¼šè°ƒç”¨ ObjectSynchronizer::slow_enter</p> <p>3.æœ€ç»ˆè°ƒç”¨ ObjectMonitor::enter(ä½äºï¼šsrc/share/vm/runtime/objectMonitor.cpp)ï¼Œæºç å¦‚ä¸‹ï¼š</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">enter</span><span class="token punctuation">(</span>TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// The following code is ordered to check the most common cases first</span>
<span class="token comment">// and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.</span>
Thread <span class="token operator">*</span> <span class="token keyword">const</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span> cur <span class="token punctuation">;</span>
<span class="token comment">// é€šè¿‡CASæ“ä½œå°è¯•æŠŠmonitorçš„_ownerå­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹</span>
cur <span class="token operator">=</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>Selfï¼Œ <span class="token operator">&amp;</span>_ownerï¼Œ <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Either ASSERT _recursions == 0 or explicitly set _recursions = 0.</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span> ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Selfï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">// CONSIDER: set or assert OwnerIsThread == 1</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çº¿ç¨‹é‡å…¥ï¼Œrecursions++</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> Self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// TODO-FIXME: check for integer overflow! BUGID 6557169.</span>
_recursions <span class="token operator">++</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥monitorï¼Œè®¾ç½®_recursionsä¸º1ï¼Œ_ownerä¸ºå½“å‰çº¿ç¨‹</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span>ï¼Œ <span class="token string">&quot;internal state error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
_recursions <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token comment">// Commute owner from a thread-specific on-stack BasicLockObject address to</span>
<span class="token comment">// a full-fledged &quot;Thread *&quot;.</span>
_owner <span class="token operator">=</span> Self <span class="token punctuation">;</span>
OwnerIsThread <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çœç•¥ä¸€äº›ä»£ç </span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
jt<span class="token operator">-&gt;</span><span class="token function">set_suspend_equivalent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// cleared by handle_special_suspend_equivalent_condition()</span>
<span class="token comment">// or java_suspend_self()</span>
<span class="token comment">// å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç­‰å¾…é”çš„é‡Šæ”¾ï¼›</span>
<span class="token function">EnterI</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ExitSuspendEquivalent</span><span class="token punctuation">(</span>jt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
<span class="token comment">//</span>
<span class="token comment">// We have acquired the contended monitorï¼Œ but while we were</span>
<span class="token comment">// waiting another thread suspended us. We don't want to enter</span>
<span class="token comment">// the monitor while suspended because that would surprise the</span>
<span class="token comment">// thread that suspended us.</span>
<span class="token comment">//</span>
_recursions <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
_succ <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
<span class="token function">exit</span> <span class="token punctuation">(</span>falseï¼Œ Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>
jt<span class="token operator">-&gt;</span><span class="token function">java_suspend_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Self<span class="token operator">-&gt;</span><span class="token function">set_current_pending_monitor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>æ­¤å¤„çœç•¥é”çš„è‡ªæ—‹ä¼˜åŒ–ç­‰æ“ä½œï¼Œç»Ÿä¸€æ”¾åœ¨åé¢ synchronzied ä¼˜åŒ–ä¸­è¯´ã€‚
ä»¥ä¸Šä»£ç çš„å…·ä½“æµç¨‹æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p> <ol><li>é€šè¿‡ CAS å°è¯•æŠŠ monitor çš„ owner å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚</li> <li>å¦‚æœè®¾ç½®ä¹‹å‰çš„ owner æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹å†æ¬¡è¿›å…¥ monitorï¼Œå³é‡å…¥é”ï¼Œæ‰§è¡Œ
recursions ++ ï¼Œè®°å½•é‡å…¥çš„æ¬¡æ•°ã€‚</li> <li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥ monitorï¼Œè®¾ç½® recursions ä¸º 1ï¼Œ_owner ä¸ºå½“å‰çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹æˆåŠŸè·
å¾—é”å¹¶è¿”å›ã€‚</li> <li>å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç­‰å¾…é”çš„é‡Šæ”¾ã€‚</li></ol> <h3 id="monitor-ç­‰å¾…"><a href="#monitor-ç­‰å¾…" class="header-anchor">#</a> monitor ç­‰å¾…</h3> <p>ç«äº‰å¤±è´¥ç­‰å¾…è°ƒç”¨çš„æ˜¯ ObjectMonitor å¯¹è±¡çš„ EnterI æ–¹æ³•ï¼ˆä½äºï¼š
src/share/vm/runtime/objectMonitor.cppï¼‰ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">EnterI</span> <span class="token punctuation">(</span>TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
Thread <span class="token operator">*</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
<span class="token comment">// Try the lock - TATAS</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryLock</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_succ <span class="token operator">!=</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_Responsible <span class="token operator">!=</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TrySpin</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_succ <span class="token operator">!=</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_Responsible <span class="token operator">!=</span> Self <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
<span class="token comment">// å½“å‰çº¿ç¨‹è¢«å°è£…æˆObjectWaiterå¯¹è±¡nodeï¼ŒçŠ¶æ€è®¾ç½®æˆObjectWaiter::TS_CXQï¼›</span>
ObjectWaiter <span class="token function">node</span><span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>
Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
node<span class="token punctuation">.</span>_prev <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0xBAD</span> <span class="token punctuation">;</span>
node<span class="token punctuation">.</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ <span class="token punctuation">;</span>
<span class="token comment">// é€šè¿‡CASæŠŠnodeèŠ‚ç‚¹pushåˆ°_cxqåˆ—è¡¨ä¸­</span>
ObjectWaiter <span class="token operator">*</span> nxt <span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
node<span class="token punctuation">.</span>_next <span class="token operator">=</span> nxt <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>nodeï¼Œ <span class="token operator">&amp;</span>_cxqï¼Œ nxt<span class="token punctuation">)</span> <span class="token operator">==</span> nxt<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
<span class="token comment">// Interference - the CAS failed because _cxq changed. Just retry.</span>
<span class="token comment">// As an optional optimization we retry the lock.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryLock</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_succ <span class="token operator">!=</span> Self ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_Responsible <span class="token operator">!=</span> Self ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// çº¿ç¨‹åœ¨è¢«æŒ‚èµ·å‰åšä¸€ä¸‹æŒ£æ‰ï¼Œçœ‹èƒ½ä¸èƒ½è·å–åˆ°é”</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryLock</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">!=</span> Selfï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SyncFlags <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _Responsible <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>Selfï¼Œ <span class="token operator">&amp;</span>_Responsibleï¼Œ <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// é€šè¿‡parkå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’</span>
Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryLock</span><span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
<span class="token punctuation">}</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>å½“è¯¥çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡ ObjectMonitor::TryLock å°è¯•è·å–é”ï¼ŒTryLock æ–¹
æ³•å®ç°å¦‚ä¸‹ï¼š</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code>    <span class="token keyword">int</span> ObjectMonitor<span class="token operator">::</span>

    <span class="token function">TryLock</span><span class="token punctuation">(</span>Thread <span class="token operator">*</span>Self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">void</span> <span class="token operator">*</span>own <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>own <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>Selfï¼Œ <span class="token operator">&amp;</span>_ownerï¼Œ<span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// Either guarantee _recursions == 0 or set _recursions = 0.</span>
                <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span>ï¼Œ<span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Selfï¼Œ<span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// CONSIDER: set or assert that OwnerIsThread == 1</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ä»¥ä¸Šä»£ç çš„å…·ä½“æµç¨‹æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p> <ol><li>å½“å‰çº¿ç¨‹è¢«å°è£…æˆ ObjectWaiter å¯¹è±¡ nodeï¼ŒçŠ¶æ€è®¾ç½®æˆ ObjectWaiter::TS_CXQã€‚</li> <li>åœ¨ for å¾ªç¯ä¸­ï¼Œé€šè¿‡ CAS æŠŠ Node.js èŠ‚ç‚¹ push åˆ°_cxq åˆ—è¡¨ä¸­ï¼ŒåŒä¸€æ—¶åˆ»å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹æŠŠè‡ªå·±çš„ node
èŠ‚ç‚¹ push åˆ°_cxq åˆ—è¡¨ä¸­ã€‚</li> <li>Node.js èŠ‚ç‚¹ push åˆ°_cxq åˆ—è¡¨ä¹‹åï¼Œé€šè¿‡è‡ªæ—‹å°è¯•è·å–é”ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™é€šè¿‡ park å°†å½“
å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</li> <li>å½“è¯¥çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡ ObjectMonitor::TryLock å°è¯•è·å–é”ã€‚</li></ol> <h3 id="monitor-é‡Šæ”¾"><a href="#monitor-é‡Šæ”¾" class="header-anchor">#</a> monitor é‡Šæ”¾</h3> <p>å½“æŸä¸ªæŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼šè¿›è¡Œé”çš„é‡Šæ”¾ï¼Œç»™å…¶å®ƒçº¿ç¨‹æœºä¼šæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œåœ¨
HotSpot ä¸­ï¼Œé€šè¿‡é€€å‡º monitor çš„æ–¹å¼å®ç°é”çš„é‡Šæ”¾ï¼Œå¹¶é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå…·ä½“å®ç°ä½äº
ObjectMonitor çš„ exit æ–¹æ³•ä¸­ã€‚(ä½äºï¼šsrc/share/vm/runtime/objectMonitor.cpp)ï¼Œæºç å¦‚ä¸‹æ‰€
ç¤ºï¼š</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">exit</span><span class="token punctuation">(</span>bool not_suspendedï¼Œ TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">exit</span><span class="token punctuation">(</span>bool not_suspendedï¼Œ TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread <span class="token operator">*</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_recursions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _recursions<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">// this is simple recursive enter</span>
        <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> recursive<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
        ObjectWaiter <span class="token operator">*</span> w <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
        <span class="token keyword">int</span> QMode <span class="token operator">=</span> Knob_QMode <span class="token punctuation">;</span>
<span class="token comment">// qmode = 2ï¼šç›´æ¥ç»•è¿‡EntryListé˜Ÿåˆ—ï¼Œä»cxqé˜Ÿåˆ—ä¸­è·å–çº¿ç¨‹ç”¨äºç«äº‰é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span>ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Selfï¼Œ w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">// qmode =3ï¼šcxqé˜Ÿåˆ—æ’å…¥EntryListå°¾éƒ¨ï¼›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span>ï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span>ï¼Œ
        <span class="token operator">&amp;</span>_cxqï¼Œ w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
        w <span class="token operator">=</span> u <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span> ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
        q <span class="token operator">=</span> p <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ObjectWaiter <span class="token operator">*</span> Tail <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Tail <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span> Tail <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> Tail<span class="token operator">-&gt;</span>_next <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> Tail <span class="token operator">=</span>
        Tail<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Tail <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Tail<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> w <span class="token punctuation">;</span>
        w<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> Tail <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token comment">// qmode =4ï¼šcxqé˜Ÿåˆ—æ’å…¥åˆ°_EntryListå¤´éƒ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span>ï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span>ï¼Œ
        <span class="token operator">&amp;</span>_cxqï¼Œ w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
        w <span class="token operator">=</span> u <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span> ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
        q <span class="token operator">=</span> p <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_EntryList <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        q<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span>
        _EntryList<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        w <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTERï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Selfï¼Œ w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span> <span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span>ï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span>ï¼Œ <span class="token operator">&amp;</span>_cxqï¼Œ
        w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
        w <span class="token operator">=</span> u <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> drain cxq into EntryList<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span> ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>_EntryList <span class="token operator">==</span> <span class="token constant">NULL</span> ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// QMode == 1 : drain cxq to EntryListï¼Œ reversing order</span>
<span class="token comment">// We also reverse the order of the list.</span>
        ObjectWaiter <span class="token operator">*</span> s <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> t <span class="token operator">=</span> w <span class="token punctuation">;</span>
        ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">guarantee</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
        u <span class="token operator">=</span> t<span class="token operator">-&gt;</span>_next <span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> u <span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> s <span class="token punctuation">;</span>
        s <span class="token operator">=</span> t<span class="token punctuation">;</span>
        t <span class="token operator">=</span> u <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _EntryList <span class="token operator">=</span> s <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token constant">NULL</span>ï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><ol><li>é€€å‡ºåŒæ­¥ä»£ç å—æ—¶ä¼šè®©_recursions å‡ 1ï¼Œå½“_recursions çš„å€¼å‡ä¸º 0 æ—¶ï¼Œè¯´æ˜çº¿ç¨‹é‡Šæ”¾äº†é”ã€‚</li> <li>æ ¹æ®ä¸åŒçš„ç­–ç•¥(ç”± QMode æŒ‡å®š)ï¼Œä» cxq æˆ– EntryList ä¸­è·å–å¤´èŠ‚ç‚¹ï¼Œé€šè¿‡
ObjectMonitor::ExitEpilog æ–¹æ³•å”¤é†’è¯¥èŠ‚ç‚¹å°è£…çš„çº¿ç¨‹ï¼Œå”¤é†’æ“ä½œæœ€ç»ˆç”± unpark å®Œæˆï¼Œå®ç°
å¦‚ä¸‹ï¼š</li></ol> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment">// QMode == 0 or QMode == 2</span>
_EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>
ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQï¼Œ <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
q <span class="token operator">=</span> p <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>_succ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
w <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">guarantee</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTERï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Selfï¼Œ w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ObjectMonitor<span class="token operator">::</span><span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Thread <span class="token operator">*</span> Selfï¼Œ ObjectWaiter <span class="token operator">*</span> Wakee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Selfï¼Œ <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
_succ <span class="token operator">=</span> Knob_SuccEnabled <span class="token operator">?</span> Wakee<span class="token operator">-&gt;</span>_thread <span class="token operator">:</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
ParkEvent <span class="token operator">*</span> Trigger <span class="token operator">=</span> Wakee<span class="token operator">-&gt;</span>_event <span class="token punctuation">;</span>
Wakee <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
<span class="token comment">// Drop the lock</span>
OrderAccess<span class="token operator">::</span><span class="token function">release_store_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_ownerï¼Œ <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
OrderAccess<span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> <span class="token comment">// ST _owner vs LD in</span>
<span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>SafepointSynchronize<span class="token operator">::</span><span class="token function">do_call_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">TEVENT</span> <span class="token punctuation">(</span>unpark before SAFEPOINT<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">DTRACE_MONITOR_PROBE</span><span class="token punctuation">(</span>contended__exitï¼Œ thisï¼Œ <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼Œ Self<span class="token punctuation">)</span><span class="token punctuation">;</span>
Trigger<span class="token operator">-&gt;</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> <span class="token comment">// å”¤é†’ä¹‹å‰è¢«pack()æŒ‚èµ·çš„çº¿ç¨‹.</span>
<span class="token comment">// Maintain stats and report events to JVMTI</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ObjectMonitor<span class="token operator">::</span>_sync_Parks <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
ObjectMonitor<span class="token operator">::</span>_sync_Parks<span class="token operator">-&gt;</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>è¢«å”¤é†’çš„çº¿ç¨‹ï¼Œä¼šå›åˆ° void ATTR ObjectMonitor::EnterI (TRAPS) çš„ç¬¬ 600 è¡Œï¼Œç»§ç»­æ‰§è¡Œ monitor
çš„ç«äº‰ã€‚</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">// park self</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>_Responsible <span class="token operator">==</span> Self <span class="token operator">||</span> <span class="token punctuation">(</span>SyncFlags <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated enter <span class="token operator">-</span> park TIMED<span class="token punctuation">)</span> <span class="token punctuation">;</span>
Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">park</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>jlong<span class="token punctuation">)</span> RecheckInterval<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">// Increase the RecheckIntervalï¼Œ but clamp the value.</span>
RecheckInterval <span class="token operator">*=</span> <span class="token number">8</span> <span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>RecheckInterval <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> RecheckInterval <span class="token operator">=</span> <span class="token number">1000</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated enter <span class="token operator">-</span> park UNTIMED<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">// The lock had been free momentarilyï¼Œ but we lost the race to the lock.</span>
<span class="token comment">// Interference -- the CAS failed.</span>
<span class="token comment">// We can either return -1 or retry.</span>
<span class="token comment">// Retry doesn't make as much sense because the lock was just acquired.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="monitor-æ˜¯é‡é‡çº§é”"><a href="#monitor-æ˜¯é‡é‡çº§é”" class="header-anchor">#</a> monitor æ˜¯é‡é‡çº§é”</h3> <p>å¯ä»¥çœ‹åˆ° ObjectMonitor çš„å‡½æ•°è°ƒç”¨ä¸­ä¼šæ¶‰åŠåˆ° Atomic::cmpxchg_ptrï¼ŒAtomic::inc_ptr ç­‰å†…æ ¸å‡½æ•°ï¼Œ æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œæ²¡æœ‰ç«äº‰åˆ°é”çš„å¯¹è±¡ä¼š park()è¢«æŒ‚èµ·ï¼Œç«äº‰åˆ°é”çš„çº¿ç¨‹ä¼š unpark()å”¤é†’ã€‚</p> <p>è¿™ä¸ªæ—¶å€™å°± ä¼šå­˜åœ¨æ“ä½œç³»ç»Ÿç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢ï¼Œè¿™ç§åˆ‡æ¢ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚</p> <p>æ‰€ä»¥ synchronized æ˜¯ Java è¯­ è¨€ä¸­æ˜¯ä¸€ä¸ªé‡é‡çº§(Heavyweight)çš„æ“ä½œã€‚</p> <h4 id="ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€"><a href="#ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€" class="header-anchor">#</a> ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€</h4> <p>ç”¨æˆ·æ€å’Œå’Œå†…æ ¸æ€æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿè¦æƒ³äº†è§£ç”¨æˆ·æ€å’Œå†…æ ¸æ€è¿˜éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ Linux ç³»ç»Ÿçš„ä½“ç³»æ¶æ„ï¼š</p> <p><img src="/blog/assets/img/5-2-2.4362c14f.png" alt="" loading="lazy"></p> <p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒLinux æ“ä½œç³»ç»Ÿçš„ä½“ç³»æ¶æ„åˆ†ä¸ºï¼šç”¨æˆ·ç©ºé—´(åº”ç”¨ç¨‹åºçš„æ´»åŠ¨ç©ºé—´)å’Œå†…æ ¸ã€‚</p> <p>å†…æ ¸ï¼šæœ¬è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºä¸€ç§è½¯ä»¶ï¼Œæ§åˆ¶è®¡ç®—æœºçš„ç¡¬ä»¶èµ„æºï¼Œå¹¶æä¾›ä¸Šå±‚åº”ç”¨ç¨‹åºè¿è¡Œçš„ç¯å¢ƒã€‚</p> <p>ç”¨æˆ·ç©ºé—´ï¼šä¸Šå±‚åº”ç”¨ç¨‹åºæ´»åŠ¨çš„ç©ºé—´ã€‚åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¿…é¡»ä¾æ‰˜äºå†…æ ¸æä¾›çš„èµ„æºï¼ŒåŒ…æ‹¬ CPU èµ„æºã€å­˜
å‚¨èµ„æºã€I/O èµ„æºç­‰ã€‚</p> <p>ç³»ç»Ÿè°ƒç”¨ï¼šä¸ºäº†ä½¿ä¸Šå±‚åº”ç”¨èƒ½å¤Ÿè®¿é—®åˆ°è¿™äº›èµ„æºï¼Œå†…æ ¸å¿…é¡»ä¸ºä¸Šå±‚åº”ç”¨æä¾›è®¿é—®çš„æ¥å£ï¼šå³ç³»ç»Ÿè°ƒç”¨ã€‚</p> <p>æ‰€æœ‰è¿›ç¨‹åˆå§‹éƒ½è¿è¡Œäºç”¨æˆ·ç©ºé—´ï¼Œæ­¤æ—¶å³ä¸ºç”¨æˆ·è¿è¡ŒçŠ¶æ€(ç®€ç§°ï¼šç”¨æˆ·æ€)ï¼›ä½†æ˜¯å½“å®ƒè°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ‰§
è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¾‹å¦‚ I/O è°ƒç”¨ï¼Œæ­¤æ—¶éœ€è¦é™·å…¥å†…æ ¸ä¸­è¿è¡Œï¼Œæˆ‘ä»¬å°±ç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆæˆ–ç®€ç§°ä¸ºå†…
æ ¸æ€ï¼‰ã€‚ ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š</p> <ol><li>ç”¨æˆ·æ€ç¨‹åºå°†ä¸€äº›æ•°æ®å€¼æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œ æˆ–è€…ä½¿ç”¨å‚æ•°åˆ›å»ºä¸€ä¸ªå †æ ˆï¼Œ ä»¥æ­¤è¡¨æ˜éœ€è¦æ“ä½œç³»ç»Ÿæ
ä¾›çš„æœåŠ¡ã€‚</li> <li>ç”¨æˆ·æ€ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</li> <li>CPU åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå¹¶è·³åˆ°ä½äºå†…å­˜æŒ‡å®šä½ç½®çš„æŒ‡ä»¤ã€‚</li> <li>ç³»ç»Ÿè°ƒç”¨å¤„ç†å™¨(system call handler)ä¼šè¯»å–ç¨‹åºæ”¾å…¥å†…å­˜çš„æ•°æ®å‚æ•°ï¼Œå¹¶æ‰§è¡Œç¨‹åºè¯·æ±‚çš„æœåŠ¡ã€‚</li> <li>ç³»ç»Ÿè°ƒç”¨å®Œæˆåï¼Œæ“ä½œç³»ç»Ÿä¼šé‡ç½® CPU ä¸ºç”¨æˆ·æ€å¹¶è¿”å›ç³»ç»Ÿè°ƒç”¨çš„ç»“æœã€‚</li></ol> <p>ç”±æ­¤å¯è§ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€éœ€è¦ä¼ é€’è®¸å¤šå˜é‡ï¼ŒåŒæ—¶å†…æ ¸è¿˜éœ€è¦ä¿æŠ¤å¥½ç”¨æˆ·æ€åœ¨åˆ‡æ¢æ—¶çš„ä¸€äº›å¯„å­˜å™¨
å€¼ã€å˜é‡ç­‰ï¼Œä»¥å¤‡å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚è¿™ç§åˆ‡æ¢å°±å¸¦æ¥äº†å¤§é‡çš„ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œè¿™å°±æ˜¯åœ¨
synchronized æœªä¼˜åŒ–ä¹‹å‰ï¼Œæ•ˆç‡ä½çš„åŸå› ã€‚</p> <h1 id="å…­ã€jdk6-synchronized-ä¼˜åŒ–"><a href="#å…­ã€jdk6-synchronized-ä¼˜åŒ–" class="header-anchor">#</a> å…­ã€JDK6 synchronized ä¼˜åŒ–</h1> <h2 id="cas"><a href="#cas" class="header-anchor">#</a> CAS</h2> <ul class="task-list-container"><li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-12" class="task-list-item-checkbox"><label for="task-item-12" class="task-list-item-label"> å­¦ä¹  CAS çš„ä½œç”¨</label></li> <li class="task-list-item"><input type="checkbox" disabled="disabled" id="task-item-13" class="task-list-item-checkbox"><label for="task-item-13" class="task-list-item-label"> å­¦ä¹  CAS çš„åŸç†</label></li></ul> <h3 id="æ¦‚å¿µ-5"><a href="#æ¦‚å¿µ-5" class="header-anchor">#</a> æ¦‚å¿µ</h3> <p>CAS çš„å…¨æˆæ˜¯ï¼š Compare And Swap(æ¯”è¾ƒç›¸åŒå†äº¤æ¢)ã€‚æ˜¯ç°ä»£ CPU å¹¿æ³›æ”¯æŒçš„ä¸€ç§å¯¹å†…å­˜ä¸­çš„å…±äº«æ•°
æ®è¿›è¡Œæ“ä½œçš„ä¸€ç§ç‰¹æ®ŠæŒ‡ä»¤ã€‚</p> <p>CAS çš„ä½œç”¨ï¼šCAS å¯ä»¥å°†æ¯”è¾ƒå’Œäº¤æ¢è½¬æ¢ä¸ºåŸå­æ“ä½œï¼Œè¿™ä¸ªåŸå­æ“ä½œç›´æ¥ç”± CPU ä¿è¯ã€‚CAS å¯ä»¥ä¿è¯å…± äº«å˜é‡èµ‹å€¼æ—¶çš„åŸå­æ“ä½œã€‚</p> <p>CAS æ“ä½œä¾èµ– 3 ä¸ªå€¼ï¼šå†…å­˜ä¸­çš„å€¼ Vï¼Œæ—§çš„é¢„ä¼°å€¼ Xï¼Œè¦ä¿®æ”¹çš„æ–°å€¼ Bï¼Œå¦‚æœæ—§ çš„é¢„ä¼°å€¼ X ç­‰äºå†…å­˜ä¸­çš„å€¼ Vï¼Œå°±å°†æ–°çš„å€¼ B ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚</p> <h3 id="cas-å’Œ-volatile-å®ç°æ— é”å¹¶å‘"><a href="#cas-å’Œ-volatile-å®ç°æ— é”å¹¶å‘" class="header-anchor">#</a> CAS å’Œ volatile å®ç°æ— é”å¹¶å‘</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>demo05_cas</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runnable</span> mr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> t <span class="token operator">:</span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span> <span class="token operator">+</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="cas-åŸç†"><a href="#cas-åŸç†" class="header-anchor">#</a> CAS åŸç†</h3> <p>é€šè¿‡åˆšæ‰ AtomicInteger çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒUnsafe ç±»æä¾›äº†åŸå­æ“ä½œã€‚</p> <h4 id="unsafe-ç±»ä»‹ç»"><a href="#unsafe-ç±»ä»‹ç»" class="header-anchor">#</a> Unsafe ç±»ä»‹ç»</h4> <p>Unsafe ç±»ä½¿ Java æ‹¥æœ‰äº†åƒ C è¯­è¨€çš„æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†æŒ‡é’ˆçš„é—®é¢˜ã€‚è¿‡åº¦çš„ä½¿
ç”¨ Unsafe ç±»ä¼šä½¿å¾—å‡ºé”™çš„å‡ ç‡å˜å¤§ï¼Œå› æ­¤ Java å®˜æ–¹å¹¶ä¸å»ºè®®ä½¿ç”¨çš„ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿå‡ ä¹æ²¡æœ‰ã€‚Unsafe å¯¹
è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—ã€‚</p> <p><img src="/blog/assets/img/6-1-1.be9c234c.png" alt="" loading="lazy"></p> <h4 id="unsafe-å®ç°-cas"><a href="#unsafe-å®ç°-cas" class="header-anchor">#</a> Unsafe å®ç° CAS</h4> <p><img src="/blog/assets/img/6-1-2.4cd1cc2f.png" alt="" loading="lazy"></p> <h4 id="ä¹è§‚é”å’Œæ‚²è§‚é”"><a href="#ä¹è§‚é”å’Œæ‚²è§‚é”" class="header-anchor">#</a> ä¹è§‚é”å’Œæ‚²è§‚é”</h4> <p><strong>æ‚²è§‚é”</strong>ä»æ‚²è§‚çš„è§’åº¦å‡ºå‘ï¼š</p> <p>æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™ æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ã€‚å› æ­¤ synchronized æˆ‘ä»¬ä¹Ÿå°†å…¶ç§°ä¹‹ä¸ºæ‚²è§‚é”ã€‚JDK ä¸­çš„ ReentrantLock ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ã€‚æ€§èƒ½è¾ƒå·®ï¼</p> <p><strong>ä¹è§‚é”</strong>ä»ä¹è§‚çš„è§’åº¦å‡ºå‘:</p> <p>æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œå†é‡è¯•å³å¯ã€‚æ‰€ ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»ä¿®æ”¹è¿™ä¸ªæ•°æ®ï¼Œå¦‚ä½•æ²¡æœ‰äººä¿®æ”¹åˆ™æ›´ æ–°ï¼Œå¦‚æœæœ‰äººä¿®æ”¹åˆ™é‡è¯•ã€‚</p> <p>CAS è¿™ç§æœºåˆ¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶ç§°ä¹‹ä¸ºä¹è§‚é”ã€‚ç»¼åˆæ€§èƒ½è¾ƒå¥½ï¼</p> <blockquote><p>CAS è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚ç»“åˆ CAS å’Œ volatile å¯ä»¥
å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚</p></blockquote> <ol><li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€ã€‚</li> <li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“ã€‚</li></ol> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>CAS çš„ä½œç”¨ï¼š Compare And Swapï¼ŒCAS å¯ä»¥å°†æ¯”è¾ƒå’Œäº¤æ¢è½¬æ¢ä¸ºåŸå­æ“ä½œï¼Œè¿™ä¸ªåŸå­æ“ä½œç›´æ¥ç”±å¤„ç† å™¨ä¿è¯ã€‚</p> <p>CAS çš„åŸç†ï¼š CAS éœ€è¦ 3 ä¸ªå€¼:å†…å­˜åœ°å€ Vï¼Œæ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼ Bï¼Œå¦‚æœå†…å­˜åœ°å€ V å’Œæ—§çš„é¢„æœŸå€¼ A ç›¸ç­‰å°±ä¿®æ”¹å†…å­˜åœ°å€å€¼ä¸º B</p></div> <h2 id="synchronized-é”å‡çº§è¿‡ç¨‹"><a href="#synchronized-é”å‡çº§è¿‡ç¨‹" class="header-anchor">#</a> synchronized é”å‡çº§è¿‡ç¨‹</h2> <p>é«˜æ•ˆå¹¶å‘æ˜¯ä» JDK 5 åˆ° JDK 6 çš„ä¸€ä¸ªé‡è¦æ”¹è¿›ï¼ŒHotSpot è™›æ‹Ÿæœºå¼€å‘å›¢é˜Ÿåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸ŠèŠ±è´¹äº†å¤§é‡çš„ç²¾åŠ› å»å®ç°å„ç§é”ä¼˜åŒ–æŠ€æœ¯ï¼ŒåŒ…æ‹¬åå‘é”( Biased Locking )ã€è½»é‡çº§é”( Lightweight Locking )å’Œå¦‚é€‚åº”æ€§ è‡ªæ—‹(Adaptive Spinning)ã€é”æ¶ˆé™¤( Lock Elimination)ã€é”ç²—åŒ–( Lock Coarsening )ç­‰ï¼Œè¿™äº›æŠ€æœ¯éƒ½æ˜¯ä¸º äº†åœ¨çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œä»¥åŠè§£å†³ç«äº‰é—®é¢˜ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p> <p>æ— é”--ã€‹åå‘é”--ã€‹è½»é‡çº§é”â€“ã€‹é‡é‡çº§é”</p> <h2 id="java-å¯¹è±¡çš„å¸ƒå±€"><a href="#java-å¯¹è±¡çš„å¸ƒå±€" class="header-anchor">#</a> Java å¯¹è±¡çš„å¸ƒå±€</h2> <p>å­¦ä¹  Java å¯¹è±¡çš„å¸ƒå±€</p> <p>æœ¯è¯­å‚è€ƒ: <a href="http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.HTML" target="_blank" rel="noopener noreferrer">http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.HTML<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>åœ¨ JVM ä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="/blog/assets/img/6-3-1.3db36e22.png" alt="" loading="lazy"></p> <h3 id="å¯¹è±¡å¤´"><a href="#å¯¹è±¡å¤´" class="header-anchor">#</a> å¯¹è±¡å¤´</h3> <p>å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è®¿é—® synchronized ä¿®é¥°çš„ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆè¦è·å¾—é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”åˆ°åº•å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p> <p>æ˜¯ å­˜åœ¨é”å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­çš„ã€‚</p> <p>HotSpot é‡‡ç”¨ instanceOopDesc å’Œ arrayOopDesc æ¥æè¿°å¯¹è±¡å¤´ï¼ŒarrayOopDesc å¯¹è±¡ç”¨æ¥æè¿°æ•°ç»„ç±»
å‹ã€‚InstanceOopDesc çš„å®šä¹‰çš„åœ¨ Hotspot æºç çš„ instanceOop.hpp æ–‡ä»¶ä¸­ï¼Œå¦å¤–ï¼ŒarrayOopDesc
çš„å®šä¹‰å¯¹åº” arrayOop.hpp ã€‚</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code>class instanceOopDesc <span class="token operator">:</span> public oopDesc <span class="token punctuation">{</span>
public<span class="token operator">:</span>
<span class="token comment">// aligned header size.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">header_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>instanceOopDesc<span class="token punctuation">)</span><span class="token operator">/</span>HeapWordSize<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// If compressed, the offset of the fields of the instance may not be aligned.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">base_offset_in_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// offset computation code breaks if UseCompressedClassPointers</span>
<span class="token comment">// only is true</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>UseCompressedOops <span class="token operator">&amp;&amp;</span> UseCompressedClassPointers<span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token function">klass_gap_offset_in_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>instanceOopDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token keyword">static</span> bool <span class="token function">contains_field_offset</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> nonstatic_field_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> base_in_bytes <span class="token operator">=</span> <span class="token function">base_offset_in_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;=</span> base_in_bytes <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>offset<span class="token operator">-</span>base_in_bytes<span class="token punctuation">)</span> <span class="token operator">&lt;</span> nonstatic_field_size <span class="token operator">*</span> heapOopSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>ä» instanceOopDesc ä»£ç ä¸­å¯ä»¥çœ‹åˆ° instanceOopDesc ç»§æ‰¿è‡ª oopDescï¼ŒoopDesc çš„å®šä¹‰è½½ Hotspot
æºç ä¸­çš„ oop.hpp æ–‡ä»¶ä¸­ã€‚</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code>class oopDesc <span class="token punctuation">{</span>
    friend class VMStructs<span class="token punctuation">;</span>
    private<span class="token operator">:</span>
    <span class="token keyword">volatile</span> markOop _mark<span class="token punctuation">;</span>
    <span class="token keyword">union</span> _metadata <span class="token punctuation">{</span>
        Klass<span class="token operator">*</span> _klass<span class="token punctuation">;</span>
        narrowKlass _compressed_klass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> _metadata<span class="token punctuation">;</span>
<span class="token comment">// Fast access to barrier set. Must be initialized.</span>
    <span class="token keyword">static</span> BarrierSet<span class="token operator">*</span> _bs<span class="token punctuation">;</span>
<span class="token comment">// çœç•¥å…¶ä»–ä»£ç </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/blog/assets/img/6-3-2.9416beed.png" alt="" loading="lazy"></p> <p>åœ¨æ™®é€šå®ä¾‹å¯¹è±¡ä¸­ï¼ŒoopDesc çš„å®šä¹‰åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œåˆ†åˆ«æ˜¯ _mark å’Œ _metadata</p> <p>_mark è¡¨ç¤ºå¯¹è±¡æ ‡è®°ã€å±äº markOop ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥è¦è®²è§£çš„ Mark Worldï¼Œå®ƒè®°å½•äº†å¯¹è±¡å’Œé”æœ‰
å…³çš„ä¿¡æ¯</p> <p>_metadata è¡¨ç¤ºç±»å…ƒä¿¡æ¯ï¼Œç±»å…ƒä¿¡æ¯å­˜å‚¨çš„æ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®(Klass)çš„é¦–åœ°å€ï¼Œå…¶ä¸­ Klass è¡¨ç¤º
æ™®é€šæŒ‡é’ˆã€ _compressed_klass è¡¨ç¤ºå‹ç¼©ç±»æŒ‡é’ˆã€‚</p> <div class="custom-block info"><p class="custom-block-title">å°ç»“</p> <p>å¯¹è±¡å¤´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œç§°ä¹‹ä¸º Mark Wordï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯ç±»å‹æŒ‡
é’ˆï¼ŒåŠå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆã€‚</p></div> <h4 id="mark-word"><a href="#mark-word" class="header-anchor">#</a> Mark Word</h4> <p>Mark Word ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç (HashCode)ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€ çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ç­‰ï¼Œå ç”¨å†…å­˜å¤§å°ä¸è™šæ‹Ÿæœºä½é•¿ä¸€è‡´ã€‚Mark Word å¯¹åº”çš„ç±» å‹æ˜¯ markOop ã€‚æºç ä½äº markOop.hpp ä¸­ã€‚</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Bit-format of an object header (most significant first, big endian layout</span>
below<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token comment">//</span>
<span class="token comment">// 32 bits:</span>
<span class="token comment">// --------</span>
<span class="token comment">// hash:25 ------------&gt;| age:4 biased_lock:1 lock:2 (normal</span>
object<span class="token punctuation">)</span>
<span class="token comment">// JavaThread*:23 epoch:2 age:4 biased_lock:1 lock:2 (biased</span>
object<span class="token punctuation">)</span>
<span class="token comment">// size:32 ------------------------------------------&gt;| (CMS free</span>
block<span class="token punctuation">)</span>
<span class="token comment">// PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS</span>
promoted object<span class="token punctuation">)</span>
<span class="token comment">//</span>
<span class="token comment">// 64 bits:</span>
<span class="token comment">// --------</span>
<span class="token comment">// unused:25 hash:31 --&gt;| unused:1 age:4 biased_lock:1 lock:2 (normal</span>
object<span class="token punctuation">)</span>
<span class="token comment">// JavaThread*:54 epoch:2 unused:1 age:4 biased_lock:1 lock:2 (biased</span>
object<span class="token punctuation">)</span>
<span class="token comment">// PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS</span>
promoted object<span class="token punctuation">)</span>
<span class="token comment">// size:64 -----------------------------------------------------&gt;| (CMS free</span>
block<span class="token punctuation">)</span>
<span class="token comment">// [JavaThread* | epoch | age | 1 | 01] lock is biased toward given</span>
thread
<span class="token comment">// [0 | epoch | age | 1 | 01] lock is anonymously biased</span>
<span class="token comment">//</span>
<span class="token comment">// - the two lock bits are used to describe three states: locked/unlocked and</span>
monitor<span class="token punctuation">.</span>
<span class="token comment">//</span>
<span class="token comment">// [ptr | 00] locked ptr points to real header on</span>
stack
<span class="token comment">// [header | 0 | 01] unlocked regular object header</span>
<span class="token comment">// [ptr | 10] monitor inflated lock (header is wapped</span>
out<span class="token punctuation">)</span>
<span class="token comment">// [ptr | 11] marked used by markSweep to mark an</span>
object
<span class="token comment">// not valid at any other time</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><img src="/blog/assets/img/6-3-3.22a85845.png" alt="" loading="lazy"></p> <p>åœ¨ 64 ä½è™šæ‹Ÿæœºä¸‹ï¼ŒMark Word æ˜¯ 64bit å¤§å°çš„ï¼Œå…¶å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="/blog/assets/img/6-3-4.b949f532.png" alt="" loading="lazy"></p> <p>åœ¨ 32 ä½è™šæ‹Ÿæœºä¸‹ï¼ŒMark Word æ˜¯ 32bit å¤§å°çš„ï¼Œå…¶å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="/blog/assets/img/6-3-5.076af0f1.png" alt="" loading="lazy"></p> <h4 id="klass-pointer"><a href="#klass-pointer" class="header-anchor">#</a> klass pointer</h4> <p>è¿™ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡çš„ç±»å‹æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®ï¼ŒJVM é€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„ å®ä¾‹ã€‚</p> <p>è¯¥æŒ‡é’ˆçš„ä½é•¿åº¦ä¸º JVM çš„ä¸€ä¸ªå­—å¤§å°ï¼Œå³ 32 ä½çš„ JVM ä¸º 32 ä½ï¼Œ64 ä½çš„ JVM ä¸º 64 ä½ã€‚</p> <p>å¦‚æœåº”ç”¨çš„å¯¹ è±¡è¿‡å¤šï¼Œä½¿ç”¨ 64 ä½çš„æŒ‡é’ˆå°†æµªè´¹å¤§é‡å†…å­˜ï¼Œç»Ÿè®¡è€Œè¨€ï¼Œ64 ä½çš„ JVM å°†ä¼šæ¯” 32 ä½çš„ JVM å¤šè€—è´¹ 50%çš„å†… å­˜ã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜å¯ä»¥ä½¿ç”¨é€‰é¡¹ -XX:+UseCompressedOops å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œå…¶ä¸­ï¼Œoop å³ ordinary object pointer æ™®é€šå¯¹è±¡æŒ‡é’ˆã€‚å¼€å¯è¯¥é€‰é¡¹åï¼Œä¸‹åˆ—æŒ‡é’ˆå°†å‹ç¼©è‡³ 32 ä½ï¼š</p> <ol><li>æ¯ä¸ª Class çš„å±æ€§æŒ‡é’ˆ(å³é™æ€å˜é‡)</li> <li>æ¯ä¸ªå¯¹è±¡çš„å±æ€§æŒ‡é’ˆ(å³å¯¹è±¡å˜é‡)</li> <li>æ™®é€šå¯¹è±¡æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æŒ‡é’ˆ</li></ol> <p>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æŒ‡é’ˆéƒ½ä¼šå‹ç¼©ï¼Œä¸€äº›ç‰¹æ®Šç±»å‹çš„æŒ‡é’ˆ JVM ä¸ä¼šä¼˜åŒ–ï¼Œæ¯”å¦‚æŒ‡å‘ PermGen çš„ Class å¯¹ è±¡æŒ‡é’ˆ(JDK8 ä¸­æŒ‡å‘å…ƒç©ºé—´çš„ Class å¯¹è±¡æŒ‡é’ˆ)ã€æœ¬åœ°å˜é‡ã€å †æ ˆå…ƒç´ ã€å…¥å‚ã€è¿”å›å€¼å’Œ NULL æŒ‡é’ˆç­‰ã€‚ å¯¹è±¡å¤´ = Mark Word + ç±»å‹æŒ‡é’ˆ(æœªå¼€å¯æŒ‡é’ˆå‹ç¼©çš„æƒ…å†µä¸‹)</p> <p>åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼ŒMark Word = 4 bytesï¼Œç±»å‹æŒ‡é’ˆ = 4bytesï¼Œå¯¹è±¡å¤´ = 8 bytes = 64 bitsï¼›
åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼ŒMark Word = 8 bytesï¼Œç±»å‹æŒ‡é’ˆ = 8bytesï¼Œå¯¹è±¡å¤´ = 16 bytes = 128bitsï¼›</p> <h3 id="å®ä¾‹æ•°æ®"><a href="#å®ä¾‹æ•°æ®" class="header-anchor">#</a> å®ä¾‹æ•°æ®</h3> <p>å°±æ˜¯ç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡ã€‚</p> <h3 id="å¯¹é½å¡«å……"><a href="#å¯¹é½å¡«å……" class="header-anchor">#</a> å¯¹é½å¡«å……</h3> <p>å¯¹é½å¡«å……å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„ä¹‰ï¼Œä»–ä»…ä»…èµ·ç€å ä½ç¬¦çš„ä½œç”¨ã€‚</p> <p>ç”±äºHotSpot-VMçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚è€Œå¯¹è±¡å¤´æ­£å¥½æ˜¯8å­—èŠ‚çš„å€æ•°ï¼Œå› æ­¤ï¼Œå½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½æ—¶ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨ã€‚</p> <h3 id="æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€"><a href="#æŸ¥çœ‹-java-å¯¹è±¡å¸ƒå±€" class="header-anchor">#</a> æŸ¥çœ‹ Java å¯¹è±¡å¸ƒå±€</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>Java å¯¹è±¡ç”± 3 éƒ¨åˆ†ç»„æˆï¼Œå¯¹è±¡å¤´ï¼Œå®ä¾‹æ•°æ®ï¼Œå¯¹é½æ•°æ®</p> <p>å¯¹è±¡å¤´åˆ†æˆä¸¤éƒ¨åˆ†ï¼šMark World + Klass pointer</p></div> <h2 id="åå‘é”"><a href="#åå‘é”" class="header-anchor">#</a> åå‘é”</h2> <p>å­¦ä¹ åå‘é”çš„åŸç†å’Œå¥½å¤„</p> <h3 id="ä»€ä¹ˆæ˜¯åå‘é”"><a href="#ä»€ä¹ˆæ˜¯åå‘é”" class="header-anchor">#</a> ä»€ä¹ˆæ˜¯åå‘é”</h3> <p>åå‘é”æ˜¯ JDK 6 ä¸­çš„é‡è¦å¼•è¿›ï¼Œå› ä¸º HotSpot ä½œè€…ç»è¿‡ç ”ç©¶å®è·µå‘ç°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤š çº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½ï¼Œå¼•è¿›äº†åå‘é”ã€‚</p> <p>åå‘é”çš„â€œåâ€ï¼Œå°±æ˜¯åå¿ƒçš„â€œåâ€ã€åè¢’çš„â€œåâ€ï¼Œå®ƒçš„æ„æ€æ˜¯è¿™ä¸ªé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹ï¼Œä¼šåœ¨å¯¹ è±¡å¤´å­˜å‚¨é”åå‘çš„çº¿ç¨‹ IDï¼Œä»¥åè¯¥çº¿ç¨‹è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶åªéœ€è¦æ£€æŸ¥æ˜¯å¦ä¸ºåå‘é”ã€é”æ ‡å¿—ä½ä»¥åŠ ThreadID å³å¯ã€‚</p> <p><img src="/blog/assets/img/6-4-1.f38252c3.png" alt="" loading="lazy"></p> <p>ä¸è¿‡ä¸€æ—¦å‡ºç°å¤šä¸ªçº¿ç¨‹ç«äº‰æ—¶å¿…é¡»æ’¤é”€åå‘é”ï¼Œæ‰€ä»¥æ’¤é”€åå‘é”æ¶ˆè€—çš„æ€§èƒ½å¿…é¡»å°äºä¹‹å‰èŠ‚çœä¸‹æ¥çš„ CAS åŸå­æ“ä½œçš„æ€§èƒ½æ¶ˆè€—ï¼Œä¸ç„¶å°±å¾—ä¸å¿å¤±äº†ã€‚</p> <h3 id="åå‘é”åŸç†"><a href="#åå‘é”åŸç†" class="header-anchor">#</a> åå‘é”åŸç†</h3> <p>å½“çº¿ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®åŒæ­¥å—å¹¶è·å–é”æ—¶ï¼Œåå‘é”å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p> <blockquote><ol><li>è™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼Œå³åå‘æ¨¡å¼ã€‚</li> <li>åŒæ—¶ä½¿ç”¨ CAS æ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„ ID è®°å½•åœ¨å¯¹è±¡çš„ Mark Word ä¹‹ä¸­ ï¼Œå¦‚æœ CAS æ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é”çš„æ•ˆç‡é«˜ã€‚</li></ol></blockquote> <p><img src="/blog/assets/img/6-4-2.b17f3669.png" alt="" loading="lazy"></p> <p>æŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é” çš„æ•ˆç‡é«˜ã€‚</p> <h3 id="åå‘é”çš„æ’¤é”€"><a href="#åå‘é”çš„æ’¤é”€" class="header-anchor">#</a> åå‘é”çš„æ’¤é”€</h3> <ol><li>åå‘é”çš„æ’¤é”€åŠ¨ä½œå¿…é¡»ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹</li> <li>æš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€</li> <li>æ’¤é”€åå‘é”ï¼Œæ¢å¤åˆ°æ— é”(æ ‡å¿—ä½ä¸º 01)æˆ–è½»é‡çº§é”(æ ‡å¿—ä½ä¸º 00)çš„çŠ¶æ€</li></ol> <p>åå‘é”åœ¨ Java 6 ä¹‹åæ˜¯é»˜è®¤å¯ç”¨çš„ï¼Œä½†åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‡ ç§’é’Ÿä¹‹åæ‰æ¿€æ´»ï¼Œå¯ä»¥ä½¿ç”¨ -</p> <p><code>XX:BiasedLockingStartupDelay=0</code> å‚æ•°å…³é—­å»¶è¿Ÿï¼Œå¦‚æœç¡®å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰é”é€šå¸¸æƒ…å†µä¸‹å¤„äºç«äº‰ çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ <code>XX:-UseBiasedLocking=false</code> å‚æ•°å…³é—­åå‘é”ã€‚</p> <h3 id="åå‘é”å¥½å¤„"><a href="#åå‘é”å¥½å¤„" class="header-anchor">#</a> åå‘é”å¥½å¤„</h3> <p>åå‘é”æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºä¸€ä¸ªçº¿ç¨‹åå¤è·å¾—åŒä¸€é”çš„æƒ…å†µã€‚åå‘ é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚</p> <p>å®ƒåŒæ ·æ˜¯ä¸€ä¸ªå¸¦æœ‰æ•ˆç›Šæƒè¡¡æ€§è´¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¹¶ä¸ä¸€å®šæ€»æ˜¯å¯¹ç¨‹åºè¿è¡Œæœ‰åˆ©ï¼Œå¦‚æœç¨‹åºä¸­å¤§å¤š æ•°çš„é”æ€»æ˜¯è¢«å¤šä¸ªä¸åŒçš„çº¿ç¨‹è®¿é—®æ¯”å¦‚çº¿ç¨‹æ± ï¼Œé‚£åå‘æ¨¡å¼å°±æ˜¯å¤šä½™çš„ã€‚</p> <p>åœ¨ JDK5 ä¸­åå‘é”é»˜è®¤æ˜¯å…³é—­çš„ï¼Œè€Œåˆ°äº† JDK6 ä¸­åå‘é”å·²ç»é»˜è®¤å¼€å¯ã€‚</p> <p>ä½†åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‡ ç§’é’Ÿä¹‹åæ‰ æ¿€æ´»ï¼Œå¯ä»¥ä½¿ç”¨ <code>-XX:BiasedLockingStartupDelay=0</code> å‚æ•°å…³é—­å»¶è¿Ÿï¼Œå¦‚æœç¡®å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰é”é€šå¸¸ æƒ…å†µä¸‹å¤„äºç«äº‰çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ <code>XX:-UseBiasedLocking=false</code> å‚æ•°å…³é—­åå‘é”ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>åå‘é”çš„åŸç†æ˜¯ä»€ä¹ˆ?
åå‘é”çš„å¥½å¤„æ˜¯ä»€ä¹ˆ?</p></div> <h2 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="header-anchor">#</a> è½»é‡çº§é”</h2> <p>å­¦ä¹ è½»é‡çº§é”çš„åŸç†å’Œå¥½å¤„</p> <h3 id="ä»€ä¹ˆæ˜¯è½»é‡çº§é”"><a href="#ä»€ä¹ˆæ˜¯è½»é‡çº§é”" class="header-anchor">#</a> ä»€ä¹ˆæ˜¯è½»é‡çº§é”</h3> <p>è½»é‡çº§é”æ˜¯ JDK 6 ä¹‹ä¸­åŠ å…¥çš„æ–°å‹é”æœºåˆ¶ï¼Œå®ƒåå­—ä¸­çš„â€œè½»é‡çº§â€æ˜¯ç›¸å¯¹äºä½¿ç”¨ monitor çš„ä¼ ç»Ÿé”è€Œè¨€çš„ï¼Œ å› æ­¤ä¼ ç»Ÿçš„é”æœºåˆ¶å°±ç§°ä¸ºâ€œé‡é‡çº§â€é”ã€‚</p> <p>é¦–å…ˆéœ€è¦å¼ºè°ƒä¸€ç‚¹çš„æ˜¯ï¼Œè½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ã€‚</p> <p>å¼•å…¥è½»é‡çº§é”çš„ç›®çš„ï¼šåœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå°½é‡é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†æ˜¯å¦‚ æœå¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¼šå¯¼è‡´è½»é‡çº§é”è†¨èƒ€å‡çº§é‡é‡çº§é”ï¼Œæ‰€ä»¥è½»é‡çº§é”çš„å‡ºç°å¹¶éæ˜¯è¦ æ›¿ä»£é‡é‡çº§é”ã€‚</p> <h3 id="è½»é‡çº§é”åŸç†"><a href="#è½»é‡çº§é”åŸç†" class="header-anchor">#</a> è½»é‡çº§é”åŸç†</h3> <p>å½“å…³é—­åå‘é”åŠŸèƒ½æˆ–è€…å¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”å¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œåˆ™ä¼šå°è¯•è·å–è½»é‡çº§é”ï¼Œå…¶æ­¥ éª¤å¦‚ä¸‹ï¼š</p> <p>è·å–é” å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼Œå³åå‘æ¨¡å¼ã€‚åŒæ—¶ä½¿ç”¨ CAS æ“ ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„ ID è®°å½•åœ¨å¯¹è±¡çš„ Mark Word ä¹‹ä¸­ ï¼Œå¦‚æœ CAS æ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯ æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåå‘é”çš„æ•ˆç‡é«˜ã€‚</p> <p>åå‘é”æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºä¸€ä¸ªçº¿ç¨‹åå¤è·å¾—åŒä¸€é”çš„æƒ…å†µã€‚</p> <p>åå‘é”å¯ä»¥ æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚</p> <ol><li>åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦å¤„äºæ— é”çŠ¶æ€(hashcodeã€0ã€01)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ JVM é¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§
ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•(Lock Record)çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„ Mark Word çš„æ‹·è´ï¼ˆå®˜æ–¹
æŠŠè¿™ä»½æ‹·è´åŠ äº†ä¸€ä¸ª Displaced å‰ç¼€ï¼Œå³ Displaced Mark Wordï¼‰ï¼Œå°†å¯¹è±¡çš„ Mark Word å¤åˆ¶åˆ°æ ˆ
å¸§ä¸­çš„ Lock Record ä¸­ï¼Œå°† Lock Reocrd ä¸­çš„ owner æŒ‡å‘å½“å‰å¯¹è±¡ã€‚</li> <li>JVM åˆ©ç”¨ CAS æ“ä½œå°è¯•å°†å¯¹è±¡çš„ Mark Word æ›´æ–°ä¸ºæŒ‡å‘ Lock Record çš„æŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸè¡¨ç¤ºç«äº‰åˆ°
é”ï¼Œåˆ™å°†é”æ ‡å¿—ä½å˜æˆ 00ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œã€‚</li> <li>å¦‚æœå¤±è´¥åˆ™åˆ¤æ–­å½“å‰å¯¹è±¡çš„ Mark Word æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»æŒ
æœ‰å½“å‰å¯¹è±¡çš„é”ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼›å¦åˆ™åªèƒ½è¯´æ˜è¯¥é”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ï¼Œè¿™æ—¶è½»
é‡çº§é”éœ€è¦è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—ä½å˜æˆ 10ï¼Œåé¢ç­‰å¾…çš„çº¿ç¨‹å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li></ol> <p><img src="/blog/assets/img/6-5-1.305225c6.png" alt="" loading="lazy"></p> <p><img src="/blog/assets/img/6-5-2.cbe5d6d7.png" alt="" loading="lazy"></p> <h3 id="è½»é‡çº§é”çš„é‡Šæ”¾"><a href="#è½»é‡çº§é”çš„é‡Šæ”¾" class="header-anchor">#</a> è½»é‡çº§é”çš„é‡Šæ”¾</h3> <p>è½»é‡çº§é”çš„é‡Šæ”¾ä¹Ÿæ˜¯é€šè¿‡ CAS æ“ä½œæ¥è¿›è¡Œçš„ï¼Œä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p> <blockquote><ol><li>å–å‡ºåœ¨è·å–è½»é‡çº§é”ä¿å­˜åœ¨ Displaced Mark Word ä¸­çš„æ•°æ®ã€‚</li> <li>ç”¨ CAS æ“ä½œå°†å–å‡ºçš„æ•°æ®æ›¿æ¢å½“å‰å¯¹è±¡çš„ Mark Word ä¸­ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¯´æ˜é‡Šæ”¾é”æˆåŠŸã€‚</li> <li>å¦‚æœ CAS æ“ä½œæ›¿æ¢å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥é”ï¼Œåˆ™éœ€è¦å°†è½»é‡çº§é”éœ€è¦è†¨èƒ€å‡çº§ä¸ºé‡é‡çº§
é”ã€‚</li></ol></blockquote> <p>å¯¹äºè½»é‡çº§é”ï¼Œå…¶æ€§èƒ½æå‡çš„ä¾æ®æ˜¯â€œå¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…éƒ½æ˜¯ä¸ä¼šå­˜åœ¨ç«äº‰çš„â€ï¼Œå¦‚ æœæ‰“ç ´è¿™ä¸ªä¾æ®åˆ™é™¤äº†äº’æ–¥çš„å¼€é”€å¤–ï¼Œè¿˜æœ‰é¢å¤–çš„ CAS æ“ä½œï¼Œå› æ­¤åœ¨æœ‰å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é” æ¯”é‡é‡çº§é”æ›´æ…¢ã€‚</p> <h3 id="è½»é‡çº§é”å¥½å¤„"><a href="#è½»é‡çº§é”å¥½å¤„" class="header-anchor">#</a> è½»é‡çº§é”å¥½å¤„</h3> <p>åœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>è½»é‡çº§é”çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p> <p>å°†å¯¹è±¡çš„ Mark Word å¤åˆ¶åˆ°æ ˆå¸§ä¸­çš„ Lock Recod ä¸­ã€‚Mark Word æ›´æ–°ä¸ºæŒ‡å‘ Lock Record çš„æŒ‡é’ˆã€‚</p> <p>è½»é‡çº§é”å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ</p> <p>åœ¨å¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é¿å…é‡é‡çº§é”å¼•èµ·çš„æ€§èƒ½æ¶ˆè€—ã€‚</p></div> <h2 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="header-anchor">#</a> è‡ªæ—‹é”</h2> <p>å­¦ä¹ è‡ªæ—‹é”åŸç†</p> <h3 id="è‡ªæ—‹é”åŸç†"><a href="#è‡ªæ—‹é”åŸç†" class="header-anchor">#</a> è‡ªæ—‹é”åŸç†</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Demo01</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å‰é¢æˆ‘ä»¬è®¨è®º monitor å®ç°é”çš„æ—¶å€™ï¼ŒçŸ¥é“ monitor ä¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œçº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’éœ€è¦ CPU ä» ç”¨æˆ·æ€è½¬ä¸ºæ ¸å¿ƒæ€ï¼Œé¢‘ç¹çš„é˜»å¡å’Œå”¤é†’å¯¹ CPU æ¥è¯´æ˜¯ä¸€ä»¶è´Ÿæ‹…å¾ˆé‡çš„å·¥ä½œï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚</p> <p>åŒæ—¶ï¼Œè™šæ‹Ÿæœºçš„å¼€å‘å›¢é˜Ÿä¹Ÿæ³¨æ„åˆ°åœ¨è®¸å¤šåº”ç”¨ä¸Šï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆ çŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´é˜»å¡å’Œå”¤é†’çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœç‰©ç†æœºå™¨æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å¤„ç†å™¨ï¼Œèƒ½è®©ä¸¤ä¸ª æˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶å¹¶è¡Œæ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©åé¢è¯·æ±‚é”çš„é‚£ä¸ªçº¿ç¨‹â€œç¨ç­‰ä¸€ä¸‹â€ï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œ æ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚</p> <p>ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œæˆ‘ä»¬åªéœ€è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯(è‡ª æ—‹) , è¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“çš„è‡ªæ—‹é”ã€‚</p> <p>è‡ªæ—‹é”åœ¨ JDK 1.4.2 ä¸­å°±å·²ç»å¼•å…¥ ï¼Œåªä¸è¿‡é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥ä½¿ç”¨-XX:+UseSpinning å‚æ•°æ¥å¼€å¯ï¼Œåœ¨ JDK 6 ä¸­ å°±å·²ç»æ”¹ä¸ºé»˜è®¤å¼€å¯äº†ã€‚</p> <p>è‡ªæ—‹ç­‰å¾…ä¸èƒ½ä»£æ›¿é˜»å¡ï¼Œä¸”å…ˆä¸è¯´å¯¹å¤„ç†å™¨æ•°é‡çš„è¦æ±‚ï¼Œè‡ªæ—‹ç­‰å¾…æœ¬ èº«è™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å®ƒæ˜¯è¦å ç”¨å¤„ç†å™¨æ—¶é—´çš„ï¼Œå› æ­¤ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹ç­‰ å¾…çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œåä¹‹ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆé•¿ã€‚</p> <p>é‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šç™½ç™½æ¶ˆè€—å¤„ç†å™¨èµ„æºï¼Œè€Œ ä¸ä¼šåšä»»ä½•æœ‰ç”¨çš„å·¥ä½œï¼Œåè€Œä¼šå¸¦æ¥æ€§ èƒ½ä¸Šçš„æµªè´¹ã€‚</p> <p>å› æ­¤ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœ è‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”å½“ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ã€‚</p> <p>è‡ªæ—‹æ¬¡æ•°çš„é»˜è®¤å€¼ æ˜¯ 10 æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°-XX : PreBlockSpin æ¥æ›´æ”¹ã€‚</p> <h3 id="é€‚åº”æ€§è‡ªæ—‹é”"><a href="#é€‚åº”æ€§è‡ªæ—‹é”" class="header-anchor">#</a> é€‚åº”æ€§è‡ªæ—‹é”</h3> <p>åœ¨ JDK 6 ä¸­å¼•å…¥äº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ã€‚è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Š
çš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒ
æœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒ
ç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ï¼Œæ¯”å¦‚ 100 æ¬¡å¾ªç¯ã€‚å¦å¤–ï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åè¦è·å–
è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œå’Œæ€§èƒ½ç›‘æ§
ä¿¡æ¯çš„ä¸æ–­å®Œå–„ï¼Œè™šæ‹Ÿæœºå¯¹ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œè™›æ‹Ÿæœºå°±ä¼šå˜å¾—è¶Šæ¥è¶Šâ€œèªæ˜â€äº†ã€‚</p> <h2 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="header-anchor">#</a> é”æ¶ˆé™¤</h2> <p>é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨(JIT)åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº« æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p> <p>é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åœ¨ä¸€æ®µä»£ç ä¸­ï¼Œ å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬å½“åšæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬ æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶å°±æ— é¡»è¿›è¡Œã€‚</p> <p>å˜é‡æ˜¯å¦é€ƒé€¸ï¼Œå¯¹äºè™šæ‹Ÿæœºæ¥è¯´éœ€è¦ä½¿ç”¨æ•°æ®æµåˆ†ææ¥ç¡® å®šï¼Œä½†æ˜¯ç¨‹åºå‘˜è‡ªå·±åº”è¯¥æ˜¯å¾ˆæ¸…æ¥šçš„ï¼Œæ€ä¹ˆä¼šåœ¨æ˜çŸ¥é“ä¸å­˜åœ¨æ•°æ®äº‰ç”¨çš„æƒ…å†µä¸‹è¦æ±‚åŒæ­¥å‘¢?</p> <p>å®é™…ä¸Šæœ‰ è®¸å¤šåŒæ­¥æªæ–½å¹¶ä¸æ˜¯ç¨‹åºå‘˜è‡ªå·±åŠ å…¥çš„ï¼ŒåŒæ­¥çš„ä»£ç åœ¨ Java ç¨‹åºä¸­çš„æ™®éç¨‹åº¦ä¹Ÿè®¸è¶…è¿‡äº†å¤§éƒ¨åˆ†è¯»è€…çš„ æƒ³è±¡ã€‚</p> <p>ä¸‹é¢è¿™æ®µéå¸¸ç®€å•çš„ä»£ç ä»…ä»…æ˜¯è¾“å‡º 3 ä¸ªå­—ç¬¦ä¸²ç›¸åŠ çš„ç»“æœï¼Œæ— è®ºæ˜¯æºç å­—é¢ä¸Šè¿˜æ˜¯ç¨‹åºè¯­ä¹‰ä¸Š éƒ½æ²¡æœ‰åŒæ­¥ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">contactString</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">contactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">,</span> <span class="token class-name">String</span> s2<span class="token punctuation">,</span> <span class="token class-name">String</span> s3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>StringBuffer çš„ append ( ) æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œé”å°±æ˜¯ this ä¹Ÿå°±æ˜¯(new StringBuilder())ã€‚</p> <p>è™šæ‹Ÿæœºå‘ç°å®ƒçš„ åŠ¨æ€ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨ concatString( )æ–¹æ³•å†…éƒ¨ã€‚</p> <p>ä¹Ÿå°±æ˜¯è¯´, new StringBuilder()å¯¹è±¡çš„å¼•ç”¨æ°¸è¿œä¸ä¼šâ€œé€ƒ é€¸â€åˆ° concatString ( )æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å®ƒï¼Œå› æ­¤ï¼Œè™½ç„¶è¿™é‡Œæœ‰é”ï¼Œä½†æ˜¯å¯ä»¥è¢«å®‰å…¨åœ°æ¶ˆé™¤ æ‰ï¼Œåœ¨å³æ—¶ç¼–è¯‘ä¹‹åï¼Œè¿™æ®µä»£ç å°±ä¼šå¿½ç•¥æ‰æ‰€æœ‰çš„åŒæ­¥è€Œç›´æ¥æ‰§è¡Œäº†ã€‚</p> <h2 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="header-anchor">#</a> é”ç²—åŒ–</h2> <p>å­¦ä¹ é”ç²—åŒ–çš„åŸç†</p> <p>åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæ€»æ˜¯æ¨èå°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°ï¼Œåªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œ ç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°ï¼Œå¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé‚£ç­‰å¾…é”çš„çº¿ ç¨‹ä¹Ÿèƒ½å°½å¿«æ‹¿åˆ°é”ã€‚</p> <p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„åŸåˆ™éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹ è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ï¼Œé¢‘ç¹åœ°è¿›è¡Œäº’æ–¥åŒæ­¥æ“ ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">æ€»ç»“</p> <p>ä»€ä¹ˆæ˜¯é”ç²—åŒ–ï¼Ÿ</p> <p>JVM ä¼šæ¢æµ‹åˆ°ä¸€è¿ä¸²ç»†å°çš„æ“ä½œéƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†åŒæ­¥ä»£ç å—çš„èŒƒå›´æ”¾å¤§ï¼Œæ”¾åˆ°è¿™ä¸²æ“ä½œçš„å¤–é¢ï¼Œè¿™æ ·åªéœ€è¦åŠ ä¸€æ¬¡é”å³å¯ã€‚</p></div> <h2 id="å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–"><a href="#å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹-synchronized-ä¼˜åŒ–" class="header-anchor">#</a> å¹³æ—¶å†™ä»£ç å¦‚ä½•å¯¹ synchronized ä¼˜åŒ–</h2> <h3 id="å‡å°‘-synchronized-çš„èŒƒå›´"><a href="#å‡å°‘-synchronized-çš„èŒƒå›´" class="header-anchor">#</a> å‡å°‘ synchronized çš„èŒƒå›´</h3> <p>åŒæ­¥ä»£ç å—ä¸­å°½é‡çŸ­ï¼Œå‡å°‘åŒæ­¥ä»£ç å—ä¸­ä»£ç çš„æ‰§è¡Œæ—¶é—´ï¼Œå‡å°‘é”çš„ç«äº‰ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Demo01</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="é™ä½-synchronized-é”çš„ç²’åº¦"><a href="#é™ä½-synchronized-é”çš„ç²’åº¦" class="header-anchor">#</a> é™ä½ synchronized é”çš„ç²’åº¦</h3> <p>å°†ä¸€ä¸ªé”æ‹†åˆ†ä¸ºå¤šä¸ªé”æé«˜å¹¶å‘åº¦</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Hashtable</span> hs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;xx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/blog/assets/img/6-9-1.c18ca9b0.png" alt="" loading="lazy"></p> <p><img src="/blog/assets/img/6-9-2.e13c7d00.png" alt="" loading="lazy"></p> <p><img src="/blog/assets/img/6-9-3.24c84124.png" alt="" loading="lazy"></p> <p>LinkedBlockingQueue å…¥é˜Ÿå’Œå‡ºé˜Ÿä½¿ç”¨ä¸åŒçš„é”ï¼Œç›¸å¯¹äºè¯»å†™åªæœ‰ä¸€ä¸ªé”æ•ˆç‡è¦é«˜</p> <p><img src="/blog/assets/img/6-9-4.c881c701.png" alt="" loading="lazy"></p> <h3 id="è¯»å†™åˆ†ç¦»"><a href="#è¯»å†™åˆ†ç¦»" class="header-anchor">#</a> è¯»å†™åˆ†ç¦»</h3> <p><strong>è¯»å–æ—¶ä¸åŠ é”ï¼Œå†™å…¥å’Œåˆ é™¤æ—¶åŠ é”</strong></p> <p>ConcurrentHashMapï¼ŒCopyOnWriteArrayList å’Œ ConyOnWriteSet</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://gitee.com/SHIJINGSPACE/myblog/edit/dev/docs/java/concurrent/synchronized-principle-analysis-and-optimization.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µ</a></div> <div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº:</span> <span class="info">2022å¹´4æœˆ11æ—¥ 14:31</span></div> <div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span> <span class="info"><span title="email: zhangshijing@neusoft.com" class="contributor">
          zhangshijing
        </span> , <span title="email: 945892500@qq.com" class="contributor">
          SHIJINGSPACE
        </span> , <span title="email: 945892500@qq.com" class="contributor">
          zsj
        </span> <!----></span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/java/redis/interview/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 0 1-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 0 1 9.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        redis-shuli
      </a></span> <span class="next"><a href="/blog/java/concurrent/thread-life-cycle/">
        thread-life-cycle
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 0 1-18.616.092 15.368 15.368 0 0 1-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 0 1 5.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 0 1 5.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> <!----> <div class="content__page-bottom"></div></main> <footer class="footer-wrapper"><div class="media-links-wrapper"></div> <!----> <div class="copyright"><a href="https://beian.miit.gov.cn/" target="_blank">æ™‹ICPå¤‡2021007439å·</a></div></footer></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="å…³é—­" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">è¯¥åº”ç”¨å¯ä»¥å®‰è£…åœ¨æ‚¨çš„ PC æˆ–ç§»åŠ¨è®¾å¤‡ä¸Šã€‚è¿™å°†ä½¿è¯¥ Web åº”ç”¨ç¨‹åºå¤–è§‚å’Œè¡Œä¸ºä¸å…¶ä»–åº”ç”¨ç¨‹åºç›¸åŒã€‚å®ƒå°†åœ¨å‡ºç°åœ¨åº”ç”¨ç¨‹åºåˆ—è¡¨ä¸­ï¼Œå¹¶å¯ä»¥å›ºå®šåˆ°ä¸»å±å¹•ï¼Œå¼€å§‹èœå•æˆ–ä»»åŠ¡æ ã€‚æ­¤ Web åº”ç”¨ç¨‹åºè¿˜å°†èƒ½å¤Ÿä¸å…¶ä»–åº”ç”¨ç¨‹åºå’Œæ‚¨çš„æ“ä½œç³»ç»Ÿå®‰å…¨åœ°è¿›è¡Œäº¤äº’ã€‚</p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>è¯¦æƒ…</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        å®‰è£… <span></span></button> <button class="cancel-button">
        å–æ¶ˆ
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="å…³é—­" aria-label="å…³é—­" class="pswp__button pswp__button--close"></button> <button title="åˆ†äº«" aria-label="åˆ†äº«" class="pswp__button pswp__button--share"></button> <button title="åˆ‡æ¢å…¨å±" aria-label="åˆ‡æ¢å…¨å±" class="pswp__button pswp__button--fs"></button> <button title="ç¼©æ”¾" aria-label="ç¼©æ”¾" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="ä¸Šä¸€ä¸ª (å·¦ç®­å¤´)" aria-label="ä¸Šä¸€ä¸ª (å·¦ç®­å¤´)" class="pswp__button pswp__button--arrow--left"></button> <button title="ä¸‹ä¸€ä¸ª (å³ç®­å¤´)" aria-label="ä¸‹ä¸€ä¸ª (å³ç®­å¤´)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/blog/assets/js/app.b3564ef4.js" defer></script><script src="/blog/assets/js/vendors~layout-Layout.6ebf0a5a.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.207dde08.js" defer></script><script src="/blog/assets/js/page-synchronized.6c02a55d.js" defer></script>
  </body>
</html>
